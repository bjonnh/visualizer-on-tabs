'use strict';

// HEAD version taken from http://www.lactame.com/lib/iframe-bridge/HEAD/iframe-bridge.js on 2015-11-13
// Conversion to base64 with http://decodebase64.com/
const iframeBridge = 'data:application/javascript;base64,' + 'KGZ1bmN0aW9uIHdlYnBhY2tVbml2ZXJzYWxNb2R1bGVEZWZpbml0aW9uKHJvb3QsIGZhY3RvcnkpIHsKCWlmKHR5cGVvZiBleHBvcnRzID09PSAnb2JqZWN0JyAmJiB0eXBlb2YgbW9kdWxlID09PSAnb2JqZWN0JykKCQltb2R1bGUuZXhwb3J0cyA9IGZhY3RvcnkoKTsKCWVsc2UgaWYodHlwZW9mIGRlZmluZSA9PT0gJ2Z1bmN0aW9uJyAmJiBkZWZpbmUuYW1kKQoJCWRlZmluZShbXSwgZmFjdG9yeSk7CgllbHNlIGlmKHR5cGVvZiBleHBvcnRzID09PSAnb2JqZWN0JykKCQlleHBvcnRzWyJJZnJhbWVCcmlkZ2UiXSA9IGZhY3RvcnkoKTsKCWVsc2UKCQlyb290WyJJZnJhbWVCcmlkZ2UiXSA9IGZhY3RvcnkoKTsKfSkodGhpcywgZnVuY3Rpb24oKSB7CnJldHVybiAvKioqKioqLyAoZnVuY3Rpb24obW9kdWxlcykgeyAvLyB3ZWJwYWNrQm9vdHN0cmFwCi8qKioqKiovIAkvLyBUaGUgbW9kdWxlIGNhY2hlCi8qKioqKiovIAl2YXIgaW5zdGFsbGVkTW9kdWxlcyA9IHt9OwoKLyoqKioqKi8gCS8vIFRoZSByZXF1aXJlIGZ1bmN0aW9uCi8qKioqKiovIAlmdW5jdGlvbiBfX3dlYnBhY2tfcmVxdWlyZV9fKG1vZHVsZUlkKSB7CgovKioqKioqLyAJCS8vIENoZWNrIGlmIG1vZHVsZSBpcyBpbiBjYWNoZQovKioqKioqLyAJCWlmKGluc3RhbGxlZE1vZHVsZXNbbW9kdWxlSWRdKQovKioqKioqLyAJCQlyZXR1cm4gaW5zdGFsbGVkTW9kdWxlc1ttb2R1bGVJZF0uZXhwb3J0czsKCi8qKioqKiovIAkJLy8gQ3JlYXRlIGEgbmV3IG1vZHVsZSAoYW5kIHB1dCBpdCBpbnRvIHRoZSBjYWNoZSkKLyoqKioqKi8gCQl2YXIgbW9kdWxlID0gaW5zdGFsbGVkTW9kdWxlc1ttb2R1bGVJZF0gPSB7Ci8qKioqKiovIAkJCWV4cG9ydHM6IHt9LAovKioqKioqLyAJCQlpZDogbW9kdWxlSWQsCi8qKioqKiovIAkJCWxvYWRlZDogZmFsc2UKLyoqKioqKi8gCQl9OwoKLyoqKioqKi8gCQkvLyBFeGVjdXRlIHRoZSBtb2R1bGUgZnVuY3Rpb24KLyoqKioqKi8gCQltb2R1bGVzW21vZHVsZUlkXS5jYWxsKG1vZHVsZS5leHBvcnRzLCBtb2R1bGUsIG1vZHVsZS5leHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKTsKCi8qKioqKiovIAkJLy8gRmxhZyB0aGUgbW9kdWxlIGFzIGxvYWRlZAovKioqKioqLyAJCW1vZHVsZS5sb2FkZWQgPSB0cnVlOwoKLyoqKioqKi8gCQkvLyBSZXR1cm4gdGhlIGV4cG9ydHMgb2YgdGhlIG1vZHVsZQovKioqKioqLyAJCXJldHVybiBtb2R1bGUuZXhwb3J0czsKLyoqKioqKi8gCX0KCgovKioqKioqLyAJLy8gZXhwb3NlIHRoZSBtb2R1bGVzIG9iamVjdCAoX193ZWJwYWNrX21vZHVsZXNfXykKLyoqKioqKi8gCV9fd2VicGFja19yZXF1aXJlX18ubSA9IG1vZHVsZXM7CgovKioqKioqLyAJLy8gZXhwb3NlIHRoZSBtb2R1bGUgY2FjaGUKLyoqKioqKi8gCV9fd2VicGFja19yZXF1aXJlX18uYyA9IGluc3RhbGxlZE1vZHVsZXM7CgovKioqKioqLyAJLy8gX193ZWJwYWNrX3B1YmxpY19wYXRoX18KLyoqKioqKi8gCV9fd2VicGFja19yZXF1aXJlX18ucCA9ICIiOwoKLyoqKioqKi8gCS8vIExvYWQgZW50cnkgbW9kdWxlIGFuZCByZXR1cm4gZXhwb3J0cwovKioqKioqLyAJcmV0dXJuIF9fd2VicGFja19yZXF1aXJlX18oMCk7Ci8qKioqKiovIH0pCi8qKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKiovCi8qKioqKiovIChbCi8qIDAgKi8KLyoqKi8gZnVuY3Rpb24obW9kdWxlLCBleHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKSB7CgoJJ3VzZSBzdHJpY3QnOwoKCXZhciBEZWJ1ZyA9IF9fd2VicGFja19yZXF1aXJlX18oMSk7Cgl3aW5kb3cuRGVidWcgPSBEZWJ1ZzsKCgl2YXIgZGVidWcgPSBEZWJ1ZygnaWZyYW1lLWJyaWRnZTppZnJhbWUnKTsKCXZhciBNZXNzYWdlSGFuZGxlciA9IF9fd2VicGFja19yZXF1aXJlX18oNCk7CgoJdmFyIG1lc3NhZ2VIYW5kbGVyID0gbmV3IE1lc3NhZ2VIYW5kbGVyKCk7CgoJbWVzc2FnZUhhbmRsZXIuaW5pdCh3aW5kb3cucGFyZW50KTsKCXdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdtZXNzYWdlJywgZnVuY3Rpb24gKGV2ZW50KSB7CgkgICAgdmFyIGRhdGEgPSBldmVudC5kYXRhOwoJICAgIGRlYnVnKCdtZXNzYWdlIHJlY2VpdmVkJywgZGF0YSk7CgkgICAgbWVzc2FnZUhhbmRsZXIuaGFuZGxlTWVzc2FnZShkYXRhKTsKCX0pOwoKCWV4cG9ydHMucG9zdE1lc3NhZ2UgPSBmdW5jdGlvbiAodHlwZSwgbWVzc2FnZSkgewoJICAgIHJldHVybiBtZXNzYWdlSGFuZGxlci5wb3N0TWVzc2FnZSh0eXBlLCBtZXNzYWdlKTsKCX07CgoJZXhwb3J0cy5vbk1lc3NhZ2UgPSBmdW5jdGlvbiAoY2IpIHsKCSAgICBtZXNzYWdlSGFuZGxlci5vbignbWVzc2FnZScsIGNiKTsKCX07CgoJZXhwb3J0cy5yZWFkeSA9IGZ1bmN0aW9uICgpIHsKCSAgICBtZXNzYWdlSGFuZGxlci5oYW5kbGVQZW5kaW5nTWVzc2FnZXMoKTsKCX07CgovKioqLyB9LAovKiAxICovCi8qKiovIGZ1bmN0aW9uKG1vZHVsZSwgZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXykgewoKCQoJLyoqCgkgKiBUaGlzIGlzIHRoZSB3ZWIgYnJvd3NlciBpbXBsZW1lbnRhdGlvbiBvZiBgZGVidWcoKWAuCgkgKgoJICogRXhwb3NlIGBkZWJ1ZygpYCBhcyB0aGUgbW9kdWxlLgoJICovCgoJZXhwb3J0cyA9IG1vZHVsZS5leHBvcnRzID0gX193ZWJwYWNrX3JlcXVpcmVfXygyKTsKCWV4cG9ydHMubG9nID0gbG9nOwoJZXhwb3J0cy5mb3JtYXRBcmdzID0gZm9ybWF0QXJnczsKCWV4cG9ydHMuc2F2ZSA9IHNhdmU7CglleHBvcnRzLmxvYWQgPSBsb2FkOwoJZXhwb3J0cy51c2VDb2xvcnMgPSB1c2VDb2xvcnM7CglleHBvcnRzLnN0b3JhZ2UgPSAndW5kZWZpbmVkJyAhPSB0eXBlb2YgY2hyb21lCgkgICAgICAgICAgICAgICAmJiAndW5kZWZpbmVkJyAhPSB0eXBlb2YgY2hyb21lLnN0b3JhZ2UKCSAgICAgICAgICAgICAgICAgID8gY2hyb21lLnN0b3JhZ2UubG9jYWwKCSAgICAgICAgICAgICAgICAgIDogbG9jYWxzdG9yYWdlKCk7CgoJLyoqCgkgKiBDb2xvcnMuCgkgKi8KCglleHBvcnRzLmNvbG9ycyA9IFsKCSAgJ2xpZ2h0c2VhZ3JlZW4nLAoJICAnZm9yZXN0Z3JlZW4nLAoJICAnZ29sZGVucm9kJywKCSAgJ2RvZGdlcmJsdWUnLAoJICAnZGFya29yY2hpZCcsCgkgICdjcmltc29uJwoJXTsKCgkvKioKCSAqIEN1cnJlbnRseSBvbmx5IFdlYktpdC1iYXNlZCBXZWIgSW5zcGVjdG9ycywgRmlyZWZveCA+PSB2MzEsCgkgKiBhbmQgdGhlIEZpcmVidWcgZXh0ZW5zaW9uIChhbnkgRmlyZWZveCB2ZXJzaW9uKSBhcmUga25vd24KCSAqIHRvIHN1cHBvcnQgIiVjIiBDU1MgY3VzdG9taXphdGlvbnMuCgkgKgoJICogVE9ETzogYWRkIGEgYGxvY2FsU3RvcmFnZWAgdmFyaWFibGUgdG8gZXhwbGljaXRseSBlbmFibGUvZGlzYWJsZSBjb2xvcnMKCSAqLwoKCWZ1bmN0aW9uIHVzZUNvbG9ycygpIHsKCSAgLy8gaXMgd2Via2l0PyBodHRwOi8vc3RhY2tvdmVyZmxvdy5jb20vYS8xNjQ1OTYwNi8zNzY3NzMKCSAgcmV0dXJuICgnV2Via2l0QXBwZWFyYW5jZScgaW4gZG9jdW1lbnQuZG9jdW1lbnRFbGVtZW50LnN0eWxlKSB8fAoJICAgIC8vIGlzIGZpcmVidWc/IGh0dHA6Ly9zdGFja292ZXJmbG93LmNvbS9hLzM5ODEyMC8zNzY3NzMKCSAgICAod2luZG93LmNvbnNvbGUgJiYgKGNvbnNvbGUuZmlyZWJ1ZyB8fCAoY29uc29sZS5leGNlcHRpb24gJiYgY29uc29sZS50YWJsZSkpKSB8fAoJICAgIC8vIGlzIGZpcmVmb3ggPj0gdjMxPwoJICAgIC8vIGh0dHBzOi8vZGV2ZWxvcGVyLm1vemlsbGEub3JnL2VuLVVTL2RvY3MvVG9vbHMvV2ViX0NvbnNvbGUjU3R5bGluZ19tZXNzYWdlcwoJICAgIChuYXZpZ2F0b3IudXNlckFnZW50LnRvTG93ZXJDYXNlKCkubWF0Y2goL2ZpcmVmb3hcLyhcZCspLykgJiYgcGFyc2VJbnQoUmVnRXhwLiQxLCAxMCkgPj0gMzEpOwoJfQoKCS8qKgoJICogTWFwICVqIHRvIGBKU09OLnN0cmluZ2lmeSgpYCwgc2luY2Ugbm8gV2ViIEluc3BlY3RvcnMgZG8gdGhhdCBieSBkZWZhdWx0LgoJICovCgoJZXhwb3J0cy5mb3JtYXR0ZXJzLmogPSBmdW5jdGlvbih2KSB7CgkgIHJldHVybiBKU09OLnN0cmluZ2lmeSh2KTsKCX07CgoKCS8qKgoJICogQ29sb3JpemUgbG9nIGFyZ3VtZW50cyBpZiBlbmFibGVkLgoJICoKCSAqIEBhcGkgcHVibGljCgkgKi8KCglmdW5jdGlvbiBmb3JtYXRBcmdzKCkgewoJICB2YXIgYXJncyA9IGFyZ3VtZW50czsKCSAgdmFyIHVzZUNvbG9ycyA9IHRoaXMudXNlQ29sb3JzOwoKCSAgYXJnc1swXSA9ICh1c2VDb2xvcnMgPyAnJWMnIDogJycpCgkgICAgKyB0aGlzLm5hbWVzcGFjZQoJICAgICsgKHVzZUNvbG9ycyA/ICcgJWMnIDogJyAnKQoJICAgICsgYXJnc1swXQoJICAgICsgKHVzZUNvbG9ycyA/ICclYyAnIDogJyAnKQoJICAgICsgJysnICsgZXhwb3J0cy5odW1hbml6ZSh0aGlzLmRpZmYpOwoKCSAgaWYgKCF1c2VDb2xvcnMpIHJldHVybiBhcmdzOwoKCSAgdmFyIGMgPSAnY29sb3I6ICcgKyB0aGlzLmNvbG9yOwoJICBhcmdzID0gW2FyZ3NbMF0sIGMsICdjb2xvcjogaW5oZXJpdCddLmNvbmNhdChBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmdzLCAxKSk7CgoJICAvLyB0aGUgZmluYWwgIiVjIiBpcyBzb21ld2hhdCB0cmlja3ksIGJlY2F1c2UgdGhlcmUgY291bGQgYmUgb3RoZXIKCSAgLy8gYXJndW1lbnRzIHBhc3NlZCBlaXRoZXIgYmVmb3JlIG9yIGFmdGVyIHRoZSAlYywgc28gd2UgbmVlZCB0bwoJICAvLyBmaWd1cmUgb3V0IHRoZSBjb3JyZWN0IGluZGV4IHRvIGluc2VydCB0aGUgQ1NTIGludG8KCSAgdmFyIGluZGV4ID0gMDsKCSAgdmFyIGxhc3RDID0gMDsKCSAgYXJnc1swXS5yZXBsYWNlKC8lW2EteiVdL2csIGZ1bmN0aW9uKG1hdGNoKSB7CgkgICAgaWYgKCclJScgPT09IG1hdGNoKSByZXR1cm47CgkgICAgaW5kZXgrKzsKCSAgICBpZiAoJyVjJyA9PT0gbWF0Y2gpIHsKCSAgICAgIC8vIHdlIG9ubHkgYXJlIGludGVyZXN0ZWQgaW4gdGhlICpsYXN0KiAlYwoJICAgICAgLy8gKHRoZSB1c2VyIG1heSBoYXZlIHByb3ZpZGVkIHRoZWlyIG93bikKCSAgICAgIGxhc3RDID0gaW5kZXg7CgkgICAgfQoJICB9KTsKCgkgIGFyZ3Muc3BsaWNlKGxhc3RDLCAwLCBjKTsKCSAgcmV0dXJuIGFyZ3M7Cgl9CgoJLyoqCgkgKiBJbnZva2VzIGBjb25zb2xlLmxvZygpYCB3aGVuIGF2YWlsYWJsZS4KCSAqIE5vLW9wIHdoZW4gYGNvbnNvbGUubG9nYCBpcyBub3QgYSAiZnVuY3Rpb24iLgoJICoKCSAqIEBhcGkgcHVibGljCgkgKi8KCglmdW5jdGlvbiBsb2coKSB7CgkgIC8vIHRoaXMgaGFja2VyeSBpcyByZXF1aXJlZCBmb3IgSUU4LzksIHdoZXJlCgkgIC8vIHRoZSBgY29uc29sZS5sb2dgIGZ1bmN0aW9uIGRvZXNuJ3QgaGF2ZSAnYXBwbHknCgkgIHJldHVybiAnb2JqZWN0JyA9PT0gdHlwZW9mIGNvbnNvbGUKCSAgICAmJiBjb25zb2xlLmxvZwoJICAgICYmIEZ1bmN0aW9uLnByb3RvdHlwZS5hcHBseS5jYWxsKGNvbnNvbGUubG9nLCBjb25zb2xlLCBhcmd1bWVudHMpOwoJfQoKCS8qKgoJICogU2F2ZSBgbmFtZXNwYWNlc2AuCgkgKgoJICogQHBhcmFtIHtTdHJpbmd9IG5hbWVzcGFjZXMKCSAqIEBhcGkgcHJpdmF0ZQoJICovCgoJZnVuY3Rpb24gc2F2ZShuYW1lc3BhY2VzKSB7CgkgIHRyeSB7CgkgICAgaWYgKG51bGwgPT0gbmFtZXNwYWNlcykgewoJICAgICAgZXhwb3J0cy5zdG9yYWdlLnJlbW92ZUl0ZW0oJ2RlYnVnJyk7CgkgICAgfSBlbHNlIHsKCSAgICAgIGV4cG9ydHMuc3RvcmFnZS5kZWJ1ZyA9IG5hbWVzcGFjZXM7CgkgICAgfQoJICB9IGNhdGNoKGUpIHt9Cgl9CgoJLyoqCgkgKiBMb2FkIGBuYW1lc3BhY2VzYC4KCSAqCgkgKiBAcmV0dXJuIHtTdHJpbmd9IHJldHVybnMgdGhlIHByZXZpb3VzbHkgcGVyc2lzdGVkIGRlYnVnIG1vZGVzCgkgKiBAYXBpIHByaXZhdGUKCSAqLwoKCWZ1bmN0aW9uIGxvYWQoKSB7CgkgIHZhciByOwoJICB0cnkgewoJICAgIHIgPSBleHBvcnRzLnN0b3JhZ2UuZGVidWc7CgkgIH0gY2F0Y2goZSkge30KCSAgcmV0dXJuIHI7Cgl9CgoJLyoqCgkgKiBFbmFibGUgbmFtZXNwYWNlcyBsaXN0ZWQgaW4gYGxvY2FsU3RvcmFnZS5kZWJ1Z2AgaW5pdGlhbGx5LgoJICovCgoJZXhwb3J0cy5lbmFibGUobG9hZCgpKTsKCgkvKioKCSAqIExvY2Fsc3RvcmFnZSBhdHRlbXB0cyB0byByZXR1cm4gdGhlIGxvY2Fsc3RvcmFnZS4KCSAqCgkgKiBUaGlzIGlzIG5lY2Vzc2FyeSBiZWNhdXNlIHNhZmFyaSB0aHJvd3MKCSAqIHdoZW4gYSB1c2VyIGRpc2FibGVzIGNvb2tpZXMvbG9jYWxzdG9yYWdlCgkgKiBhbmQgeW91IGF0dGVtcHQgdG8gYWNjZXNzIGl0LgoJICoKCSAqIEByZXR1cm4ge0xvY2FsU3RvcmFnZX0KCSAqIEBhcGkgcHJpdmF0ZQoJICovCgoJZnVuY3Rpb24gbG9jYWxzdG9yYWdlKCl7CgkgIHRyeSB7CgkgICAgcmV0dXJuIHdpbmRvdy5sb2NhbFN0b3JhZ2U7CgkgIH0gY2F0Y2ggKGUpIHt9Cgl9CgoKLyoqKi8gfSwKLyogMiAqLwovKioqLyBmdW5jdGlvbihtb2R1bGUsIGV4cG9ydHMsIF9fd2VicGFja19yZXF1aXJlX18pIHsKCgkKCS8qKgoJICogVGhpcyBpcyB0aGUgY29tbW9uIGxvZ2ljIGZvciBib3RoIHRoZSBOb2RlLmpzIGFuZCB3ZWIgYnJvd3NlcgoJICogaW1wbGVtZW50YXRpb25zIG9mIGBkZWJ1ZygpYC4KCSAqCgkgKiBFeHBvc2UgYGRlYnVnKClgIGFzIHRoZSBtb2R1bGUuCgkgKi8KCglleHBvcnRzID0gbW9kdWxlLmV4cG9ydHMgPSBkZWJ1ZzsKCWV4cG9ydHMuY29lcmNlID0gY29lcmNlOwoJZXhwb3J0cy5kaXNhYmxlID0gZGlzYWJsZTsKCWV4cG9ydHMuZW5hYmxlID0gZW5hYmxlOwoJZXhwb3J0cy5lbmFibGVkID0gZW5hYmxlZDsKCWV4cG9ydHMuaHVtYW5pemUgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDMpOwoKCS8qKgoJICogVGhlIGN1cnJlbnRseSBhY3RpdmUgZGVidWcgbW9kZSBuYW1lcywgYW5kIG5hbWVzIHRvIHNraXAuCgkgKi8KCglleHBvcnRzLm5hbWVzID0gW107CglleHBvcnRzLnNraXBzID0gW107CgoJLyoqCgkgKiBNYXAgb2Ygc3BlY2lhbCAiJW4iIGhhbmRsaW5nIGZ1bmN0aW9ucywgZm9yIHRoZSBkZWJ1ZyAiZm9ybWF0IiBhcmd1bWVudC4KCSAqCgkgKiBWYWxpZCBrZXkgbmFtZXMgYXJlIGEgc2luZ2xlLCBsb3dlcmNhc2VkIGxldHRlciwgaS5lLiAibiIuCgkgKi8KCglleHBvcnRzLmZvcm1hdHRlcnMgPSB7fTsKCgkvKioKCSAqIFByZXZpb3VzbHkgYXNzaWduZWQgY29sb3IuCgkgKi8KCgl2YXIgcHJldkNvbG9yID0gMDsKCgkvKioKCSAqIFByZXZpb3VzIGxvZyB0aW1lc3RhbXAuCgkgKi8KCgl2YXIgcHJldlRpbWU7CgoJLyoqCgkgKiBTZWxlY3QgYSBjb2xvci4KCSAqCgkgKiBAcmV0dXJuIHtOdW1iZXJ9CgkgKiBAYXBpIHByaXZhdGUKCSAqLwoKCWZ1bmN0aW9uIHNlbGVjdENvbG9yKCkgewoJICByZXR1cm4gZXhwb3J0cy5jb2xvcnNbcHJldkNvbG9yKysgJSBleHBvcnRzLmNvbG9ycy5sZW5ndGhdOwoJfQoKCS8qKgoJICogQ3JlYXRlIGEgZGVidWdnZXIgd2l0aCB0aGUgZ2l2ZW4gYG5hbWVzcGFjZWAuCgkgKgoJICogQHBhcmFtIHtTdHJpbmd9IG5hbWVzcGFjZQoJICogQHJldHVybiB7RnVuY3Rpb259CgkgKiBAYXBpIHB1YmxpYwoJICovCgoJZnVuY3Rpb24gZGVidWcobmFtZXNwYWNlKSB7CgoJICAvLyBkZWZpbmUgdGhlIGBkaXNhYmxlZGAgdmVyc2lvbgoJICBmdW5jdGlvbiBkaXNhYmxlZCgpIHsKCSAgfQoJICBkaXNhYmxlZC5lbmFibGVkID0gZmFsc2U7CgoJICAvLyBkZWZpbmUgdGhlIGBlbmFibGVkYCB2ZXJzaW9uCgkgIGZ1bmN0aW9uIGVuYWJsZWQoKSB7CgoJICAgIHZhciBzZWxmID0gZW5hYmxlZDsKCgkgICAgLy8gc2V0IGBkaWZmYCB0aW1lc3RhbXAKCSAgICB2YXIgY3VyciA9ICtuZXcgRGF0ZSgpOwoJICAgIHZhciBtcyA9IGN1cnIgLSAocHJldlRpbWUgfHwgY3Vycik7CgkgICAgc2VsZi5kaWZmID0gbXM7CgkgICAgc2VsZi5wcmV2ID0gcHJldlRpbWU7CgkgICAgc2VsZi5jdXJyID0gY3VycjsKCSAgICBwcmV2VGltZSA9IGN1cnI7CgoJICAgIC8vIGFkZCB0aGUgYGNvbG9yYCBpZiBub3Qgc2V0CgkgICAgaWYgKG51bGwgPT0gc2VsZi51c2VDb2xvcnMpIHNlbGYudXNlQ29sb3JzID0gZXhwb3J0cy51c2VDb2xvcnMoKTsKCSAgICBpZiAobnVsbCA9PSBzZWxmLmNvbG9yICYmIHNlbGYudXNlQ29sb3JzKSBzZWxmLmNvbG9yID0gc2VsZWN0Q29sb3IoKTsKCgkgICAgdmFyIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMpOwoKCSAgICBhcmdzWzBdID0gZXhwb3J0cy5jb2VyY2UoYXJnc1swXSk7CgoJICAgIGlmICgnc3RyaW5nJyAhPT0gdHlwZW9mIGFyZ3NbMF0pIHsKCSAgICAgIC8vIGFueXRoaW5nIGVsc2UgbGV0J3MgaW5zcGVjdCB3aXRoICVvCgkgICAgICBhcmdzID0gWyclbyddLmNvbmNhdChhcmdzKTsKCSAgICB9CgoJICAgIC8vIGFwcGx5IGFueSBgZm9ybWF0dGVyc2AgdHJhbnNmb3JtYXRpb25zCgkgICAgdmFyIGluZGV4ID0gMDsKCSAgICBhcmdzWzBdID0gYXJnc1swXS5yZXBsYWNlKC8lKFthLXolXSkvZywgZnVuY3Rpb24obWF0Y2gsIGZvcm1hdCkgewoJICAgICAgLy8gaWYgd2UgZW5jb3VudGVyIGFuIGVzY2FwZWQgJSB0aGVuIGRvbid0IGluY3JlYXNlIHRoZSBhcnJheSBpbmRleAoJICAgICAgaWYgKG1hdGNoID09PSAnJSUnKSByZXR1cm4gbWF0Y2g7CgkgICAgICBpbmRleCsrOwoJICAgICAgdmFyIGZvcm1hdHRlciA9IGV4cG9ydHMuZm9ybWF0dGVyc1tmb3JtYXRdOwoJICAgICAgaWYgKCdmdW5jdGlvbicgPT09IHR5cGVvZiBmb3JtYXR0ZXIpIHsKCSAgICAgICAgdmFyIHZhbCA9IGFyZ3NbaW5kZXhdOwoJICAgICAgICBtYXRjaCA9IGZvcm1hdHRlci5jYWxsKHNlbGYsIHZhbCk7CgoJICAgICAgICAvLyBub3cgd2UgbmVlZCB0byByZW1vdmUgYGFyZ3NbaW5kZXhdYCBzaW5jZSBpdCdzIGlubGluZWQgaW4gdGhlIGBmb3JtYXRgCgkgICAgICAgIGFyZ3Muc3BsaWNlKGluZGV4LCAxKTsKCSAgICAgICAgaW5kZXgtLTsKCSAgICAgIH0KCSAgICAgIHJldHVybiBtYXRjaDsKCSAgICB9KTsKCgkgICAgaWYgKCdmdW5jdGlvbicgPT09IHR5cGVvZiBleHBvcnRzLmZvcm1hdEFyZ3MpIHsKCSAgICAgIGFyZ3MgPSBleHBvcnRzLmZvcm1hdEFyZ3MuYXBwbHkoc2VsZiwgYXJncyk7CgkgICAgfQoJICAgIHZhciBsb2dGbiA9IGVuYWJsZWQubG9nIHx8IGV4cG9ydHMubG9nIHx8IGNvbnNvbGUubG9nLmJpbmQoY29uc29sZSk7CgkgICAgbG9nRm4uYXBwbHkoc2VsZiwgYXJncyk7CgkgIH0KCSAgZW5hYmxlZC5lbmFibGVkID0gdHJ1ZTsKCgkgIHZhciBmbiA9IGV4cG9ydHMuZW5hYmxlZChuYW1lc3BhY2UpID8gZW5hYmxlZCA6IGRpc2FibGVkOwoKCSAgZm4ubmFtZXNwYWNlID0gbmFtZXNwYWNlOwoKCSAgcmV0dXJuIGZuOwoJfQoKCS8qKgoJICogRW5hYmxlcyBhIGRlYnVnIG1vZGUgYnkgbmFtZXNwYWNlcy4gVGhpcyBjYW4gaW5jbHVkZSBtb2RlcwoJICogc2VwYXJhdGVkIGJ5IGEgY29sb24gYW5kIHdpbGRjYXJkcy4KCSAqCgkgKiBAcGFyYW0ge1N0cmluZ30gbmFtZXNwYWNlcwoJICogQGFwaSBwdWJsaWMKCSAqLwoKCWZ1bmN0aW9uIGVuYWJsZShuYW1lc3BhY2VzKSB7CgkgIGV4cG9ydHMuc2F2ZShuYW1lc3BhY2VzKTsKCgkgIHZhciBzcGxpdCA9IChuYW1lc3BhY2VzIHx8ICcnKS5zcGxpdCgvW1xzLF0rLyk7CgkgIHZhciBsZW4gPSBzcGxpdC5sZW5ndGg7CgoJICBmb3IgKHZhciBpID0gMDsgaSA8IGxlbjsgaSsrKSB7CgkgICAgaWYgKCFzcGxpdFtpXSkgY29udGludWU7IC8vIGlnbm9yZSBlbXB0eSBzdHJpbmdzCgkgICAgbmFtZXNwYWNlcyA9IHNwbGl0W2ldLnJlcGxhY2UoL1wqL2csICcuKj8nKTsKCSAgICBpZiAobmFtZXNwYWNlc1swXSA9PT0gJy0nKSB7CgkgICAgICBleHBvcnRzLnNraXBzLnB1c2gobmV3IFJlZ0V4cCgnXicgKyBuYW1lc3BhY2VzLnN1YnN0cigxKSArICckJykpOwoJICAgIH0gZWxzZSB7CgkgICAgICBleHBvcnRzLm5hbWVzLnB1c2gobmV3IFJlZ0V4cCgnXicgKyBuYW1lc3BhY2VzICsgJyQnKSk7CgkgICAgfQoJICB9Cgl9CgoJLyoqCgkgKiBEaXNhYmxlIGRlYnVnIG91dHB1dC4KCSAqCgkgKiBAYXBpIHB1YmxpYwoJICovCgoJZnVuY3Rpb24gZGlzYWJsZSgpIHsKCSAgZXhwb3J0cy5lbmFibGUoJycpOwoJfQoKCS8qKgoJICogUmV0dXJucyB0cnVlIGlmIHRoZSBnaXZlbiBtb2RlIG5hbWUgaXMgZW5hYmxlZCwgZmFsc2Ugb3RoZXJ3aXNlLgoJICoKCSAqIEBwYXJhbSB7U3RyaW5nfSBuYW1lCgkgKiBAcmV0dXJuIHtCb29sZWFufQoJICogQGFwaSBwdWJsaWMKCSAqLwoKCWZ1bmN0aW9uIGVuYWJsZWQobmFtZSkgewoJICB2YXIgaSwgbGVuOwoJICBmb3IgKGkgPSAwLCBsZW4gPSBleHBvcnRzLnNraXBzLmxlbmd0aDsgaSA8IGxlbjsgaSsrKSB7CgkgICAgaWYgKGV4cG9ydHMuc2tpcHNbaV0udGVzdChuYW1lKSkgewoJICAgICAgcmV0dXJuIGZhbHNlOwoJICAgIH0KCSAgfQoJICBmb3IgKGkgPSAwLCBsZW4gPSBleHBvcnRzLm5hbWVzLmxlbmd0aDsgaSA8IGxlbjsgaSsrKSB7CgkgICAgaWYgKGV4cG9ydHMubmFtZXNbaV0udGVzdChuYW1lKSkgewoJICAgICAgcmV0dXJuIHRydWU7CgkgICAgfQoJICB9CgkgIHJldHVybiBmYWxzZTsKCX0KCgkvKioKCSAqIENvZXJjZSBgdmFsYC4KCSAqCgkgKiBAcGFyYW0ge01peGVkfSB2YWwKCSAqIEByZXR1cm4ge01peGVkfQoJICogQGFwaSBwcml2YXRlCgkgKi8KCglmdW5jdGlvbiBjb2VyY2UodmFsKSB7CgkgIGlmICh2YWwgaW5zdGFuY2VvZiBFcnJvcikgcmV0dXJuIHZhbC5zdGFjayB8fCB2YWwubWVzc2FnZTsKCSAgcmV0dXJuIHZhbDsKCX0KCgovKioqLyB9LAovKiAzICovCi8qKiovIGZ1bmN0aW9uKG1vZHVsZSwgZXhwb3J0cykgewoKCS8qKgoJICogSGVscGVycy4KCSAqLwoKCXZhciBzID0gMTAwMDsKCXZhciBtID0gcyAqIDYwOwoJdmFyIGggPSBtICogNjA7Cgl2YXIgZCA9IGggKiAyNDsKCXZhciB5ID0gZCAqIDM2NS4yNTsKCgkvKioKCSAqIFBhcnNlIG9yIGZvcm1hdCB0aGUgZ2l2ZW4gYHZhbGAuCgkgKgoJICogT3B0aW9uczoKCSAqCgkgKiAgLSBgbG9uZ2AgdmVyYm9zZSBmb3JtYXR0aW5nIFtmYWxzZV0KCSAqCgkgKiBAcGFyYW0ge1N0cmluZ3xOdW1iZXJ9IHZhbAoJICogQHBhcmFtIHtPYmplY3R9IG9wdGlvbnMKCSAqIEByZXR1cm4ge1N0cmluZ3xOdW1iZXJ9CgkgKiBAYXBpIHB1YmxpYwoJICovCgoJbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbih2YWwsIG9wdGlvbnMpewoJICBvcHRpb25zID0gb3B0aW9ucyB8fCB7fTsKCSAgaWYgKCdzdHJpbmcnID09IHR5cGVvZiB2YWwpIHJldHVybiBwYXJzZSh2YWwpOwoJICByZXR1cm4gb3B0aW9ucy5sb25nCgkgICAgPyBsb25nKHZhbCkKCSAgICA6IHNob3J0KHZhbCk7Cgl9OwoKCS8qKgoJICogUGFyc2UgdGhlIGdpdmVuIGBzdHJgIGFuZCByZXR1cm4gbWlsbGlzZWNvbmRzLgoJICoKCSAqIEBwYXJhbSB7U3RyaW5nfSBzdHIKCSAqIEByZXR1cm4ge051bWJlcn0KCSAqIEBhcGkgcHJpdmF0ZQoJICovCgoJZnVuY3Rpb24gcGFyc2Uoc3RyKSB7CgkgIHN0ciA9ICcnICsgc3RyOwoJICBpZiAoc3RyLmxlbmd0aCA+IDEwMDAwKSByZXR1cm47CgkgIHZhciBtYXRjaCA9IC9eKCg/OlxkKyk/XC4/XGQrKSAqKG1pbGxpc2Vjb25kcz98bXNlY3M/fG1zfHNlY29uZHM/fHNlY3M/fHN8bWludXRlcz98bWlucz98bXxob3Vycz98aHJzP3xofGRheXM/fGR8eWVhcnM/fHlycz98eSk/JC9pLmV4ZWMoc3RyKTsKCSAgaWYgKCFtYXRjaCkgcmV0dXJuOwoJICB2YXIgbiA9IHBhcnNlRmxvYXQobWF0Y2hbMV0pOwoJICB2YXIgdHlwZSA9IChtYXRjaFsyXSB8fCAnbXMnKS50b0xvd2VyQ2FzZSgpOwoJICBzd2l0Y2ggKHR5cGUpIHsKCSAgICBjYXNlICd5ZWFycyc6CgkgICAgY2FzZSAneWVhcic6CgkgICAgY2FzZSAneXJzJzoKCSAgICBjYXNlICd5cic6CgkgICAgY2FzZSAneSc6CgkgICAgICByZXR1cm4gbiAqIHk7CgkgICAgY2FzZSAnZGF5cyc6CgkgICAgY2FzZSAnZGF5JzoKCSAgICBjYXNlICdkJzoKCSAgICAgIHJldHVybiBuICogZDsKCSAgICBjYXNlICdob3Vycyc6CgkgICAgY2FzZSAnaG91cic6CgkgICAgY2FzZSAnaHJzJzoKCSAgICBjYXNlICdocic6CgkgICAgY2FzZSAnaCc6CgkgICAgICByZXR1cm4gbiAqIGg7CgkgICAgY2FzZSAnbWludXRlcyc6CgkgICAgY2FzZSAnbWludXRlJzoKCSAgICBjYXNlICdtaW5zJzoKCSAgICBjYXNlICdtaW4nOgoJICAgIGNhc2UgJ20nOgoJICAgICAgcmV0dXJuIG4gKiBtOwoJICAgIGNhc2UgJ3NlY29uZHMnOgoJICAgIGNhc2UgJ3NlY29uZCc6CgkgICAgY2FzZSAnc2Vjcyc6CgkgICAgY2FzZSAnc2VjJzoKCSAgICBjYXNlICdzJzoKCSAgICAgIHJldHVybiBuICogczsKCSAgICBjYXNlICdtaWxsaXNlY29uZHMnOgoJICAgIGNhc2UgJ21pbGxpc2Vjb25kJzoKCSAgICBjYXNlICdtc2Vjcyc6CgkgICAgY2FzZSAnbXNlYyc6CgkgICAgY2FzZSAnbXMnOgoJICAgICAgcmV0dXJuIG47CgkgIH0KCX0KCgkvKioKCSAqIFNob3J0IGZvcm1hdCBmb3IgYG1zYC4KCSAqCgkgKiBAcGFyYW0ge051bWJlcn0gbXMKCSAqIEByZXR1cm4ge1N0cmluZ30KCSAqIEBhcGkgcHJpdmF0ZQoJICovCgoJZnVuY3Rpb24gc2hvcnQobXMpIHsKCSAgaWYgKG1zID49IGQpIHJldHVybiBNYXRoLnJvdW5kKG1zIC8gZCkgKyAnZCc7CgkgIGlmIChtcyA+PSBoKSByZXR1cm4gTWF0aC5yb3VuZChtcyAvIGgpICsgJ2gnOwoJICBpZiAobXMgPj0gbSkgcmV0dXJuIE1hdGgucm91bmQobXMgLyBtKSArICdtJzsKCSAgaWYgKG1zID49IHMpIHJldHVybiBNYXRoLnJvdW5kKG1zIC8gcykgKyAncyc7CgkgIHJldHVybiBtcyArICdtcyc7Cgl9CgoJLyoqCgkgKiBMb25nIGZvcm1hdCBmb3IgYG1zYC4KCSAqCgkgKiBAcGFyYW0ge051bWJlcn0gbXMKCSAqIEByZXR1cm4ge1N0cmluZ30KCSAqIEBhcGkgcHJpdmF0ZQoJICovCgoJZnVuY3Rpb24gbG9uZyhtcykgewoJICByZXR1cm4gcGx1cmFsKG1zLCBkLCAnZGF5JykKCSAgICB8fCBwbHVyYWwobXMsIGgsICdob3VyJykKCSAgICB8fCBwbHVyYWwobXMsIG0sICdtaW51dGUnKQoJICAgIHx8IHBsdXJhbChtcywgcywgJ3NlY29uZCcpCgkgICAgfHwgbXMgKyAnIG1zJzsKCX0KCgkvKioKCSAqIFBsdXJhbGl6YXRpb24gaGVscGVyLgoJICovCgoJZnVuY3Rpb24gcGx1cmFsKG1zLCBuLCBuYW1lKSB7CgkgIGlmIChtcyA8IG4pIHJldHVybjsKCSAgaWYgKG1zIDwgbiAqIDEuNSkgcmV0dXJuIE1hdGguZmxvb3IobXMgLyBuKSArICcgJyArIG5hbWU7CgkgIHJldHVybiBNYXRoLmNlaWwobXMgLyBuKSArICcgJyArIG5hbWUgKyAncyc7Cgl9CgoKLyoqKi8gfSwKLyogNCAqLwovKioqLyBmdW5jdGlvbihtb2R1bGUsIGV4cG9ydHMsIF9fd2VicGFja19yZXF1aXJlX18pIHsKCgkndXNlIHN0cmljdCc7CgoJdmFyIF9jcmVhdGVDbGFzcyA9IChmdW5jdGlvbiAoKSB7IGZ1bmN0aW9uIGRlZmluZVByb3BlcnRpZXModGFyZ2V0LCBwcm9wcykgeyBmb3IgKHZhciBpID0gMDsgaSA8IHByb3BzLmxlbmd0aDsgaSsrKSB7IHZhciBkZXNjcmlwdG9yID0gcHJvcHNbaV07IGRlc2NyaXB0b3IuZW51bWVyYWJsZSA9IGRlc2NyaXB0b3IuZW51bWVyYWJsZSB8fCBmYWxzZTsgZGVzY3JpcHRvci5jb25maWd1cmFibGUgPSB0cnVlOyBpZiAoJ3ZhbHVlJyBpbiBkZXNjcmlwdG9yKSBkZXNjcmlwdG9yLndyaXRhYmxlID0gdHJ1ZTsgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRhcmdldCwgZGVzY3JpcHRvci5rZXksIGRlc2NyaXB0b3IpOyB9IH0gcmV0dXJuIGZ1bmN0aW9uIChDb25zdHJ1Y3RvciwgcHJvdG9Qcm9wcywgc3RhdGljUHJvcHMpIHsgaWYgKHByb3RvUHJvcHMpIGRlZmluZVByb3BlcnRpZXMoQ29uc3RydWN0b3IucHJvdG90eXBlLCBwcm90b1Byb3BzKTsgaWYgKHN0YXRpY1Byb3BzKSBkZWZpbmVQcm9wZXJ0aWVzKENvbnN0cnVjdG9yLCBzdGF0aWNQcm9wcyk7IHJldHVybiBDb25zdHJ1Y3RvcjsgfTsgfSkoKTsKCgl2YXIgX2dldCA9IGZ1bmN0aW9uIGdldChfeCwgX3gyLCBfeDMpIHsgdmFyIF9hZ2FpbiA9IHRydWU7IF9mdW5jdGlvbjogd2hpbGUgKF9hZ2FpbikgeyB2YXIgb2JqZWN0ID0gX3gsIHByb3BlcnR5ID0gX3gyLCByZWNlaXZlciA9IF94MzsgZGVzYyA9IHBhcmVudCA9IGdldHRlciA9IHVuZGVmaW5lZDsgX2FnYWluID0gZmFsc2U7IGlmIChvYmplY3QgPT09IG51bGwpIG9iamVjdCA9IEZ1bmN0aW9uLnByb3RvdHlwZTsgdmFyIGRlc2MgPSBPYmplY3QuZ2V0T3duUHJvcGVydHlEZXNjcmlwdG9yKG9iamVjdCwgcHJvcGVydHkpOyBpZiAoZGVzYyA9PT0gdW5kZWZpbmVkKSB7IHZhciBwYXJlbnQgPSBPYmplY3QuZ2V0UHJvdG90eXBlT2Yob2JqZWN0KTsgaWYgKHBhcmVudCA9PT0gbnVsbCkgeyByZXR1cm4gdW5kZWZpbmVkOyB9IGVsc2UgeyBfeCA9IHBhcmVudDsgX3gyID0gcHJvcGVydHk7IF94MyA9IHJlY2VpdmVyOyBfYWdhaW4gPSB0cnVlOyBjb250aW51ZSBfZnVuY3Rpb247IH0gfSBlbHNlIGlmICgndmFsdWUnIGluIGRlc2MpIHsgcmV0dXJuIGRlc2MudmFsdWU7IH0gZWxzZSB7IHZhciBnZXR0ZXIgPSBkZXNjLmdldDsgaWYgKGdldHRlciA9PT0gdW5kZWZpbmVkKSB7IHJldHVybiB1bmRlZmluZWQ7IH0gcmV0dXJuIGdldHRlci5jYWxsKHJlY2VpdmVyKTsgfSB9IH07CgoJZnVuY3Rpb24gX2NsYXNzQ2FsbENoZWNrKGluc3RhbmNlLCBDb25zdHJ1Y3RvcikgeyBpZiAoIShpbnN0YW5jZSBpbnN0YW5jZW9mIENvbnN0cnVjdG9yKSkgeyB0aHJvdyBuZXcgVHlwZUVycm9yKCdDYW5ub3QgY2FsbCBhIGNsYXNzIGFzIGEgZnVuY3Rpb24nKTsgfSB9CgoJZnVuY3Rpb24gX2luaGVyaXRzKHN1YkNsYXNzLCBzdXBlckNsYXNzKSB7IGlmICh0eXBlb2Ygc3VwZXJDbGFzcyAhPT0gJ2Z1bmN0aW9uJyAmJiBzdXBlckNsYXNzICE9PSBudWxsKSB7IHRocm93IG5ldyBUeXBlRXJyb3IoJ1N1cGVyIGV4cHJlc3Npb24gbXVzdCBlaXRoZXIgYmUgbnVsbCBvciBhIGZ1bmN0aW9uLCBub3QgJyArIHR5cGVvZiBzdXBlckNsYXNzKTsgfSBzdWJDbGFzcy5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKHN1cGVyQ2xhc3MgJiYgc3VwZXJDbGFzcy5wcm90b3R5cGUsIHsgY29uc3RydWN0b3I6IHsgdmFsdWU6IHN1YkNsYXNzLCBlbnVtZXJhYmxlOiBmYWxzZSwgd3JpdGFibGU6IHRydWUsIGNvbmZpZ3VyYWJsZTogdHJ1ZSB9IH0pOyBpZiAoc3VwZXJDbGFzcykgT2JqZWN0LnNldFByb3RvdHlwZU9mID8gT2JqZWN0LnNldFByb3RvdHlwZU9mKHN1YkNsYXNzLCBzdXBlckNsYXNzKSA6IHN1YkNsYXNzLl9fcHJvdG9fXyA9IHN1cGVyQ2xhc3M7IH0KCgl2YXIgTWVzc2FnZSA9IF9fd2VicGFja19yZXF1aXJlX18oNSk7CgoJdmFyIEV2ZW50RW1pdHRlciA9IF9fd2VicGFja19yZXF1aXJlX18oNik7CgoJdmFyIGlkQ291bnRlciA9IDA7Cgl2YXIgcG9zdGVkTWVzc2FnZXMgPSBuZXcgTWFwKCk7CgoJdmFyIE1lc3NhZ2VIYW5kbGVyID0gKGZ1bmN0aW9uIChfRXZlbnRFbWl0dGVyKSB7CgkgICAgX2luaGVyaXRzKE1lc3NhZ2VIYW5kbGVyLCBfRXZlbnRFbWl0dGVyKTsKCgkgICAgZnVuY3Rpb24gTWVzc2FnZUhhbmRsZXIoKSB7CgkgICAgICAgIF9jbGFzc0NhbGxDaGVjayh0aGlzLCBNZXNzYWdlSGFuZGxlcik7CgoJICAgICAgICBfZ2V0KE9iamVjdC5nZXRQcm90b3R5cGVPZihNZXNzYWdlSGFuZGxlci5wcm90b3R5cGUpLCAnY29uc3RydWN0b3InLCB0aGlzKS5jYWxsKHRoaXMpOwoJICAgICAgICB0aGlzLnJlYWR5VG9Qb3N0ID0gZmFsc2U7CgkgICAgICAgIHRoaXMucmVhZHlUb0hhbmRsZSA9IGZhbHNlOwoJICAgICAgICB0aGlzLndpbmRvd0lEID0gbnVsbDsKCSAgICAgICAgdGhpcy5tZXNzYWdlU291cmNlID0gbnVsbDsKCSAgICAgICAgdGhpcy5wZW5kaW5nTWVzc2FnZXMgPSBbXTsKCSAgICAgICAgdGhpcy51bmhhbmRsZWRNZXNzYWdlcyA9IFtdOwoJICAgIH0KCgkgICAgX2NyZWF0ZUNsYXNzKE1lc3NhZ2VIYW5kbGVyLCBbewoJICAgICAgICBrZXk6ICdpbml0JywKCSAgICAgICAgdmFsdWU6IGZ1bmN0aW9uIGluaXQobWVzc2FnZVNvdXJjZSkgewoJICAgICAgICAgICAgdGhpcy5yZWFkeVRvUG9zdCA9IHRydWU7CgkgICAgICAgICAgICB0aGlzLndpbmRvd0lEID0gTWF0aC5mbG9vcih3aW5kb3cucGVyZm9ybWFuY2Uubm93KCkpOwoJICAgICAgICAgICAgdGhpcy5tZXNzYWdlU291cmNlID0gbWVzc2FnZVNvdXJjZTsKCSAgICAgICAgICAgIHRoaXMubWVzc2FnZVNvdXJjZS5wb3N0TWVzc2FnZSh7CgkgICAgICAgICAgICAgICAgdHlwZTogJ2FkbWluLmNvbm5lY3QnLAoJICAgICAgICAgICAgICAgIHdpbmRvd0lEOiB0aGlzLndpbmRvd0lECgkgICAgICAgICAgICB9LCAnKicpOwoJICAgICAgICAgICAgdGhpcy5wb3N0UGVuZGluZ01lc3NhZ2VzKCk7CgkgICAgICAgIH0KCSAgICB9LCB7CgkgICAgICAgIGtleTogJ3Bvc3RNZXNzYWdlJywKCSAgICAgICAgdmFsdWU6IGZ1bmN0aW9uIHBvc3RNZXNzYWdlKHR5cGUsIG1lc3NhZ2UpIHsKCSAgICAgICAgICAgIHZhciBpZCA9ICsraWRDb3VudGVyOwoJICAgICAgICAgICAgdmFyIHRvUG9zdCA9IHsKCSAgICAgICAgICAgICAgICB0eXBlOiB0eXBlLAoJICAgICAgICAgICAgICAgIG1lc3NhZ2U6IG1lc3NhZ2UsCgkgICAgICAgICAgICAgICAgbWVzc2FnZUlEOiBpZCwKCSAgICAgICAgICAgICAgICB3aW5kb3dJRDogdGhpcy53aW5kb3dJRAoJICAgICAgICAgICAgfTsKCSAgICAgICAgICAgIHZhciB0aGVNZXNzYWdlID0gbmV3IE1lc3NhZ2UoaWQsIHRvUG9zdCk7CgkgICAgICAgICAgICBpZiAodGhpcy5yZWFkeVRvUG9zdCkgewoJICAgICAgICAgICAgICAgIHRoaXMubWVzc2FnZVNvdXJjZS5wb3N0TWVzc2FnZSh0b1Bvc3QsICcqJyk7CgkgICAgICAgICAgICAgICAgcG9zdGVkTWVzc2FnZXMuc2V0KGlkLCB0aGVNZXNzYWdlKTsKCSAgICAgICAgICAgIH0gZWxzZSB7CgkgICAgICAgICAgICAgICAgdGhpcy5wZW5kaW5nTWVzc2FnZXMucHVzaCh0aGVNZXNzYWdlKTsKCSAgICAgICAgICAgIH0KCSAgICAgICAgICAgIHJldHVybiB0aGVNZXNzYWdlOwoJICAgICAgICB9CgkgICAgfSwgewoJICAgICAgICBrZXk6ICdwb3N0UGVuZGluZ01lc3NhZ2VzJywKCSAgICAgICAgdmFsdWU6IGZ1bmN0aW9uIHBvc3RQZW5kaW5nTWVzc2FnZXMoKSB7CgkgICAgICAgICAgICB2YXIgX2l0ZXJhdG9yTm9ybWFsQ29tcGxldGlvbiA9IHRydWU7CgkgICAgICAgICAgICB2YXIgX2RpZEl0ZXJhdG9yRXJyb3IgPSBmYWxzZTsKCSAgICAgICAgICAgIHZhciBfaXRlcmF0b3JFcnJvciA9IHVuZGVmaW5lZDsKCgkgICAgICAgICAgICB0cnkgewoJICAgICAgICAgICAgICAgIGZvciAodmFyIF9pdGVyYXRvciA9IHRoaXMucGVuZGluZ01lc3NhZ2VzW1N5bWJvbC5pdGVyYXRvcl0oKSwgX3N0ZXA7ICEoX2l0ZXJhdG9yTm9ybWFsQ29tcGxldGlvbiA9IChfc3RlcCA9IF9pdGVyYXRvci5uZXh0KCkpLmRvbmUpOyBfaXRlcmF0b3JOb3JtYWxDb21wbGV0aW9uID0gdHJ1ZSkgewoJICAgICAgICAgICAgICAgICAgICB2YXIgbWVzc2FnZSA9IF9zdGVwLnZhbHVlOwoKCSAgICAgICAgICAgICAgICAgICAgbWVzc2FnZS5kYXRhLndpbmRvd0lEID0gdGhpcy53aW5kb3dJRDsKCSAgICAgICAgICAgICAgICAgICAgdGhpcy5tZXNzYWdlU291cmNlLnBvc3RNZXNzYWdlKG1lc3NhZ2UuZGF0YSwgJyonKTsKCSAgICAgICAgICAgICAgICAgICAgcG9zdGVkTWVzc2FnZXMuc2V0KG1lc3NhZ2UuaWQsIG1lc3NhZ2UpOwoJICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgIH0gY2F0Y2ggKGVycikgewoJICAgICAgICAgICAgICAgIF9kaWRJdGVyYXRvckVycm9yID0gdHJ1ZTsKCSAgICAgICAgICAgICAgICBfaXRlcmF0b3JFcnJvciA9IGVycjsKCSAgICAgICAgICAgIH0gZmluYWxseSB7CgkgICAgICAgICAgICAgICAgdHJ5IHsKCSAgICAgICAgICAgICAgICAgICAgaWYgKCFfaXRlcmF0b3JOb3JtYWxDb21wbGV0aW9uICYmIF9pdGVyYXRvclsncmV0dXJuJ10pIHsKCSAgICAgICAgICAgICAgICAgICAgICAgIF9pdGVyYXRvclsncmV0dXJuJ10oKTsKCSAgICAgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgICAgIH0gZmluYWxseSB7CgkgICAgICAgICAgICAgICAgICAgIGlmIChfZGlkSXRlcmF0b3JFcnJvcikgewoJICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgX2l0ZXJhdG9yRXJyb3I7CgkgICAgICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICB9CgkgICAgICAgIH0KCSAgICB9LCB7CgkgICAgICAgIGtleTogJ2hhbmRsZVBlbmRpbmdNZXNzYWdlcycsCgkgICAgICAgIHZhbHVlOiBmdW5jdGlvbiBoYW5kbGVQZW5kaW5nTWVzc2FnZXMoKSB7CgkgICAgICAgICAgICB0aGlzLnJlYWR5VG9IYW5kbGUgPSB0cnVlOwoJICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLnVuaGFuZGxlZE1lc3NhZ2VzLmxlbmd0aDsgaSsrKSB7CgkgICAgICAgICAgICAgICAgdGhpcy5oYW5kbGVNZXNzYWdlKHRoaXMudW5oYW5kbGVkTWVzc2FnZXNbaV0pOwoJICAgICAgICAgICAgfQoJICAgICAgICAgICAgdGhpcy51bmhhbmRsZWRNZXNzYWdlcyA9IFtdOwoJICAgICAgICB9CgkgICAgfSwgewoJICAgICAgICBrZXk6ICdoYW5kbGVNZXNzYWdlJywKCSAgICAgICAgdmFsdWU6IGZ1bmN0aW9uIGhhbmRsZU1lc3NhZ2UoZGF0YSkgewoJICAgICAgICAgICAgaWYgKCF0aGlzLnJlYWR5VG9IYW5kbGUpIHsKCSAgICAgICAgICAgICAgICB0aGlzLnVuaGFuZGxlZE1lc3NhZ2VzLnB1c2goZGF0YSk7CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICBpZiAoIXBvc3RlZE1lc3NhZ2VzLmhhcyhkYXRhLm1lc3NhZ2VJRCkpIHsKCSAgICAgICAgICAgICAgICByZXR1cm4gdGhpcy5lbWl0KCdtZXNzYWdlJywgZGF0YSk7CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICB2YXIgbWVzc2FnZSA9IHBvc3RlZE1lc3NhZ2VzLmdldChkYXRhLm1lc3NhZ2VJRCk7CgkgICAgICAgICAgICBpZiAoZGF0YS5zdGF0dXMpIHsKCSAgICAgICAgICAgICAgICBpZiAoZGF0YS5zdGF0dXMgPT09ICdlcnJvcicpIHsKCSAgICAgICAgICAgICAgICAgICAgbWVzc2FnZS5fcmVqZWN0KGRhdGEpOwoJICAgICAgICAgICAgICAgICAgICBwb3N0ZWRNZXNzYWdlcy5kZWxldGUoZGF0YS5tZXNzYWdlSUQpOwoJICAgICAgICAgICAgICAgIH0gZWxzZSBpZiAoZGF0YS5zdGF0dXMgPT09ICdzdWNjZXNzJykgewoJICAgICAgICAgICAgICAgICAgICBtZXNzYWdlLl9yZXNvbHZlKGRhdGEpOwoJICAgICAgICAgICAgICAgICAgICBwb3N0ZWRNZXNzYWdlcy5kZWxldGUoZGF0YS5tZXNzYWdlSUQpOwoJICAgICAgICAgICAgICAgIH0gZWxzZSB7CgkgICAgICAgICAgICAgICAgICAgIG1lc3NhZ2UuZW1pdChkYXRhLnN0YXR1cywgZGF0YSk7CgkgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgfSBlbHNlIHsKCSAgICAgICAgICAgICAgICAvLyBubyBzdGF0dXMgaXMgY29uc2lkZXJlZCBhIHN1Y2Nlc3MKCSAgICAgICAgICAgICAgICBtZXNzYWdlLl9yZXNvbHZlKGRhdGEpOwoJICAgICAgICAgICAgICAgIHBvc3RlZE1lc3NhZ2VzLmRlbGV0ZShkYXRhLm1lc3NhZ2VJRCk7CgkgICAgICAgICAgICB9CgkgICAgICAgIH0KCSAgICB9XSk7CgoJICAgIHJldHVybiBNZXNzYWdlSGFuZGxlcjsKCX0pKEV2ZW50RW1pdHRlcik7CgoJbW9kdWxlLmV4cG9ydHMgPSBNZXNzYWdlSGFuZGxlcjsKCi8qKiovIH0sCi8qIDUgKi8KLyoqKi8gZnVuY3Rpb24obW9kdWxlLCBleHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKSB7CgoJJ3VzZSBzdHJpY3QnOwoKCXZhciBfY3JlYXRlQ2xhc3MgPSAoZnVuY3Rpb24gKCkgeyBmdW5jdGlvbiBkZWZpbmVQcm9wZXJ0aWVzKHRhcmdldCwgcHJvcHMpIHsgZm9yICh2YXIgaSA9IDA7IGkgPCBwcm9wcy5sZW5ndGg7IGkrKykgeyB2YXIgZGVzY3JpcHRvciA9IHByb3BzW2ldOyBkZXNjcmlwdG9yLmVudW1lcmFibGUgPSBkZXNjcmlwdG9yLmVudW1lcmFibGUgfHwgZmFsc2U7IGRlc2NyaXB0b3IuY29uZmlndXJhYmxlID0gdHJ1ZTsgaWYgKCd2YWx1ZScgaW4gZGVzY3JpcHRvcikgZGVzY3JpcHRvci53cml0YWJsZSA9IHRydWU7IE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0YXJnZXQsIGRlc2NyaXB0b3Iua2V5LCBkZXNjcmlwdG9yKTsgfSB9IHJldHVybiBmdW5jdGlvbiAoQ29uc3RydWN0b3IsIHByb3RvUHJvcHMsIHN0YXRpY1Byb3BzKSB7IGlmIChwcm90b1Byb3BzKSBkZWZpbmVQcm9wZXJ0aWVzKENvbnN0cnVjdG9yLnByb3RvdHlwZSwgcHJvdG9Qcm9wcyk7IGlmIChzdGF0aWNQcm9wcykgZGVmaW5lUHJvcGVydGllcyhDb25zdHJ1Y3Rvciwgc3RhdGljUHJvcHMpOyByZXR1cm4gQ29uc3RydWN0b3I7IH07IH0pKCk7CgoJdmFyIF9nZXQgPSBmdW5jdGlvbiBnZXQoX3gsIF94MiwgX3gzKSB7IHZhciBfYWdhaW4gPSB0cnVlOyBfZnVuY3Rpb246IHdoaWxlIChfYWdhaW4pIHsgdmFyIG9iamVjdCA9IF94LCBwcm9wZXJ0eSA9IF94MiwgcmVjZWl2ZXIgPSBfeDM7IGRlc2MgPSBwYXJlbnQgPSBnZXR0ZXIgPSB1bmRlZmluZWQ7IF9hZ2FpbiA9IGZhbHNlOyBpZiAob2JqZWN0ID09PSBudWxsKSBvYmplY3QgPSBGdW5jdGlvbi5wcm90b3R5cGU7IHZhciBkZXNjID0gT2JqZWN0LmdldE93blByb3BlcnR5RGVzY3JpcHRvcihvYmplY3QsIHByb3BlcnR5KTsgaWYgKGRlc2MgPT09IHVuZGVmaW5lZCkgeyB2YXIgcGFyZW50ID0gT2JqZWN0LmdldFByb3RvdHlwZU9mKG9iamVjdCk7IGlmIChwYXJlbnQgPT09IG51bGwpIHsgcmV0dXJuIHVuZGVmaW5lZDsgfSBlbHNlIHsgX3ggPSBwYXJlbnQ7IF94MiA9IHByb3BlcnR5OyBfeDMgPSByZWNlaXZlcjsgX2FnYWluID0gdHJ1ZTsgY29udGludWUgX2Z1bmN0aW9uOyB9IH0gZWxzZSBpZiAoJ3ZhbHVlJyBpbiBkZXNjKSB7IHJldHVybiBkZXNjLnZhbHVlOyB9IGVsc2UgeyB2YXIgZ2V0dGVyID0gZGVzYy5nZXQ7IGlmIChnZXR0ZXIgPT09IHVuZGVmaW5lZCkgeyByZXR1cm4gdW5kZWZpbmVkOyB9IHJldHVybiBnZXR0ZXIuY2FsbChyZWNlaXZlcik7IH0gfSB9OwoKCWZ1bmN0aW9uIF9jbGFzc0NhbGxDaGVjayhpbnN0YW5jZSwgQ29uc3RydWN0b3IpIHsgaWYgKCEoaW5zdGFuY2UgaW5zdGFuY2VvZiBDb25zdHJ1Y3RvcikpIHsgdGhyb3cgbmV3IFR5cGVFcnJvcignQ2Fubm90IGNhbGwgYSBjbGFzcyBhcyBhIGZ1bmN0aW9uJyk7IH0gfQoKCWZ1bmN0aW9uIF9pbmhlcml0cyhzdWJDbGFzcywgc3VwZXJDbGFzcykgeyBpZiAodHlwZW9mIHN1cGVyQ2xhc3MgIT09ICdmdW5jdGlvbicgJiYgc3VwZXJDbGFzcyAhPT0gbnVsbCkgeyB0aHJvdyBuZXcgVHlwZUVycm9yKCdTdXBlciBleHByZXNzaW9uIG11c3QgZWl0aGVyIGJlIG51bGwgb3IgYSBmdW5jdGlvbiwgbm90ICcgKyB0eXBlb2Ygc3VwZXJDbGFzcyk7IH0gc3ViQ2xhc3MucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShzdXBlckNsYXNzICYmIHN1cGVyQ2xhc3MucHJvdG90eXBlLCB7IGNvbnN0cnVjdG9yOiB7IHZhbHVlOiBzdWJDbGFzcywgZW51bWVyYWJsZTogZmFsc2UsIHdyaXRhYmxlOiB0cnVlLCBjb25maWd1cmFibGU6IHRydWUgfSB9KTsgaWYgKHN1cGVyQ2xhc3MpIE9iamVjdC5zZXRQcm90b3R5cGVPZiA/IE9iamVjdC5zZXRQcm90b3R5cGVPZihzdWJDbGFzcywgc3VwZXJDbGFzcykgOiBzdWJDbGFzcy5fX3Byb3RvX18gPSBzdXBlckNsYXNzOyB9CgoJdmFyIEV2ZW50RW1pdHRlciA9IF9fd2VicGFja19yZXF1aXJlX18oNikuRXZlbnRFbWl0dGVyOwoJdmFyIHByb21pc2UgPSBTeW1ib2woKTsKCgl2YXIgTWVzc2FnZSA9IChmdW5jdGlvbiAoX0V2ZW50RW1pdHRlcikgewoJICAgIF9pbmhlcml0cyhNZXNzYWdlLCBfRXZlbnRFbWl0dGVyKTsKCgkgICAgZnVuY3Rpb24gTWVzc2FnZShpZCwgZGF0YSkgewoJICAgICAgICB2YXIgX3RoaXMgPSB0aGlzOwoKCSAgICAgICAgX2NsYXNzQ2FsbENoZWNrKHRoaXMsIE1lc3NhZ2UpOwoKCSAgICAgICAgX2dldChPYmplY3QuZ2V0UHJvdG90eXBlT2YoTWVzc2FnZS5wcm90b3R5cGUpLCAnY29uc3RydWN0b3InLCB0aGlzKS5jYWxsKHRoaXMpOwoJICAgICAgICB0aGlzLmlkID0gaWQ7CgkgICAgICAgIHRoaXMuZGF0YSA9IGRhdGE7CgkgICAgICAgIHRoaXNbcHJvbWlzZV0gPSBuZXcgUHJvbWlzZShmdW5jdGlvbiAocmVzb2x2ZSwgcmVqZWN0KSB7CgkgICAgICAgICAgICBfdGhpcy5fcmVzb2x2ZSA9IHJlc29sdmU7CgkgICAgICAgICAgICBfdGhpcy5fcmVqZWN0ID0gcmVqZWN0OwoJICAgICAgICB9KTsKCSAgICB9CgoJICAgIF9jcmVhdGVDbGFzcyhNZXNzYWdlLCBbewoJICAgICAgICBrZXk6ICd0aGVuJywKCSAgICAgICAgdmFsdWU6IGZ1bmN0aW9uIHRoZW4ob25SZXNvbHZlLCBvblJlamVjdCkgewoJICAgICAgICAgICAgcmV0dXJuIHRoaXNbcHJvbWlzZV0udGhlbihvblJlc29sdmUsIG9uUmVqZWN0KTsKCSAgICAgICAgfQoJICAgIH0sIHsKCSAgICAgICAga2V5OiAnY2F0Y2gnLAoJICAgICAgICB2YWx1ZTogZnVuY3Rpb24gX2NhdGNoKG9uUmVqZWN0KSB7CgkgICAgICAgICAgICByZXR1cm4gdGhpc1twcm9taXNlXS5jYXRjaChvblJlamVjdCk7CgkgICAgICAgIH0KCSAgICB9XSk7CgoJICAgIHJldHVybiBNZXNzYWdlOwoJfSkoRXZlbnRFbWl0dGVyKTsKCgltb2R1bGUuZXhwb3J0cyA9IE1lc3NhZ2U7CgovKioqLyB9LAovKiA2ICovCi8qKiovIGZ1bmN0aW9uKG1vZHVsZSwgZXhwb3J0cykgewoKCS8vIENvcHlyaWdodCBKb3llbnQsIEluYy4gYW5kIG90aGVyIE5vZGUgY29udHJpYnV0b3JzLgoJLy8KCS8vIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZyBhCgkvLyBjb3B5IG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlCgkvLyAiU29mdHdhcmUiKSwgdG8gZGVhbCBpbiB0aGUgU29mdHdhcmUgd2l0aG91dCByZXN0cmljdGlvbiwgaW5jbHVkaW5nCgkvLyB3aXRob3V0IGxpbWl0YXRpb24gdGhlIHJpZ2h0cyB0byB1c2UsIGNvcHksIG1vZGlmeSwgbWVyZ2UsIHB1Ymxpc2gsCgkvLyBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbCBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0CgkvLyBwZXJzb25zIHRvIHdob20gdGhlIFNvZnR3YXJlIGlzIGZ1cm5pc2hlZCB0byBkbyBzbywgc3ViamVjdCB0byB0aGUKCS8vIGZvbGxvd2luZyBjb25kaXRpb25zOgoJLy8KCS8vIFRoZSBhYm92ZSBjb3B5cmlnaHQgbm90aWNlIGFuZCB0aGlzIHBlcm1pc3Npb24gbm90aWNlIHNoYWxsIGJlIGluY2x1ZGVkCgkvLyBpbiBhbGwgY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS4KCS8vCgkvLyBUSEUgU09GVFdBUkUgSVMgUFJPVklERUQgIkFTIElTIiwgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwgRVhQUkVTUwoJLy8gT1IgSU1QTElFRCwgSU5DTFVESU5HIEJVVCBOT1QgTElNSVRFRCBUTyBUSEUgV0FSUkFOVElFUyBPRgoJLy8gTUVSQ0hBTlRBQklMSVRZLCBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiBJTgoJLy8gTk8gRVZFTlQgU0hBTEwgVEhFIEFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sCgkvLyBEQU1BR0VTIE9SIE9USEVSIExJQUJJTElUWSwgV0hFVEhFUiBJTiBBTiBBQ1RJT04gT0YgQ09OVFJBQ1QsIFRPUlQgT1IKCS8vIE9USEVSV0lTRSwgQVJJU0lORyBGUk9NLCBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUKCS8vIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTiBUSEUgU09GVFdBUkUuCgoJZnVuY3Rpb24gRXZlbnRFbWl0dGVyKCkgewoJICB0aGlzLl9ldmVudHMgPSB0aGlzLl9ldmVudHMgfHwge307CgkgIHRoaXMuX21heExpc3RlbmVycyA9IHRoaXMuX21heExpc3RlbmVycyB8fCB1bmRlZmluZWQ7Cgl9Cgltb2R1bGUuZXhwb3J0cyA9IEV2ZW50RW1pdHRlcjsKCgkvLyBCYWNrd2FyZHMtY29tcGF0IHdpdGggbm9kZSAwLjEwLngKCUV2ZW50RW1pdHRlci5FdmVudEVtaXR0ZXIgPSBFdmVudEVtaXR0ZXI7CgoJRXZlbnRFbWl0dGVyLnByb3RvdHlwZS5fZXZlbnRzID0gdW5kZWZpbmVkOwoJRXZlbnRFbWl0dGVyLnByb3RvdHlwZS5fbWF4TGlzdGVuZXJzID0gdW5kZWZpbmVkOwoKCS8vIEJ5IGRlZmF1bHQgRXZlbnRFbWl0dGVycyB3aWxsIHByaW50IGEgd2FybmluZyBpZiBtb3JlIHRoYW4gMTAgbGlzdGVuZXJzIGFyZQoJLy8gYWRkZWQgdG8gaXQuIFRoaXMgaXMgYSB1c2VmdWwgZGVmYXVsdCB3aGljaCBoZWxwcyBmaW5kaW5nIG1lbW9yeSBsZWFrcy4KCUV2ZW50RW1pdHRlci5kZWZhdWx0TWF4TGlzdGVuZXJzID0gMTA7CgoJLy8gT2J2aW91c2x5IG5vdCBhbGwgRW1pdHRlcnMgc2hvdWxkIGJlIGxpbWl0ZWQgdG8gMTAuIFRoaXMgZnVuY3Rpb24gYWxsb3dzCgkvLyB0aGF0IHRvIGJlIGluY3JlYXNlZC4gU2V0IHRvIHplcm8gZm9yIHVubGltaXRlZC4KCUV2ZW50RW1pdHRlci5wcm90b3R5cGUuc2V0TWF4TGlzdGVuZXJzID0gZnVuY3Rpb24obikgewoJICBpZiAoIWlzTnVtYmVyKG4pIHx8IG4gPCAwIHx8IGlzTmFOKG4pKQoJICAgIHRocm93IFR5cGVFcnJvcignbiBtdXN0IGJlIGEgcG9zaXRpdmUgbnVtYmVyJyk7CgkgIHRoaXMuX21heExpc3RlbmVycyA9IG47CgkgIHJldHVybiB0aGlzOwoJfTsKCglFdmVudEVtaXR0ZXIucHJvdG90eXBlLmVtaXQgPSBmdW5jdGlvbih0eXBlKSB7CgkgIHZhciBlciwgaGFuZGxlciwgbGVuLCBhcmdzLCBpLCBsaXN0ZW5lcnM7CgoJICBpZiAoIXRoaXMuX2V2ZW50cykKCSAgICB0aGlzLl9ldmVudHMgPSB7fTsKCgkgIC8vIElmIHRoZXJlIGlzIG5vICdlcnJvcicgZXZlbnQgbGlzdGVuZXIgdGhlbiB0aHJvdy4KCSAgaWYgKHR5cGUgPT09ICdlcnJvcicpIHsKCSAgICBpZiAoIXRoaXMuX2V2ZW50cy5lcnJvciB8fAoJICAgICAgICAoaXNPYmplY3QodGhpcy5fZXZlbnRzLmVycm9yKSAmJiAhdGhpcy5fZXZlbnRzLmVycm9yLmxlbmd0aCkpIHsKCSAgICAgIGVyID0gYXJndW1lbnRzWzFdOwoJICAgICAgaWYgKGVyIGluc3RhbmNlb2YgRXJyb3IpIHsKCSAgICAgICAgdGhyb3cgZXI7IC8vIFVuaGFuZGxlZCAnZXJyb3InIGV2ZW50CgkgICAgICB9CgkgICAgICB0aHJvdyBUeXBlRXJyb3IoJ1VuY2F1Z2h0LCB1bnNwZWNpZmllZCAiZXJyb3IiIGV2ZW50LicpOwoJICAgIH0KCSAgfQoKCSAgaGFuZGxlciA9IHRoaXMuX2V2ZW50c1t0eXBlXTsKCgkgIGlmIChpc1VuZGVmaW5lZChoYW5kbGVyKSkKCSAgICByZXR1cm4gZmFsc2U7CgoJICBpZiAoaXNGdW5jdGlvbihoYW5kbGVyKSkgewoJICAgIHN3aXRjaCAoYXJndW1lbnRzLmxlbmd0aCkgewoJICAgICAgLy8gZmFzdCBjYXNlcwoJICAgICAgY2FzZSAxOgoJICAgICAgICBoYW5kbGVyLmNhbGwodGhpcyk7CgkgICAgICAgIGJyZWFrOwoJICAgICAgY2FzZSAyOgoJICAgICAgICBoYW5kbGVyLmNhbGwodGhpcywgYXJndW1lbnRzWzFdKTsKCSAgICAgICAgYnJlYWs7CgkgICAgICBjYXNlIDM6CgkgICAgICAgIGhhbmRsZXIuY2FsbCh0aGlzLCBhcmd1bWVudHNbMV0sIGFyZ3VtZW50c1syXSk7CgkgICAgICAgIGJyZWFrOwoJICAgICAgLy8gc2xvd2VyCgkgICAgICBkZWZhdWx0OgoJICAgICAgICBsZW4gPSBhcmd1bWVudHMubGVuZ3RoOwoJICAgICAgICBhcmdzID0gbmV3IEFycmF5KGxlbiAtIDEpOwoJICAgICAgICBmb3IgKGkgPSAxOyBpIDwgbGVuOyBpKyspCgkgICAgICAgICAgYXJnc1tpIC0gMV0gPSBhcmd1bWVudHNbaV07CgkgICAgICAgIGhhbmRsZXIuYXBwbHkodGhpcywgYXJncyk7CgkgICAgfQoJICB9IGVsc2UgaWYgKGlzT2JqZWN0KGhhbmRsZXIpKSB7CgkgICAgbGVuID0gYXJndW1lbnRzLmxlbmd0aDsKCSAgICBhcmdzID0gbmV3IEFycmF5KGxlbiAtIDEpOwoJICAgIGZvciAoaSA9IDE7IGkgPCBsZW47IGkrKykKCSAgICAgIGFyZ3NbaSAtIDFdID0gYXJndW1lbnRzW2ldOwoKCSAgICBsaXN0ZW5lcnMgPSBoYW5kbGVyLnNsaWNlKCk7CgkgICAgbGVuID0gbGlzdGVuZXJzLmxlbmd0aDsKCSAgICBmb3IgKGkgPSAwOyBpIDwgbGVuOyBpKyspCgkgICAgICBsaXN0ZW5lcnNbaV0uYXBwbHkodGhpcywgYXJncyk7CgkgIH0KCgkgIHJldHVybiB0cnVlOwoJfTsKCglFdmVudEVtaXR0ZXIucHJvdG90eXBlLmFkZExpc3RlbmVyID0gZnVuY3Rpb24odHlwZSwgbGlzdGVuZXIpIHsKCSAgdmFyIG07CgoJICBpZiAoIWlzRnVuY3Rpb24obGlzdGVuZXIpKQoJICAgIHRocm93IFR5cGVFcnJvcignbGlzdGVuZXIgbXVzdCBiZSBhIGZ1bmN0aW9uJyk7CgoJICBpZiAoIXRoaXMuX2V2ZW50cykKCSAgICB0aGlzLl9ldmVudHMgPSB7fTsKCgkgIC8vIFRvIGF2b2lkIHJlY3Vyc2lvbiBpbiB0aGUgY2FzZSB0aGF0IHR5cGUgPT09ICJuZXdMaXN0ZW5lciIhIEJlZm9yZQoJICAvLyBhZGRpbmcgaXQgdG8gdGhlIGxpc3RlbmVycywgZmlyc3QgZW1pdCAibmV3TGlzdGVuZXIiLgoJICBpZiAodGhpcy5fZXZlbnRzLm5ld0xpc3RlbmVyKQoJICAgIHRoaXMuZW1pdCgnbmV3TGlzdGVuZXInLCB0eXBlLAoJICAgICAgICAgICAgICBpc0Z1bmN0aW9uKGxpc3RlbmVyLmxpc3RlbmVyKSA/CgkgICAgICAgICAgICAgIGxpc3RlbmVyLmxpc3RlbmVyIDogbGlzdGVuZXIpOwoKCSAgaWYgKCF0aGlzLl9ldmVudHNbdHlwZV0pCgkgICAgLy8gT3B0aW1pemUgdGhlIGNhc2Ugb2Ygb25lIGxpc3RlbmVyLiBEb24ndCBuZWVkIHRoZSBleHRyYSBhcnJheSBvYmplY3QuCgkgICAgdGhpcy5fZXZlbnRzW3R5cGVdID0gbGlzdGVuZXI7CgkgIGVsc2UgaWYgKGlzT2JqZWN0KHRoaXMuX2V2ZW50c1t0eXBlXSkpCgkgICAgLy8gSWYgd2UndmUgYWxyZWFkeSBnb3QgYW4gYXJyYXksIGp1c3QgYXBwZW5kLgoJICAgIHRoaXMuX2V2ZW50c1t0eXBlXS5wdXNoKGxpc3RlbmVyKTsKCSAgZWxzZQoJICAgIC8vIEFkZGluZyB0aGUgc2Vjb25kIGVsZW1lbnQsIG5lZWQgdG8gY2hhbmdlIHRvIGFycmF5LgoJICAgIHRoaXMuX2V2ZW50c1t0eXBlXSA9IFt0aGlzLl9ldmVudHNbdHlwZV0sIGxpc3RlbmVyXTsKCgkgIC8vIENoZWNrIGZvciBsaXN0ZW5lciBsZWFrCgkgIGlmIChpc09iamVjdCh0aGlzLl9ldmVudHNbdHlwZV0pICYmICF0aGlzLl9ldmVudHNbdHlwZV0ud2FybmVkKSB7CgkgICAgdmFyIG07CgkgICAgaWYgKCFpc1VuZGVmaW5lZCh0aGlzLl9tYXhMaXN0ZW5lcnMpKSB7CgkgICAgICBtID0gdGhpcy5fbWF4TGlzdGVuZXJzOwoJICAgIH0gZWxzZSB7CgkgICAgICBtID0gRXZlbnRFbWl0dGVyLmRlZmF1bHRNYXhMaXN0ZW5lcnM7CgkgICAgfQoKCSAgICBpZiAobSAmJiBtID4gMCAmJiB0aGlzLl9ldmVudHNbdHlwZV0ubGVuZ3RoID4gbSkgewoJICAgICAgdGhpcy5fZXZlbnRzW3R5cGVdLndhcm5lZCA9IHRydWU7CgkgICAgICBjb25zb2xlLmVycm9yKCcobm9kZSkgd2FybmluZzogcG9zc2libGUgRXZlbnRFbWl0dGVyIG1lbW9yeSAnICsKCSAgICAgICAgICAgICAgICAgICAgJ2xlYWsgZGV0ZWN0ZWQuICVkIGxpc3RlbmVycyBhZGRlZC4gJyArCgkgICAgICAgICAgICAgICAgICAgICdVc2UgZW1pdHRlci5zZXRNYXhMaXN0ZW5lcnMoKSB0byBpbmNyZWFzZSBsaW1pdC4nLAoJICAgICAgICAgICAgICAgICAgICB0aGlzLl9ldmVudHNbdHlwZV0ubGVuZ3RoKTsKCSAgICAgIGlmICh0eXBlb2YgY29uc29sZS50cmFjZSA9PT0gJ2Z1bmN0aW9uJykgewoJICAgICAgICAvLyBub3Qgc3VwcG9ydGVkIGluIElFIDEwCgkgICAgICAgIGNvbnNvbGUudHJhY2UoKTsKCSAgICAgIH0KCSAgICB9CgkgIH0KCgkgIHJldHVybiB0aGlzOwoJfTsKCglFdmVudEVtaXR0ZXIucHJvdG90eXBlLm9uID0gRXZlbnRFbWl0dGVyLnByb3RvdHlwZS5hZGRMaXN0ZW5lcjsKCglFdmVudEVtaXR0ZXIucHJvdG90eXBlLm9uY2UgPSBmdW5jdGlvbih0eXBlLCBsaXN0ZW5lcikgewoJICBpZiAoIWlzRnVuY3Rpb24obGlzdGVuZXIpKQoJICAgIHRocm93IFR5cGVFcnJvcignbGlzdGVuZXIgbXVzdCBiZSBhIGZ1bmN0aW9uJyk7CgoJICB2YXIgZmlyZWQgPSBmYWxzZTsKCgkgIGZ1bmN0aW9uIGcoKSB7CgkgICAgdGhpcy5yZW1vdmVMaXN0ZW5lcih0eXBlLCBnKTsKCgkgICAgaWYgKCFmaXJlZCkgewoJICAgICAgZmlyZWQgPSB0cnVlOwoJICAgICAgbGlzdGVuZXIuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCSAgICB9CgkgIH0KCgkgIGcubGlzdGVuZXIgPSBsaXN0ZW5lcjsKCSAgdGhpcy5vbih0eXBlLCBnKTsKCgkgIHJldHVybiB0aGlzOwoJfTsKCgkvLyBlbWl0cyBhICdyZW1vdmVMaXN0ZW5lcicgZXZlbnQgaWZmIHRoZSBsaXN0ZW5lciB3YXMgcmVtb3ZlZAoJRXZlbnRFbWl0dGVyLnByb3RvdHlwZS5yZW1vdmVMaXN0ZW5lciA9IGZ1bmN0aW9uKHR5cGUsIGxpc3RlbmVyKSB7CgkgIHZhciBsaXN0LCBwb3NpdGlvbiwgbGVuZ3RoLCBpOwoKCSAgaWYgKCFpc0Z1bmN0aW9uKGxpc3RlbmVyKSkKCSAgICB0aHJvdyBUeXBlRXJyb3IoJ2xpc3RlbmVyIG11c3QgYmUgYSBmdW5jdGlvbicpOwoKCSAgaWYgKCF0aGlzLl9ldmVudHMgfHwgIXRoaXMuX2V2ZW50c1t0eXBlXSkKCSAgICByZXR1cm4gdGhpczsKCgkgIGxpc3QgPSB0aGlzLl9ldmVudHNbdHlwZV07CgkgIGxlbmd0aCA9IGxpc3QubGVuZ3RoOwoJICBwb3NpdGlvbiA9IC0xOwoKCSAgaWYgKGxpc3QgPT09IGxpc3RlbmVyIHx8CgkgICAgICAoaXNGdW5jdGlvbihsaXN0Lmxpc3RlbmVyKSAmJiBsaXN0Lmxpc3RlbmVyID09PSBsaXN0ZW5lcikpIHsKCSAgICBkZWxldGUgdGhpcy5fZXZlbnRzW3R5cGVdOwoJICAgIGlmICh0aGlzLl9ldmVudHMucmVtb3ZlTGlzdGVuZXIpCgkgICAgICB0aGlzLmVtaXQoJ3JlbW92ZUxpc3RlbmVyJywgdHlwZSwgbGlzdGVuZXIpOwoKCSAgfSBlbHNlIGlmIChpc09iamVjdChsaXN0KSkgewoJICAgIGZvciAoaSA9IGxlbmd0aDsgaS0tID4gMDspIHsKCSAgICAgIGlmIChsaXN0W2ldID09PSBsaXN0ZW5lciB8fAoJICAgICAgICAgIChsaXN0W2ldLmxpc3RlbmVyICYmIGxpc3RbaV0ubGlzdGVuZXIgPT09IGxpc3RlbmVyKSkgewoJICAgICAgICBwb3NpdGlvbiA9IGk7CgkgICAgICAgIGJyZWFrOwoJICAgICAgfQoJICAgIH0KCgkgICAgaWYgKHBvc2l0aW9uIDwgMCkKCSAgICAgIHJldHVybiB0aGlzOwoKCSAgICBpZiAobGlzdC5sZW5ndGggPT09IDEpIHsKCSAgICAgIGxpc3QubGVuZ3RoID0gMDsKCSAgICAgIGRlbGV0ZSB0aGlzLl9ldmVudHNbdHlwZV07CgkgICAgfSBlbHNlIHsKCSAgICAgIGxpc3Quc3BsaWNlKHBvc2l0aW9uLCAxKTsKCSAgICB9CgoJICAgIGlmICh0aGlzLl9ldmVudHMucmVtb3ZlTGlzdGVuZXIpCgkgICAgICB0aGlzLmVtaXQoJ3JlbW92ZUxpc3RlbmVyJywgdHlwZSwgbGlzdGVuZXIpOwoJICB9CgoJICByZXR1cm4gdGhpczsKCX07CgoJRXZlbnRFbWl0dGVyLnByb3RvdHlwZS5yZW1vdmVBbGxMaXN0ZW5lcnMgPSBmdW5jdGlvbih0eXBlKSB7CgkgIHZhciBrZXksIGxpc3RlbmVyczsKCgkgIGlmICghdGhpcy5fZXZlbnRzKQoJICAgIHJldHVybiB0aGlzOwoKCSAgLy8gbm90IGxpc3RlbmluZyBmb3IgcmVtb3ZlTGlzdGVuZXIsIG5vIG5lZWQgdG8gZW1pdAoJICBpZiAoIXRoaXMuX2V2ZW50cy5yZW1vdmVMaXN0ZW5lcikgewoJICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAwKQoJICAgICAgdGhpcy5fZXZlbnRzID0ge307CgkgICAgZWxzZSBpZiAodGhpcy5fZXZlbnRzW3R5cGVdKQoJICAgICAgZGVsZXRlIHRoaXMuX2V2ZW50c1t0eXBlXTsKCSAgICByZXR1cm4gdGhpczsKCSAgfQoKCSAgLy8gZW1pdCByZW1vdmVMaXN0ZW5lciBmb3IgYWxsIGxpc3RlbmVycyBvbiBhbGwgZXZlbnRzCgkgIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAwKSB7CgkgICAgZm9yIChrZXkgaW4gdGhpcy5fZXZlbnRzKSB7CgkgICAgICBpZiAoa2V5ID09PSAncmVtb3ZlTGlzdGVuZXInKSBjb250aW51ZTsKCSAgICAgIHRoaXMucmVtb3ZlQWxsTGlzdGVuZXJzKGtleSk7CgkgICAgfQoJICAgIHRoaXMucmVtb3ZlQWxsTGlzdGVuZXJzKCdyZW1vdmVMaXN0ZW5lcicpOwoJICAgIHRoaXMuX2V2ZW50cyA9IHt9OwoJICAgIHJldHVybiB0aGlzOwoJICB9CgoJICBsaXN0ZW5lcnMgPSB0aGlzLl9ldmVudHNbdHlwZV07CgoJICBpZiAoaXNGdW5jdGlvbihsaXN0ZW5lcnMpKSB7CgkgICAgdGhpcy5yZW1vdmVMaXN0ZW5lcih0eXBlLCBsaXN0ZW5lcnMpOwoJICB9IGVsc2UgewoJICAgIC8vIExJRk8gb3JkZXIKCSAgICB3aGlsZSAobGlzdGVuZXJzLmxlbmd0aCkKCSAgICAgIHRoaXMucmVtb3ZlTGlzdGVuZXIodHlwZSwgbGlzdGVuZXJzW2xpc3RlbmVycy5sZW5ndGggLSAxXSk7CgkgIH0KCSAgZGVsZXRlIHRoaXMuX2V2ZW50c1t0eXBlXTsKCgkgIHJldHVybiB0aGlzOwoJfTsKCglFdmVudEVtaXR0ZXIucHJvdG90eXBlLmxpc3RlbmVycyA9IGZ1bmN0aW9uKHR5cGUpIHsKCSAgdmFyIHJldDsKCSAgaWYgKCF0aGlzLl9ldmVudHMgfHwgIXRoaXMuX2V2ZW50c1t0eXBlXSkKCSAgICByZXQgPSBbXTsKCSAgZWxzZSBpZiAoaXNGdW5jdGlvbih0aGlzLl9ldmVudHNbdHlwZV0pKQoJICAgIHJldCA9IFt0aGlzLl9ldmVudHNbdHlwZV1dOwoJICBlbHNlCgkgICAgcmV0ID0gdGhpcy5fZXZlbnRzW3R5cGVdLnNsaWNlKCk7CgkgIHJldHVybiByZXQ7Cgl9OwoKCUV2ZW50RW1pdHRlci5saXN0ZW5lckNvdW50ID0gZnVuY3Rpb24oZW1pdHRlciwgdHlwZSkgewoJICB2YXIgcmV0OwoJICBpZiAoIWVtaXR0ZXIuX2V2ZW50cyB8fCAhZW1pdHRlci5fZXZlbnRzW3R5cGVdKQoJICAgIHJldCA9IDA7CgkgIGVsc2UgaWYgKGlzRnVuY3Rpb24oZW1pdHRlci5fZXZlbnRzW3R5cGVdKSkKCSAgICByZXQgPSAxOwoJICBlbHNlCgkgICAgcmV0ID0gZW1pdHRlci5fZXZlbnRzW3R5cGVdLmxlbmd0aDsKCSAgcmV0dXJuIHJldDsKCX07CgoJZnVuY3Rpb24gaXNGdW5jdGlvbihhcmcpIHsKCSAgcmV0dXJuIHR5cGVvZiBhcmcgPT09ICdmdW5jdGlvbic7Cgl9CgoJZnVuY3Rpb24gaXNOdW1iZXIoYXJnKSB7CgkgIHJldHVybiB0eXBlb2YgYXJnID09PSAnbnVtYmVyJzsKCX0KCglmdW5jdGlvbiBpc09iamVjdChhcmcpIHsKCSAgcmV0dXJuIHR5cGVvZiBhcmcgPT09ICdvYmplY3QnICYmIGFyZyAhPT0gbnVsbDsKCX0KCglmdW5jdGlvbiBpc1VuZGVmaW5lZChhcmcpIHsKCSAgcmV0dXJuIGFyZyA9PT0gdm9pZCAwOwoJfQoKCi8qKiovIH0KLyoqKioqKi8gXSkKfSk7Cjs=';
export default iframeBridge;
