'use strict';

// v1.0.0 taken from http://www.lactame.com/lib/iframe-bridge/HEAD/iframe-bridge.js on 2016-12-19
// Conversion to base64 with http://decodebase64.com/
// Added //# sourceURL=iframe-bridge-browser.js at the end of the file to help developer tools
const iframeBridge = 'data:application/javascript;base64,' + 'KGZ1bmN0aW9uIHdlYnBhY2tVbml2ZXJzYWxNb2R1bGVEZWZpbml0aW9uKHJvb3QsIGZhY3RvcnkpIHsKCWlmKHR5cGVvZiBleHBvcnRzID09PSAnb2JqZWN0JyAmJiB0eXBlb2YgbW9kdWxlID09PSAnb2JqZWN0JykKCQltb2R1bGUuZXhwb3J0cyA9IGZhY3RvcnkoKTsKCWVsc2UgaWYodHlwZW9mIGRlZmluZSA9PT0gJ2Z1bmN0aW9uJyAmJiBkZWZpbmUuYW1kKQoJCWRlZmluZShbXSwgZmFjdG9yeSk7CgllbHNlIGlmKHR5cGVvZiBleHBvcnRzID09PSAnb2JqZWN0JykKCQlleHBvcnRzWyJJZnJhbWVCcmlkZ2UiXSA9IGZhY3RvcnkoKTsKCWVsc2UKCQlyb290WyJJZnJhbWVCcmlkZ2UiXSA9IGZhY3RvcnkoKTsKfSkodGhpcywgZnVuY3Rpb24oKSB7CnJldHVybiAvKioqKioqLyAoZnVuY3Rpb24obW9kdWxlcykgeyAvLyB3ZWJwYWNrQm9vdHN0cmFwCi8qKioqKiovIAkvLyBUaGUgbW9kdWxlIGNhY2hlCi8qKioqKiovIAl2YXIgaW5zdGFsbGVkTW9kdWxlcyA9IHt9OwoKLyoqKioqKi8gCS8vIFRoZSByZXF1aXJlIGZ1bmN0aW9uCi8qKioqKiovIAlmdW5jdGlvbiBfX3dlYnBhY2tfcmVxdWlyZV9fKG1vZHVsZUlkKSB7CgovKioqKioqLyAJCS8vIENoZWNrIGlmIG1vZHVsZSBpcyBpbiBjYWNoZQovKioqKioqLyAJCWlmKGluc3RhbGxlZE1vZHVsZXNbbW9kdWxlSWRdKQovKioqKioqLyAJCQlyZXR1cm4gaW5zdGFsbGVkTW9kdWxlc1ttb2R1bGVJZF0uZXhwb3J0czsKCi8qKioqKiovIAkJLy8gQ3JlYXRlIGEgbmV3IG1vZHVsZSAoYW5kIHB1dCBpdCBpbnRvIHRoZSBjYWNoZSkKLyoqKioqKi8gCQl2YXIgbW9kdWxlID0gaW5zdGFsbGVkTW9kdWxlc1ttb2R1bGVJZF0gPSB7Ci8qKioqKiovIAkJCWV4cG9ydHM6IHt9LAovKioqKioqLyAJCQlpZDogbW9kdWxlSWQsCi8qKioqKiovIAkJCWxvYWRlZDogZmFsc2UKLyoqKioqKi8gCQl9OwoKLyoqKioqKi8gCQkvLyBFeGVjdXRlIHRoZSBtb2R1bGUgZnVuY3Rpb24KLyoqKioqKi8gCQltb2R1bGVzW21vZHVsZUlkXS5jYWxsKG1vZHVsZS5leHBvcnRzLCBtb2R1bGUsIG1vZHVsZS5leHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKTsKCi8qKioqKiovIAkJLy8gRmxhZyB0aGUgbW9kdWxlIGFzIGxvYWRlZAovKioqKioqLyAJCW1vZHVsZS5sb2FkZWQgPSB0cnVlOwoKLyoqKioqKi8gCQkvLyBSZXR1cm4gdGhlIGV4cG9ydHMgb2YgdGhlIG1vZHVsZQovKioqKioqLyAJCXJldHVybiBtb2R1bGUuZXhwb3J0czsKLyoqKioqKi8gCX0KCgovKioqKioqLyAJLy8gZXhwb3NlIHRoZSBtb2R1bGVzIG9iamVjdCAoX193ZWJwYWNrX21vZHVsZXNfXykKLyoqKioqKi8gCV9fd2VicGFja19yZXF1aXJlX18ubSA9IG1vZHVsZXM7CgovKioqKioqLyAJLy8gZXhwb3NlIHRoZSBtb2R1bGUgY2FjaGUKLyoqKioqKi8gCV9fd2VicGFja19yZXF1aXJlX18uYyA9IGluc3RhbGxlZE1vZHVsZXM7CgovKioqKioqLyAJLy8gX193ZWJwYWNrX3B1YmxpY19wYXRoX18KLyoqKioqKi8gCV9fd2VicGFja19yZXF1aXJlX18ucCA9ICIiOwoKLyoqKioqKi8gCS8vIExvYWQgZW50cnkgbW9kdWxlIGFuZCByZXR1cm4gZXhwb3J0cwovKioqKioqLyAJcmV0dXJuIF9fd2VicGFja19yZXF1aXJlX18oMCk7Ci8qKioqKiovIH0pCi8qKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKiovCi8qKioqKiovIChbCi8qIDAgKi8KLyoqKi8gZnVuY3Rpb24obW9kdWxlLCBleHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKSB7CgoJJ3VzZSBzdHJpY3QnOwoKCXZhciBEZWJ1ZyA9IF9fd2VicGFja19yZXF1aXJlX18oMSk7Cgl3aW5kb3cuRGVidWcgPSBEZWJ1ZzsKCgl2YXIgZGVidWcgPSBEZWJ1ZygnaWZyYW1lLWJyaWRnZTppZnJhbWUnKTsKCXZhciBNZXNzYWdlSGFuZGxlciA9IF9fd2VicGFja19yZXF1aXJlX18oNCk7CgoJdmFyIG1lc3NhZ2VIYW5kbGVyID0gbmV3IE1lc3NhZ2VIYW5kbGVyKCk7CgoJbWVzc2FnZUhhbmRsZXIuaW5pdCh3aW5kb3cucGFyZW50KTsKCXdpbmRvdy5hZGRFdmVudExpc3RlbmVyKCdtZXNzYWdlJywgZnVuY3Rpb24gKGV2ZW50KSB7CgkgICAgdHJ5IHsKCSAgICAgICAgdmFyIGRhdGEgPSBKU09OLnBhcnNlKGV2ZW50LmRhdGEpOwoJICAgICAgICBkZWJ1ZygnbWVzc2FnZSByZWNlaXZlZCcsIGRhdGEpOwoJICAgICAgICBtZXNzYWdlSGFuZGxlci5oYW5kbGVNZXNzYWdlKGRhdGEpOwoJICAgIH0gY2F0Y2ggKGUpIHt9Cgl9KTsKCglleHBvcnRzLnBvc3RNZXNzYWdlID0gZnVuY3Rpb24gKHR5cGUsIG1lc3NhZ2UpIHsKCSAgICByZXR1cm4gbWVzc2FnZUhhbmRsZXIucG9zdE1lc3NhZ2UodHlwZSwgbWVzc2FnZSk7Cgl9OwoKCWV4cG9ydHMub25NZXNzYWdlID0gZnVuY3Rpb24gKGNiKSB7CgkgICAgbWVzc2FnZUhhbmRsZXIub24oJ21lc3NhZ2UnLCBjYik7Cgl9OwoKCWV4cG9ydHMucmVhZHkgPSBmdW5jdGlvbiAoKSB7CgkgICAgbWVzc2FnZUhhbmRsZXIuaGFuZGxlUGVuZGluZ01lc3NhZ2VzKCk7Cgl9OwoKLyoqKi8gfSwKLyogMSAqLwovKioqLyBmdW5jdGlvbihtb2R1bGUsIGV4cG9ydHMsIF9fd2VicGFja19yZXF1aXJlX18pIHsKCgkKCS8qKgoJICogVGhpcyBpcyB0aGUgd2ViIGJyb3dzZXIgaW1wbGVtZW50YXRpb24gb2YgYGRlYnVnKClgLgoJICoKCSAqIEV4cG9zZSBgZGVidWcoKWAgYXMgdGhlIG1vZHVsZS4KCSAqLwoKCWV4cG9ydHMgPSBtb2R1bGUuZXhwb3J0cyA9IF9fd2VicGFja19yZXF1aXJlX18oMik7CglleHBvcnRzLmxvZyA9IGxvZzsKCWV4cG9ydHMuZm9ybWF0QXJncyA9IGZvcm1hdEFyZ3M7CglleHBvcnRzLnNhdmUgPSBzYXZlOwoJZXhwb3J0cy5sb2FkID0gbG9hZDsKCWV4cG9ydHMudXNlQ29sb3JzID0gdXNlQ29sb3JzOwoJZXhwb3J0cy5zdG9yYWdlID0gJ3VuZGVmaW5lZCcgIT0gdHlwZW9mIGNocm9tZQoJICAgICAgICAgICAgICAgJiYgJ3VuZGVmaW5lZCcgIT0gdHlwZW9mIGNocm9tZS5zdG9yYWdlCgkgICAgICAgICAgICAgICAgICA/IGNocm9tZS5zdG9yYWdlLmxvY2FsCgkgICAgICAgICAgICAgICAgICA6IGxvY2Fsc3RvcmFnZSgpOwoKCS8qKgoJICogQ29sb3JzLgoJICovCgoJZXhwb3J0cy5jb2xvcnMgPSBbCgkgICdsaWdodHNlYWdyZWVuJywKCSAgJ2ZvcmVzdGdyZWVuJywKCSAgJ2dvbGRlbnJvZCcsCgkgICdkb2RnZXJibHVlJywKCSAgJ2RhcmtvcmNoaWQnLAoJICAnY3JpbXNvbicKCV07CgoJLyoqCgkgKiBDdXJyZW50bHkgb25seSBXZWJLaXQtYmFzZWQgV2ViIEluc3BlY3RvcnMsIEZpcmVmb3ggPj0gdjMxLAoJICogYW5kIHRoZSBGaXJlYnVnIGV4dGVuc2lvbiAoYW55IEZpcmVmb3ggdmVyc2lvbikgYXJlIGtub3duCgkgKiB0byBzdXBwb3J0ICIlYyIgQ1NTIGN1c3RvbWl6YXRpb25zLgoJICoKCSAqIFRPRE86IGFkZCBhIGBsb2NhbFN0b3JhZ2VgIHZhcmlhYmxlIHRvIGV4cGxpY2l0bHkgZW5hYmxlL2Rpc2FibGUgY29sb3JzCgkgKi8KCglmdW5jdGlvbiB1c2VDb2xvcnMoKSB7CgkgIC8vIGlzIHdlYmtpdD8gaHR0cDovL3N0YWNrb3ZlcmZsb3cuY29tL2EvMTY0NTk2MDYvMzc2NzczCgkgIHJldHVybiAoJ1dlYmtpdEFwcGVhcmFuY2UnIGluIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5zdHlsZSkgfHwKCSAgICAvLyBpcyBmaXJlYnVnPyBodHRwOi8vc3RhY2tvdmVyZmxvdy5jb20vYS8zOTgxMjAvMzc2NzczCgkgICAgKHdpbmRvdy5jb25zb2xlICYmIChjb25zb2xlLmZpcmVidWcgfHwgKGNvbnNvbGUuZXhjZXB0aW9uICYmIGNvbnNvbGUudGFibGUpKSkgfHwKCSAgICAvLyBpcyBmaXJlZm94ID49IHYzMT8KCSAgICAvLyBodHRwczovL2RldmVsb3Blci5tb3ppbGxhLm9yZy9lbi1VUy9kb2NzL1Rvb2xzL1dlYl9Db25zb2xlI1N0eWxpbmdfbWVzc2FnZXMKCSAgICAobmF2aWdhdG9yLnVzZXJBZ2VudC50b0xvd2VyQ2FzZSgpLm1hdGNoKC9maXJlZm94XC8oXGQrKS8pICYmIHBhcnNlSW50KFJlZ0V4cC4kMSwgMTApID49IDMxKTsKCX0KCgkvKioKCSAqIE1hcCAlaiB0byBgSlNPTi5zdHJpbmdpZnkoKWAsIHNpbmNlIG5vIFdlYiBJbnNwZWN0b3JzIGRvIHRoYXQgYnkgZGVmYXVsdC4KCSAqLwoKCWV4cG9ydHMuZm9ybWF0dGVycy5qID0gZnVuY3Rpb24odikgewoJICByZXR1cm4gSlNPTi5zdHJpbmdpZnkodik7Cgl9OwoKCgkvKioKCSAqIENvbG9yaXplIGxvZyBhcmd1bWVudHMgaWYgZW5hYmxlZC4KCSAqCgkgKiBAYXBpIHB1YmxpYwoJICovCgoJZnVuY3Rpb24gZm9ybWF0QXJncygpIHsKCSAgdmFyIGFyZ3MgPSBhcmd1bWVudHM7CgkgIHZhciB1c2VDb2xvcnMgPSB0aGlzLnVzZUNvbG9yczsKCgkgIGFyZ3NbMF0gPSAodXNlQ29sb3JzID8gJyVjJyA6ICcnKQoJICAgICsgdGhpcy5uYW1lc3BhY2UKCSAgICArICh1c2VDb2xvcnMgPyAnICVjJyA6ICcgJykKCSAgICArIGFyZ3NbMF0KCSAgICArICh1c2VDb2xvcnMgPyAnJWMgJyA6ICcgJykKCSAgICArICcrJyArIGV4cG9ydHMuaHVtYW5pemUodGhpcy5kaWZmKTsKCgkgIGlmICghdXNlQ29sb3JzKSByZXR1cm4gYXJnczsKCgkgIHZhciBjID0gJ2NvbG9yOiAnICsgdGhpcy5jb2xvcjsKCSAgYXJncyA9IFthcmdzWzBdLCBjLCAnY29sb3I6IGluaGVyaXQnXS5jb25jYXQoQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJncywgMSkpOwoKCSAgLy8gdGhlIGZpbmFsICIlYyIgaXMgc29tZXdoYXQgdHJpY2t5LCBiZWNhdXNlIHRoZXJlIGNvdWxkIGJlIG90aGVyCgkgIC8vIGFyZ3VtZW50cyBwYXNzZWQgZWl0aGVyIGJlZm9yZSBvciBhZnRlciB0aGUgJWMsIHNvIHdlIG5lZWQgdG8KCSAgLy8gZmlndXJlIG91dCB0aGUgY29ycmVjdCBpbmRleCB0byBpbnNlcnQgdGhlIENTUyBpbnRvCgkgIHZhciBpbmRleCA9IDA7CgkgIHZhciBsYXN0QyA9IDA7CgkgIGFyZ3NbMF0ucmVwbGFjZSgvJVthLXolXS9nLCBmdW5jdGlvbihtYXRjaCkgewoJICAgIGlmICgnJSUnID09PSBtYXRjaCkgcmV0dXJuOwoJICAgIGluZGV4Kys7CgkgICAgaWYgKCclYycgPT09IG1hdGNoKSB7CgkgICAgICAvLyB3ZSBvbmx5IGFyZSBpbnRlcmVzdGVkIGluIHRoZSAqbGFzdCogJWMKCSAgICAgIC8vICh0aGUgdXNlciBtYXkgaGF2ZSBwcm92aWRlZCB0aGVpciBvd24pCgkgICAgICBsYXN0QyA9IGluZGV4OwoJICAgIH0KCSAgfSk7CgoJICBhcmdzLnNwbGljZShsYXN0QywgMCwgYyk7CgkgIHJldHVybiBhcmdzOwoJfQoKCS8qKgoJICogSW52b2tlcyBgY29uc29sZS5sb2coKWAgd2hlbiBhdmFpbGFibGUuCgkgKiBOby1vcCB3aGVuIGBjb25zb2xlLmxvZ2AgaXMgbm90IGEgImZ1bmN0aW9uIi4KCSAqCgkgKiBAYXBpIHB1YmxpYwoJICovCgoJZnVuY3Rpb24gbG9nKCkgewoJICAvLyB0aGlzIGhhY2tlcnkgaXMgcmVxdWlyZWQgZm9yIElFOC85LCB3aGVyZQoJICAvLyB0aGUgYGNvbnNvbGUubG9nYCBmdW5jdGlvbiBkb2Vzbid0IGhhdmUgJ2FwcGx5JwoJICByZXR1cm4gJ29iamVjdCcgPT09IHR5cGVvZiBjb25zb2xlCgkgICAgJiYgY29uc29sZS5sb2cKCSAgICAmJiBGdW5jdGlvbi5wcm90b3R5cGUuYXBwbHkuY2FsbChjb25zb2xlLmxvZywgY29uc29sZSwgYXJndW1lbnRzKTsKCX0KCgkvKioKCSAqIFNhdmUgYG5hbWVzcGFjZXNgLgoJICoKCSAqIEBwYXJhbSB7U3RyaW5nfSBuYW1lc3BhY2VzCgkgKiBAYXBpIHByaXZhdGUKCSAqLwoKCWZ1bmN0aW9uIHNhdmUobmFtZXNwYWNlcykgewoJICB0cnkgewoJICAgIGlmIChudWxsID09IG5hbWVzcGFjZXMpIHsKCSAgICAgIGV4cG9ydHMuc3RvcmFnZS5yZW1vdmVJdGVtKCdkZWJ1ZycpOwoJICAgIH0gZWxzZSB7CgkgICAgICBleHBvcnRzLnN0b3JhZ2UuZGVidWcgPSBuYW1lc3BhY2VzOwoJICAgIH0KCSAgfSBjYXRjaChlKSB7fQoJfQoKCS8qKgoJICogTG9hZCBgbmFtZXNwYWNlc2AuCgkgKgoJICogQHJldHVybiB7U3RyaW5nfSByZXR1cm5zIHRoZSBwcmV2aW91c2x5IHBlcnNpc3RlZCBkZWJ1ZyBtb2RlcwoJICogQGFwaSBwcml2YXRlCgkgKi8KCglmdW5jdGlvbiBsb2FkKCkgewoJICB2YXIgcjsKCSAgdHJ5IHsKCSAgICByID0gZXhwb3J0cy5zdG9yYWdlLmRlYnVnOwoJICB9IGNhdGNoKGUpIHt9CgkgIHJldHVybiByOwoJfQoKCS8qKgoJICogRW5hYmxlIG5hbWVzcGFjZXMgbGlzdGVkIGluIGBsb2NhbFN0b3JhZ2UuZGVidWdgIGluaXRpYWxseS4KCSAqLwoKCWV4cG9ydHMuZW5hYmxlKGxvYWQoKSk7CgoJLyoqCgkgKiBMb2NhbHN0b3JhZ2UgYXR0ZW1wdHMgdG8gcmV0dXJuIHRoZSBsb2NhbHN0b3JhZ2UuCgkgKgoJICogVGhpcyBpcyBuZWNlc3NhcnkgYmVjYXVzZSBzYWZhcmkgdGhyb3dzCgkgKiB3aGVuIGEgdXNlciBkaXNhYmxlcyBjb29raWVzL2xvY2Fsc3RvcmFnZQoJICogYW5kIHlvdSBhdHRlbXB0IHRvIGFjY2VzcyBpdC4KCSAqCgkgKiBAcmV0dXJuIHtMb2NhbFN0b3JhZ2V9CgkgKiBAYXBpIHByaXZhdGUKCSAqLwoKCWZ1bmN0aW9uIGxvY2Fsc3RvcmFnZSgpewoJICB0cnkgewoJICAgIHJldHVybiB3aW5kb3cubG9jYWxTdG9yYWdlOwoJICB9IGNhdGNoIChlKSB7fQoJfQoKCi8qKiovIH0sCi8qIDIgKi8KLyoqKi8gZnVuY3Rpb24obW9kdWxlLCBleHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKSB7CgoJCgkvKioKCSAqIFRoaXMgaXMgdGhlIGNvbW1vbiBsb2dpYyBmb3IgYm90aCB0aGUgTm9kZS5qcyBhbmQgd2ViIGJyb3dzZXIKCSAqIGltcGxlbWVudGF0aW9ucyBvZiBgZGVidWcoKWAuCgkgKgoJICogRXhwb3NlIGBkZWJ1ZygpYCBhcyB0aGUgbW9kdWxlLgoJICovCgoJZXhwb3J0cyA9IG1vZHVsZS5leHBvcnRzID0gZGVidWc7CglleHBvcnRzLmNvZXJjZSA9IGNvZXJjZTsKCWV4cG9ydHMuZGlzYWJsZSA9IGRpc2FibGU7CglleHBvcnRzLmVuYWJsZSA9IGVuYWJsZTsKCWV4cG9ydHMuZW5hYmxlZCA9IGVuYWJsZWQ7CglleHBvcnRzLmh1bWFuaXplID0gX193ZWJwYWNrX3JlcXVpcmVfXygzKTsKCgkvKioKCSAqIFRoZSBjdXJyZW50bHkgYWN0aXZlIGRlYnVnIG1vZGUgbmFtZXMsIGFuZCBuYW1lcyB0byBza2lwLgoJICovCgoJZXhwb3J0cy5uYW1lcyA9IFtdOwoJZXhwb3J0cy5za2lwcyA9IFtdOwoKCS8qKgoJICogTWFwIG9mIHNwZWNpYWwgIiVuIiBoYW5kbGluZyBmdW5jdGlvbnMsIGZvciB0aGUgZGVidWcgImZvcm1hdCIgYXJndW1lbnQuCgkgKgoJICogVmFsaWQga2V5IG5hbWVzIGFyZSBhIHNpbmdsZSwgbG93ZXJjYXNlZCBsZXR0ZXIsIGkuZS4gIm4iLgoJICovCgoJZXhwb3J0cy5mb3JtYXR0ZXJzID0ge307CgoJLyoqCgkgKiBQcmV2aW91c2x5IGFzc2lnbmVkIGNvbG9yLgoJICovCgoJdmFyIHByZXZDb2xvciA9IDA7CgoJLyoqCgkgKiBQcmV2aW91cyBsb2cgdGltZXN0YW1wLgoJICovCgoJdmFyIHByZXZUaW1lOwoKCS8qKgoJICogU2VsZWN0IGEgY29sb3IuCgkgKgoJICogQHJldHVybiB7TnVtYmVyfQoJICogQGFwaSBwcml2YXRlCgkgKi8KCglmdW5jdGlvbiBzZWxlY3RDb2xvcigpIHsKCSAgcmV0dXJuIGV4cG9ydHMuY29sb3JzW3ByZXZDb2xvcisrICUgZXhwb3J0cy5jb2xvcnMubGVuZ3RoXTsKCX0KCgkvKioKCSAqIENyZWF0ZSBhIGRlYnVnZ2VyIHdpdGggdGhlIGdpdmVuIGBuYW1lc3BhY2VgLgoJICoKCSAqIEBwYXJhbSB7U3RyaW5nfSBuYW1lc3BhY2UKCSAqIEByZXR1cm4ge0Z1bmN0aW9ufQoJICogQGFwaSBwdWJsaWMKCSAqLwoKCWZ1bmN0aW9uIGRlYnVnKG5hbWVzcGFjZSkgewoKCSAgLy8gZGVmaW5lIHRoZSBgZGlzYWJsZWRgIHZlcnNpb24KCSAgZnVuY3Rpb24gZGlzYWJsZWQoKSB7CgkgIH0KCSAgZGlzYWJsZWQuZW5hYmxlZCA9IGZhbHNlOwoKCSAgLy8gZGVmaW5lIHRoZSBgZW5hYmxlZGAgdmVyc2lvbgoJICBmdW5jdGlvbiBlbmFibGVkKCkgewoKCSAgICB2YXIgc2VsZiA9IGVuYWJsZWQ7CgoJICAgIC8vIHNldCBgZGlmZmAgdGltZXN0YW1wCgkgICAgdmFyIGN1cnIgPSArbmV3IERhdGUoKTsKCSAgICB2YXIgbXMgPSBjdXJyIC0gKHByZXZUaW1lIHx8IGN1cnIpOwoJICAgIHNlbGYuZGlmZiA9IG1zOwoJICAgIHNlbGYucHJldiA9IHByZXZUaW1lOwoJICAgIHNlbGYuY3VyciA9IGN1cnI7CgkgICAgcHJldlRpbWUgPSBjdXJyOwoKCSAgICAvLyBhZGQgdGhlIGBjb2xvcmAgaWYgbm90IHNldAoJICAgIGlmIChudWxsID09IHNlbGYudXNlQ29sb3JzKSBzZWxmLnVzZUNvbG9ycyA9IGV4cG9ydHMudXNlQ29sb3JzKCk7CgkgICAgaWYgKG51bGwgPT0gc2VsZi5jb2xvciAmJiBzZWxmLnVzZUNvbG9ycykgc2VsZi5jb2xvciA9IHNlbGVjdENvbG9yKCk7CgoJICAgIHZhciBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzKTsKCgkgICAgYXJnc1swXSA9IGV4cG9ydHMuY29lcmNlKGFyZ3NbMF0pOwoKCSAgICBpZiAoJ3N0cmluZycgIT09IHR5cGVvZiBhcmdzWzBdKSB7CgkgICAgICAvLyBhbnl0aGluZyBlbHNlIGxldCdzIGluc3BlY3Qgd2l0aCAlbwoJICAgICAgYXJncyA9IFsnJW8nXS5jb25jYXQoYXJncyk7CgkgICAgfQoKCSAgICAvLyBhcHBseSBhbnkgYGZvcm1hdHRlcnNgIHRyYW5zZm9ybWF0aW9ucwoJICAgIHZhciBpbmRleCA9IDA7CgkgICAgYXJnc1swXSA9IGFyZ3NbMF0ucmVwbGFjZSgvJShbYS16JV0pL2csIGZ1bmN0aW9uKG1hdGNoLCBmb3JtYXQpIHsKCSAgICAgIC8vIGlmIHdlIGVuY291bnRlciBhbiBlc2NhcGVkICUgdGhlbiBkb24ndCBpbmNyZWFzZSB0aGUgYXJyYXkgaW5kZXgKCSAgICAgIGlmIChtYXRjaCA9PT0gJyUlJykgcmV0dXJuIG1hdGNoOwoJICAgICAgaW5kZXgrKzsKCSAgICAgIHZhciBmb3JtYXR0ZXIgPSBleHBvcnRzLmZvcm1hdHRlcnNbZm9ybWF0XTsKCSAgICAgIGlmICgnZnVuY3Rpb24nID09PSB0eXBlb2YgZm9ybWF0dGVyKSB7CgkgICAgICAgIHZhciB2YWwgPSBhcmdzW2luZGV4XTsKCSAgICAgICAgbWF0Y2ggPSBmb3JtYXR0ZXIuY2FsbChzZWxmLCB2YWwpOwoKCSAgICAgICAgLy8gbm93IHdlIG5lZWQgdG8gcmVtb3ZlIGBhcmdzW2luZGV4XWAgc2luY2UgaXQncyBpbmxpbmVkIGluIHRoZSBgZm9ybWF0YAoJICAgICAgICBhcmdzLnNwbGljZShpbmRleCwgMSk7CgkgICAgICAgIGluZGV4LS07CgkgICAgICB9CgkgICAgICByZXR1cm4gbWF0Y2g7CgkgICAgfSk7CgoJICAgIGlmICgnZnVuY3Rpb24nID09PSB0eXBlb2YgZXhwb3J0cy5mb3JtYXRBcmdzKSB7CgkgICAgICBhcmdzID0gZXhwb3J0cy5mb3JtYXRBcmdzLmFwcGx5KHNlbGYsIGFyZ3MpOwoJICAgIH0KCSAgICB2YXIgbG9nRm4gPSBlbmFibGVkLmxvZyB8fCBleHBvcnRzLmxvZyB8fCBjb25zb2xlLmxvZy5iaW5kKGNvbnNvbGUpOwoJICAgIGxvZ0ZuLmFwcGx5KHNlbGYsIGFyZ3MpOwoJICB9CgkgIGVuYWJsZWQuZW5hYmxlZCA9IHRydWU7CgoJICB2YXIgZm4gPSBleHBvcnRzLmVuYWJsZWQobmFtZXNwYWNlKSA/IGVuYWJsZWQgOiBkaXNhYmxlZDsKCgkgIGZuLm5hbWVzcGFjZSA9IG5hbWVzcGFjZTsKCgkgIHJldHVybiBmbjsKCX0KCgkvKioKCSAqIEVuYWJsZXMgYSBkZWJ1ZyBtb2RlIGJ5IG5hbWVzcGFjZXMuIFRoaXMgY2FuIGluY2x1ZGUgbW9kZXMKCSAqIHNlcGFyYXRlZCBieSBhIGNvbG9uIGFuZCB3aWxkY2FyZHMuCgkgKgoJICogQHBhcmFtIHtTdHJpbmd9IG5hbWVzcGFjZXMKCSAqIEBhcGkgcHVibGljCgkgKi8KCglmdW5jdGlvbiBlbmFibGUobmFtZXNwYWNlcykgewoJICBleHBvcnRzLnNhdmUobmFtZXNwYWNlcyk7CgoJICB2YXIgc3BsaXQgPSAobmFtZXNwYWNlcyB8fCAnJykuc3BsaXQoL1tccyxdKy8pOwoJICB2YXIgbGVuID0gc3BsaXQubGVuZ3RoOwoKCSAgZm9yICh2YXIgaSA9IDA7IGkgPCBsZW47IGkrKykgewoJICAgIGlmICghc3BsaXRbaV0pIGNvbnRpbnVlOyAvLyBpZ25vcmUgZW1wdHkgc3RyaW5ncwoJICAgIG5hbWVzcGFjZXMgPSBzcGxpdFtpXS5yZXBsYWNlKC9cKi9nLCAnLio/Jyk7CgkgICAgaWYgKG5hbWVzcGFjZXNbMF0gPT09ICctJykgewoJICAgICAgZXhwb3J0cy5za2lwcy5wdXNoKG5ldyBSZWdFeHAoJ14nICsgbmFtZXNwYWNlcy5zdWJzdHIoMSkgKyAnJCcpKTsKCSAgICB9IGVsc2UgewoJICAgICAgZXhwb3J0cy5uYW1lcy5wdXNoKG5ldyBSZWdFeHAoJ14nICsgbmFtZXNwYWNlcyArICckJykpOwoJICAgIH0KCSAgfQoJfQoKCS8qKgoJICogRGlzYWJsZSBkZWJ1ZyBvdXRwdXQuCgkgKgoJICogQGFwaSBwdWJsaWMKCSAqLwoKCWZ1bmN0aW9uIGRpc2FibGUoKSB7CgkgIGV4cG9ydHMuZW5hYmxlKCcnKTsKCX0KCgkvKioKCSAqIFJldHVybnMgdHJ1ZSBpZiB0aGUgZ2l2ZW4gbW9kZSBuYW1lIGlzIGVuYWJsZWQsIGZhbHNlIG90aGVyd2lzZS4KCSAqCgkgKiBAcGFyYW0ge1N0cmluZ30gbmFtZQoJICogQHJldHVybiB7Qm9vbGVhbn0KCSAqIEBhcGkgcHVibGljCgkgKi8KCglmdW5jdGlvbiBlbmFibGVkKG5hbWUpIHsKCSAgdmFyIGksIGxlbjsKCSAgZm9yIChpID0gMCwgbGVuID0gZXhwb3J0cy5za2lwcy5sZW5ndGg7IGkgPCBsZW47IGkrKykgewoJICAgIGlmIChleHBvcnRzLnNraXBzW2ldLnRlc3QobmFtZSkpIHsKCSAgICAgIHJldHVybiBmYWxzZTsKCSAgICB9CgkgIH0KCSAgZm9yIChpID0gMCwgbGVuID0gZXhwb3J0cy5uYW1lcy5sZW5ndGg7IGkgPCBsZW47IGkrKykgewoJICAgIGlmIChleHBvcnRzLm5hbWVzW2ldLnRlc3QobmFtZSkpIHsKCSAgICAgIHJldHVybiB0cnVlOwoJICAgIH0KCSAgfQoJICByZXR1cm4gZmFsc2U7Cgl9CgoJLyoqCgkgKiBDb2VyY2UgYHZhbGAuCgkgKgoJICogQHBhcmFtIHtNaXhlZH0gdmFsCgkgKiBAcmV0dXJuIHtNaXhlZH0KCSAqIEBhcGkgcHJpdmF0ZQoJICovCgoJZnVuY3Rpb24gY29lcmNlKHZhbCkgewoJICBpZiAodmFsIGluc3RhbmNlb2YgRXJyb3IpIHJldHVybiB2YWwuc3RhY2sgfHwgdmFsLm1lc3NhZ2U7CgkgIHJldHVybiB2YWw7Cgl9CgoKLyoqKi8gfSwKLyogMyAqLwovKioqLyBmdW5jdGlvbihtb2R1bGUsIGV4cG9ydHMpIHsKCgkvKioKCSAqIEhlbHBlcnMuCgkgKi8KCgl2YXIgcyA9IDEwMDA7Cgl2YXIgbSA9IHMgKiA2MDsKCXZhciBoID0gbSAqIDYwOwoJdmFyIGQgPSBoICogMjQ7Cgl2YXIgeSA9IGQgKiAzNjUuMjU7CgoJLyoqCgkgKiBQYXJzZSBvciBmb3JtYXQgdGhlIGdpdmVuIGB2YWxgLgoJICoKCSAqIE9wdGlvbnM6CgkgKgoJICogIC0gYGxvbmdgIHZlcmJvc2UgZm9ybWF0dGluZyBbZmFsc2VdCgkgKgoJICogQHBhcmFtIHtTdHJpbmd8TnVtYmVyfSB2YWwKCSAqIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zCgkgKiBAcmV0dXJuIHtTdHJpbmd8TnVtYmVyfQoJICogQGFwaSBwdWJsaWMKCSAqLwoKCW1vZHVsZS5leHBvcnRzID0gZnVuY3Rpb24odmFsLCBvcHRpb25zKXsKCSAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307CgkgIGlmICgnc3RyaW5nJyA9PSB0eXBlb2YgdmFsKSByZXR1cm4gcGFyc2UodmFsKTsKCSAgcmV0dXJuIG9wdGlvbnMubG9uZwoJICAgID8gbG9uZyh2YWwpCgkgICAgOiBzaG9ydCh2YWwpOwoJfTsKCgkvKioKCSAqIFBhcnNlIHRoZSBnaXZlbiBgc3RyYCBhbmQgcmV0dXJuIG1pbGxpc2Vjb25kcy4KCSAqCgkgKiBAcGFyYW0ge1N0cmluZ30gc3RyCgkgKiBAcmV0dXJuIHtOdW1iZXJ9CgkgKiBAYXBpIHByaXZhdGUKCSAqLwoKCWZ1bmN0aW9uIHBhcnNlKHN0cikgewoJICBzdHIgPSAnJyArIHN0cjsKCSAgaWYgKHN0ci5sZW5ndGggPiAxMDAwMCkgcmV0dXJuOwoJICB2YXIgbWF0Y2ggPSAvXigoPzpcZCspP1wuP1xkKykgKihtaWxsaXNlY29uZHM/fG1zZWNzP3xtc3xzZWNvbmRzP3xzZWNzP3xzfG1pbnV0ZXM/fG1pbnM/fG18aG91cnM/fGhycz98aHxkYXlzP3xkfHllYXJzP3x5cnM/fHkpPyQvaS5leGVjKHN0cik7CgkgIGlmICghbWF0Y2gpIHJldHVybjsKCSAgdmFyIG4gPSBwYXJzZUZsb2F0KG1hdGNoWzFdKTsKCSAgdmFyIHR5cGUgPSAobWF0Y2hbMl0gfHwgJ21zJykudG9Mb3dlckNhc2UoKTsKCSAgc3dpdGNoICh0eXBlKSB7CgkgICAgY2FzZSAneWVhcnMnOgoJICAgIGNhc2UgJ3llYXInOgoJICAgIGNhc2UgJ3lycyc6CgkgICAgY2FzZSAneXInOgoJICAgIGNhc2UgJ3knOgoJICAgICAgcmV0dXJuIG4gKiB5OwoJICAgIGNhc2UgJ2RheXMnOgoJICAgIGNhc2UgJ2RheSc6CgkgICAgY2FzZSAnZCc6CgkgICAgICByZXR1cm4gbiAqIGQ7CgkgICAgY2FzZSAnaG91cnMnOgoJICAgIGNhc2UgJ2hvdXInOgoJICAgIGNhc2UgJ2hycyc6CgkgICAgY2FzZSAnaHInOgoJICAgIGNhc2UgJ2gnOgoJICAgICAgcmV0dXJuIG4gKiBoOwoJICAgIGNhc2UgJ21pbnV0ZXMnOgoJICAgIGNhc2UgJ21pbnV0ZSc6CgkgICAgY2FzZSAnbWlucyc6CgkgICAgY2FzZSAnbWluJzoKCSAgICBjYXNlICdtJzoKCSAgICAgIHJldHVybiBuICogbTsKCSAgICBjYXNlICdzZWNvbmRzJzoKCSAgICBjYXNlICdzZWNvbmQnOgoJICAgIGNhc2UgJ3NlY3MnOgoJICAgIGNhc2UgJ3NlYyc6CgkgICAgY2FzZSAncyc6CgkgICAgICByZXR1cm4gbiAqIHM7CgkgICAgY2FzZSAnbWlsbGlzZWNvbmRzJzoKCSAgICBjYXNlICdtaWxsaXNlY29uZCc6CgkgICAgY2FzZSAnbXNlY3MnOgoJICAgIGNhc2UgJ21zZWMnOgoJICAgIGNhc2UgJ21zJzoKCSAgICAgIHJldHVybiBuOwoJICB9Cgl9CgoJLyoqCgkgKiBTaG9ydCBmb3JtYXQgZm9yIGBtc2AuCgkgKgoJICogQHBhcmFtIHtOdW1iZXJ9IG1zCgkgKiBAcmV0dXJuIHtTdHJpbmd9CgkgKiBAYXBpIHByaXZhdGUKCSAqLwoKCWZ1bmN0aW9uIHNob3J0KG1zKSB7CgkgIGlmIChtcyA+PSBkKSByZXR1cm4gTWF0aC5yb3VuZChtcyAvIGQpICsgJ2QnOwoJICBpZiAobXMgPj0gaCkgcmV0dXJuIE1hdGgucm91bmQobXMgLyBoKSArICdoJzsKCSAgaWYgKG1zID49IG0pIHJldHVybiBNYXRoLnJvdW5kKG1zIC8gbSkgKyAnbSc7CgkgIGlmIChtcyA+PSBzKSByZXR1cm4gTWF0aC5yb3VuZChtcyAvIHMpICsgJ3MnOwoJICByZXR1cm4gbXMgKyAnbXMnOwoJfQoKCS8qKgoJICogTG9uZyBmb3JtYXQgZm9yIGBtc2AuCgkgKgoJICogQHBhcmFtIHtOdW1iZXJ9IG1zCgkgKiBAcmV0dXJuIHtTdHJpbmd9CgkgKiBAYXBpIHByaXZhdGUKCSAqLwoKCWZ1bmN0aW9uIGxvbmcobXMpIHsKCSAgcmV0dXJuIHBsdXJhbChtcywgZCwgJ2RheScpCgkgICAgfHwgcGx1cmFsKG1zLCBoLCAnaG91cicpCgkgICAgfHwgcGx1cmFsKG1zLCBtLCAnbWludXRlJykKCSAgICB8fCBwbHVyYWwobXMsIHMsICdzZWNvbmQnKQoJICAgIHx8IG1zICsgJyBtcyc7Cgl9CgoJLyoqCgkgKiBQbHVyYWxpemF0aW9uIGhlbHBlci4KCSAqLwoKCWZ1bmN0aW9uIHBsdXJhbChtcywgbiwgbmFtZSkgewoJICBpZiAobXMgPCBuKSByZXR1cm47CgkgIGlmIChtcyA8IG4gKiAxLjUpIHJldHVybiBNYXRoLmZsb29yKG1zIC8gbikgKyAnICcgKyBuYW1lOwoJICByZXR1cm4gTWF0aC5jZWlsKG1zIC8gbikgKyAnICcgKyBuYW1lICsgJ3MnOwoJfQoKCi8qKiovIH0sCi8qIDQgKi8KLyoqKi8gZnVuY3Rpb24obW9kdWxlLCBleHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKSB7CgoJJ3VzZSBzdHJpY3QnOwoKCXZhciBfY3JlYXRlQ2xhc3MgPSBmdW5jdGlvbiAoKSB7IGZ1bmN0aW9uIGRlZmluZVByb3BlcnRpZXModGFyZ2V0LCBwcm9wcykgeyBmb3IgKHZhciBpID0gMDsgaSA8IHByb3BzLmxlbmd0aDsgaSsrKSB7IHZhciBkZXNjcmlwdG9yID0gcHJvcHNbaV07IGRlc2NyaXB0b3IuZW51bWVyYWJsZSA9IGRlc2NyaXB0b3IuZW51bWVyYWJsZSB8fCBmYWxzZTsgZGVzY3JpcHRvci5jb25maWd1cmFibGUgPSB0cnVlOyBpZiAoInZhbHVlIiBpbiBkZXNjcmlwdG9yKSBkZXNjcmlwdG9yLndyaXRhYmxlID0gdHJ1ZTsgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRhcmdldCwgZGVzY3JpcHRvci5rZXksIGRlc2NyaXB0b3IpOyB9IH0gcmV0dXJuIGZ1bmN0aW9uIChDb25zdHJ1Y3RvciwgcHJvdG9Qcm9wcywgc3RhdGljUHJvcHMpIHsgaWYgKHByb3RvUHJvcHMpIGRlZmluZVByb3BlcnRpZXMoQ29uc3RydWN0b3IucHJvdG90eXBlLCBwcm90b1Byb3BzKTsgaWYgKHN0YXRpY1Byb3BzKSBkZWZpbmVQcm9wZXJ0aWVzKENvbnN0cnVjdG9yLCBzdGF0aWNQcm9wcyk7IHJldHVybiBDb25zdHJ1Y3RvcjsgfTsgfSgpOwoKCWZ1bmN0aW9uIF9jbGFzc0NhbGxDaGVjayhpbnN0YW5jZSwgQ29uc3RydWN0b3IpIHsgaWYgKCEoaW5zdGFuY2UgaW5zdGFuY2VvZiBDb25zdHJ1Y3RvcikpIHsgdGhyb3cgbmV3IFR5cGVFcnJvcigiQ2Fubm90IGNhbGwgYSBjbGFzcyBhcyBhIGZ1bmN0aW9uIik7IH0gfQoKCWZ1bmN0aW9uIF9wb3NzaWJsZUNvbnN0cnVjdG9yUmV0dXJuKHNlbGYsIGNhbGwpIHsgaWYgKCFzZWxmKSB7IHRocm93IG5ldyBSZWZlcmVuY2VFcnJvcigidGhpcyBoYXNuJ3QgYmVlbiBpbml0aWFsaXNlZCAtIHN1cGVyKCkgaGFzbid0IGJlZW4gY2FsbGVkIik7IH0gcmV0dXJuIGNhbGwgJiYgKHR5cGVvZiBjYWxsID09PSAib2JqZWN0IiB8fCB0eXBlb2YgY2FsbCA9PT0gImZ1bmN0aW9uIikgPyBjYWxsIDogc2VsZjsgfQoKCWZ1bmN0aW9uIF9pbmhlcml0cyhzdWJDbGFzcywgc3VwZXJDbGFzcykgeyBpZiAodHlwZW9mIHN1cGVyQ2xhc3MgIT09ICJmdW5jdGlvbiIgJiYgc3VwZXJDbGFzcyAhPT0gbnVsbCkgeyB0aHJvdyBuZXcgVHlwZUVycm9yKCJTdXBlciBleHByZXNzaW9uIG11c3QgZWl0aGVyIGJlIG51bGwgb3IgYSBmdW5jdGlvbiwgbm90ICIgKyB0eXBlb2Ygc3VwZXJDbGFzcyk7IH0gc3ViQ2xhc3MucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShzdXBlckNsYXNzICYmIHN1cGVyQ2xhc3MucHJvdG90eXBlLCB7IGNvbnN0cnVjdG9yOiB7IHZhbHVlOiBzdWJDbGFzcywgZW51bWVyYWJsZTogZmFsc2UsIHdyaXRhYmxlOiB0cnVlLCBjb25maWd1cmFibGU6IHRydWUgfSB9KTsgaWYgKHN1cGVyQ2xhc3MpIE9iamVjdC5zZXRQcm90b3R5cGVPZiA/IE9iamVjdC5zZXRQcm90b3R5cGVPZihzdWJDbGFzcywgc3VwZXJDbGFzcykgOiBzdWJDbGFzcy5fX3Byb3RvX18gPSBzdXBlckNsYXNzOyB9CgoJdmFyIE1lc3NhZ2UgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDUpOwoKCXZhciBFdmVudEVtaXR0ZXIgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDYpOwoKCXZhciBpZENvdW50ZXIgPSAwOwoJdmFyIHBvc3RlZE1lc3NhZ2VzID0gbmV3IE1hcCgpOwoKCXZhciBNZXNzYWdlSGFuZGxlciA9IGZ1bmN0aW9uIChfRXZlbnRFbWl0dGVyKSB7CgkgICAgX2luaGVyaXRzKE1lc3NhZ2VIYW5kbGVyLCBfRXZlbnRFbWl0dGVyKTsKCgkgICAgZnVuY3Rpb24gTWVzc2FnZUhhbmRsZXIoKSB7CgkgICAgICAgIF9jbGFzc0NhbGxDaGVjayh0aGlzLCBNZXNzYWdlSGFuZGxlcik7CgoJICAgICAgICB2YXIgX3RoaXMgPSBfcG9zc2libGVDb25zdHJ1Y3RvclJldHVybih0aGlzLCBPYmplY3QuZ2V0UHJvdG90eXBlT2YoTWVzc2FnZUhhbmRsZXIpLmNhbGwodGhpcykpOwoKCSAgICAgICAgX3RoaXMucmVhZHlUb1Bvc3QgPSBmYWxzZTsKCSAgICAgICAgX3RoaXMucmVhZHlUb0hhbmRsZSA9IGZhbHNlOwoJICAgICAgICBfdGhpcy53aW5kb3dJRCA9IG51bGw7CgkgICAgICAgIF90aGlzLm1lc3NhZ2VTb3VyY2UgPSBudWxsOwoJICAgICAgICBfdGhpcy5wZW5kaW5nTWVzc2FnZXMgPSBbXTsKCSAgICAgICAgX3RoaXMudW5oYW5kbGVkTWVzc2FnZXMgPSBbXTsKCSAgICAgICAgcmV0dXJuIF90aGlzOwoJICAgIH0KCgkgICAgX2NyZWF0ZUNsYXNzKE1lc3NhZ2VIYW5kbGVyLCBbewoJICAgICAgICBrZXk6ICdfcG9zdE1lc3NhZ2VUb1NvdXJjZScsCgkgICAgICAgIHZhbHVlOiBmdW5jdGlvbiBfcG9zdE1lc3NhZ2VUb1NvdXJjZShtZXNzYWdlKSB7CgkgICAgICAgICAgICB0aGlzLm1lc3NhZ2VTb3VyY2UucG9zdE1lc3NhZ2UoSlNPTi5zdHJpbmdpZnkobWVzc2FnZSksICcqJyk7CgkgICAgICAgIH0KCSAgICB9LCB7CgkgICAgICAgIGtleTogJ2luaXQnLAoJICAgICAgICB2YWx1ZTogZnVuY3Rpb24gaW5pdChtZXNzYWdlU291cmNlKSB7CgkgICAgICAgICAgICB2YXIgX3RoaXMyID0gdGhpczsKCgkgICAgICAgICAgICB0aGlzLnJlYWR5VG9Qb3N0ID0gdHJ1ZTsKCSAgICAgICAgICAgIHRoaXMud2luZG93SUQgPSBEYXRlLm5vdygpOwoJICAgICAgICAgICAgdGhpcy5tZXNzYWdlU291cmNlID0gbWVzc2FnZVNvdXJjZTsKCSAgICAgICAgICAgIHRoaXMuX3Bvc3RNZXNzYWdlVG9Tb3VyY2UoewoJICAgICAgICAgICAgICAgIHR5cGU6ICdhZG1pbi5jb25uZWN0JywKCSAgICAgICAgICAgICAgICB3aW5kb3dJRDogdGhpcy53aW5kb3dJRAoJICAgICAgICAgICAgfSk7CgoJICAgICAgICAgICAgd2luZG93LmFkZEV2ZW50TGlzdGVuZXIoJ3VubG9hZCcsIGZ1bmN0aW9uICgpIHsKCSAgICAgICAgICAgICAgICBfdGhpczIubWVzc2FnZVNvdXJjZS5wb3N0TWVzc2FnZSh7CgkgICAgICAgICAgICAgICAgICAgIHR5cGU6ICdhZG1pbi5kaXNjb25uZWN0JywKCSAgICAgICAgICAgICAgICAgICAgd2luZG93SUQ6IF90aGlzMi53aW5kb3dJRAoJICAgICAgICAgICAgICAgIH0sICcqJyk7CgkgICAgICAgICAgICB9KTsKCgkgICAgICAgICAgICB0aGlzLnBvc3RQZW5kaW5nTWVzc2FnZXMoKTsKCSAgICAgICAgfQoJICAgIH0sIHsKCSAgICAgICAga2V5OiAncG9zdE1lc3NhZ2UnLAoJICAgICAgICB2YWx1ZTogZnVuY3Rpb24gcG9zdE1lc3NhZ2UodHlwZSwgbWVzc2FnZSkgewoJICAgICAgICAgICAgdmFyIGlkID0gKytpZENvdW50ZXI7CgkgICAgICAgICAgICB2YXIgdG9Qb3N0ID0gewoJICAgICAgICAgICAgICAgIHR5cGU6IHR5cGUsCgkgICAgICAgICAgICAgICAgbWVzc2FnZTogbWVzc2FnZSwKCSAgICAgICAgICAgICAgICBtZXNzYWdlSUQ6IGlkLAoJICAgICAgICAgICAgICAgIHdpbmRvd0lEOiB0aGlzLndpbmRvd0lECgkgICAgICAgICAgICB9OwoJICAgICAgICAgICAgdmFyIHRoZU1lc3NhZ2UgPSBuZXcgTWVzc2FnZShpZCwgdG9Qb3N0KTsKCSAgICAgICAgICAgIGlmICh0aGlzLnJlYWR5VG9Qb3N0KSB7CgkgICAgICAgICAgICAgICAgdGhpcy5fcG9zdE1lc3NhZ2VUb1NvdXJjZSh0b1Bvc3QpOwoJICAgICAgICAgICAgICAgIHBvc3RlZE1lc3NhZ2VzLnNldChpZCwgdGhlTWVzc2FnZSk7CgkgICAgICAgICAgICB9IGVsc2UgewoJICAgICAgICAgICAgICAgIHRoaXMucGVuZGluZ01lc3NhZ2VzLnB1c2godGhlTWVzc2FnZSk7CgkgICAgICAgICAgICB9CgkgICAgICAgICAgICByZXR1cm4gdGhlTWVzc2FnZTsKCSAgICAgICAgfQoJICAgIH0sIHsKCSAgICAgICAga2V5OiAncG9zdFBlbmRpbmdNZXNzYWdlcycsCgkgICAgICAgIHZhbHVlOiBmdW5jdGlvbiBwb3N0UGVuZGluZ01lc3NhZ2VzKCkgewoJICAgICAgICAgICAgdmFyIF9pdGVyYXRvck5vcm1hbENvbXBsZXRpb24gPSB0cnVlOwoJICAgICAgICAgICAgdmFyIF9kaWRJdGVyYXRvckVycm9yID0gZmFsc2U7CgkgICAgICAgICAgICB2YXIgX2l0ZXJhdG9yRXJyb3IgPSB1bmRlZmluZWQ7CgoJICAgICAgICAgICAgdHJ5IHsKCSAgICAgICAgICAgICAgICBmb3IgKHZhciBfaXRlcmF0b3IgPSB0aGlzLnBlbmRpbmdNZXNzYWdlc1tTeW1ib2wuaXRlcmF0b3JdKCksIF9zdGVwOyAhKF9pdGVyYXRvck5vcm1hbENvbXBsZXRpb24gPSAoX3N0ZXAgPSBfaXRlcmF0b3IubmV4dCgpKS5kb25lKTsgX2l0ZXJhdG9yTm9ybWFsQ29tcGxldGlvbiA9IHRydWUpIHsKCSAgICAgICAgICAgICAgICAgICAgdmFyIG1lc3NhZ2UgPSBfc3RlcC52YWx1ZTsKCgkgICAgICAgICAgICAgICAgICAgIG1lc3NhZ2UuZGF0YS53aW5kb3dJRCA9IHRoaXMud2luZG93SUQ7CgkgICAgICAgICAgICAgICAgICAgIHRoaXMuX3Bvc3RNZXNzYWdlVG9Tb3VyY2UobWVzc2FnZS5kYXRhKTsKCSAgICAgICAgICAgICAgICAgICAgcG9zdGVkTWVzc2FnZXMuc2V0KG1lc3NhZ2UuaWQsIG1lc3NhZ2UpOwoJICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgIH0gY2F0Y2ggKGVycikgewoJICAgICAgICAgICAgICAgIF9kaWRJdGVyYXRvckVycm9yID0gdHJ1ZTsKCSAgICAgICAgICAgICAgICBfaXRlcmF0b3JFcnJvciA9IGVycjsKCSAgICAgICAgICAgIH0gZmluYWxseSB7CgkgICAgICAgICAgICAgICAgdHJ5IHsKCSAgICAgICAgICAgICAgICAgICAgaWYgKCFfaXRlcmF0b3JOb3JtYWxDb21wbGV0aW9uICYmIF9pdGVyYXRvci5yZXR1cm4pIHsKCSAgICAgICAgICAgICAgICAgICAgICAgIF9pdGVyYXRvci5yZXR1cm4oKTsKCSAgICAgICAgICAgICAgICAgICAgfQoJICAgICAgICAgICAgICAgIH0gZmluYWxseSB7CgkgICAgICAgICAgICAgICAgICAgIGlmIChfZGlkSXRlcmF0b3JFcnJvcikgewoJICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgX2l0ZXJhdG9yRXJyb3I7CgkgICAgICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgICAgICB9CgkgICAgICAgICAgICB9CgkgICAgICAgIH0KCSAgICB9LCB7CgkgICAgICAgIGtleTogJ2hhbmRsZVBlbmRpbmdNZXNzYWdlcycsCgkgICAgICAgIHZhbHVlOiBmdW5jdGlvbiBoYW5kbGVQZW5kaW5nTWVzc2FnZXMoKSB7CgkgICAgICAgICAgICB0aGlzLnJlYWR5VG9IYW5kbGUgPSB0cnVlOwoJICAgICAgICAgICAgZm9yICh2YXIgaSA9IDA7IGkgPCB0aGlzLnVuaGFuZGxlZE1lc3NhZ2VzLmxlbmd0aDsgaSsrKSB7CgkgICAgICAgICAgICAgICAgdGhpcy5oYW5kbGVNZXNzYWdlKHRoaXMudW5oYW5kbGVkTWVzc2FnZXNbaV0pOwoJICAgICAgICAgICAgfQoJICAgICAgICAgICAgdGhpcy51bmhhbmRsZWRNZXNzYWdlcyA9IFtdOwoJICAgICAgICB9CgkgICAgfSwgewoJICAgICAgICBrZXk6ICdoYW5kbGVNZXNzYWdlJywKCSAgICAgICAgdmFsdWU6IGZ1bmN0aW9uIGhhbmRsZU1lc3NhZ2UoZGF0YSkgewoJICAgICAgICAgICAgaWYgKCF0aGlzLnJlYWR5VG9IYW5kbGUpIHsKCSAgICAgICAgICAgICAgICB0aGlzLnVuaGFuZGxlZE1lc3NhZ2VzLnB1c2goZGF0YSk7CgkgICAgICAgICAgICAgICAgcmV0dXJuOwoJICAgICAgICAgICAgfQoJICAgICAgICAgICAgaWYgKCFwb3N0ZWRNZXNzYWdlcy5oYXMoZGF0YS5tZXNzYWdlSUQpKSB7CgkgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZW1pdCgnbWVzc2FnZScsIGRhdGEpOwoJICAgICAgICAgICAgfQoJICAgICAgICAgICAgdmFyIG1lc3NhZ2UgPSBwb3N0ZWRNZXNzYWdlcy5nZXQoZGF0YS5tZXNzYWdlSUQpOwoJICAgICAgICAgICAgaWYgKGRhdGEuc3RhdHVzKSB7CgkgICAgICAgICAgICAgICAgaWYgKGRhdGEuc3RhdHVzID09PSAnZXJyb3InKSB7CgkgICAgICAgICAgICAgICAgICAgIG1lc3NhZ2UuX3JlamVjdChkYXRhKTsKCSAgICAgICAgICAgICAgICAgICAgcG9zdGVkTWVzc2FnZXMuZGVsZXRlKGRhdGEubWVzc2FnZUlEKTsKCSAgICAgICAgICAgICAgICB9IGVsc2UgaWYgKGRhdGEuc3RhdHVzID09PSAnc3VjY2VzcycpIHsKCSAgICAgICAgICAgICAgICAgICAgbWVzc2FnZS5fcmVzb2x2ZShkYXRhKTsKCSAgICAgICAgICAgICAgICAgICAgcG9zdGVkTWVzc2FnZXMuZGVsZXRlKGRhdGEubWVzc2FnZUlEKTsKCSAgICAgICAgICAgICAgICB9IGVsc2UgewoJICAgICAgICAgICAgICAgICAgICBtZXNzYWdlLmVtaXQoZGF0YS5zdGF0dXMsIGRhdGEpOwoJICAgICAgICAgICAgICAgIH0KCSAgICAgICAgICAgIH0gZWxzZSB7CgkgICAgICAgICAgICAgICAgLy8gbm8gc3RhdHVzIGlzIGNvbnNpZGVyZWQgYSBzdWNjZXNzCgkgICAgICAgICAgICAgICAgbWVzc2FnZS5fcmVzb2x2ZShkYXRhKTsKCSAgICAgICAgICAgICAgICBwb3N0ZWRNZXNzYWdlcy5kZWxldGUoZGF0YS5tZXNzYWdlSUQpOwoJICAgICAgICAgICAgfQoJICAgICAgICB9CgkgICAgfV0pOwoKCSAgICByZXR1cm4gTWVzc2FnZUhhbmRsZXI7Cgl9KEV2ZW50RW1pdHRlcik7CgoJbW9kdWxlLmV4cG9ydHMgPSBNZXNzYWdlSGFuZGxlcjsKCi8qKiovIH0sCi8qIDUgKi8KLyoqKi8gZnVuY3Rpb24obW9kdWxlLCBleHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKSB7CgoJJ3VzZSBzdHJpY3QnOwoKCXZhciBfY3JlYXRlQ2xhc3MgPSBmdW5jdGlvbiAoKSB7IGZ1bmN0aW9uIGRlZmluZVByb3BlcnRpZXModGFyZ2V0LCBwcm9wcykgeyBmb3IgKHZhciBpID0gMDsgaSA8IHByb3BzLmxlbmd0aDsgaSsrKSB7IHZhciBkZXNjcmlwdG9yID0gcHJvcHNbaV07IGRlc2NyaXB0b3IuZW51bWVyYWJsZSA9IGRlc2NyaXB0b3IuZW51bWVyYWJsZSB8fCBmYWxzZTsgZGVzY3JpcHRvci5jb25maWd1cmFibGUgPSB0cnVlOyBpZiAoInZhbHVlIiBpbiBkZXNjcmlwdG9yKSBkZXNjcmlwdG9yLndyaXRhYmxlID0gdHJ1ZTsgT2JqZWN0LmRlZmluZVByb3BlcnR5KHRhcmdldCwgZGVzY3JpcHRvci5rZXksIGRlc2NyaXB0b3IpOyB9IH0gcmV0dXJuIGZ1bmN0aW9uIChDb25zdHJ1Y3RvciwgcHJvdG9Qcm9wcywgc3RhdGljUHJvcHMpIHsgaWYgKHByb3RvUHJvcHMpIGRlZmluZVByb3BlcnRpZXMoQ29uc3RydWN0b3IucHJvdG90eXBlLCBwcm90b1Byb3BzKTsgaWYgKHN0YXRpY1Byb3BzKSBkZWZpbmVQcm9wZXJ0aWVzKENvbnN0cnVjdG9yLCBzdGF0aWNQcm9wcyk7IHJldHVybiBDb25zdHJ1Y3RvcjsgfTsgfSgpOwoKCWZ1bmN0aW9uIF9jbGFzc0NhbGxDaGVjayhpbnN0YW5jZSwgQ29uc3RydWN0b3IpIHsgaWYgKCEoaW5zdGFuY2UgaW5zdGFuY2VvZiBDb25zdHJ1Y3RvcikpIHsgdGhyb3cgbmV3IFR5cGVFcnJvcigiQ2Fubm90IGNhbGwgYSBjbGFzcyBhcyBhIGZ1bmN0aW9uIik7IH0gfQoKCWZ1bmN0aW9uIF9wb3NzaWJsZUNvbnN0cnVjdG9yUmV0dXJuKHNlbGYsIGNhbGwpIHsgaWYgKCFzZWxmKSB7IHRocm93IG5ldyBSZWZlcmVuY2VFcnJvcigidGhpcyBoYXNuJ3QgYmVlbiBpbml0aWFsaXNlZCAtIHN1cGVyKCkgaGFzbid0IGJlZW4gY2FsbGVkIik7IH0gcmV0dXJuIGNhbGwgJiYgKHR5cGVvZiBjYWxsID09PSAib2JqZWN0IiB8fCB0eXBlb2YgY2FsbCA9PT0gImZ1bmN0aW9uIikgPyBjYWxsIDogc2VsZjsgfQoKCWZ1bmN0aW9uIF9pbmhlcml0cyhzdWJDbGFzcywgc3VwZXJDbGFzcykgeyBpZiAodHlwZW9mIHN1cGVyQ2xhc3MgIT09ICJmdW5jdGlvbiIgJiYgc3VwZXJDbGFzcyAhPT0gbnVsbCkgeyB0aHJvdyBuZXcgVHlwZUVycm9yKCJTdXBlciBleHByZXNzaW9uIG11c3QgZWl0aGVyIGJlIG51bGwgb3IgYSBmdW5jdGlvbiwgbm90ICIgKyB0eXBlb2Ygc3VwZXJDbGFzcyk7IH0gc3ViQ2xhc3MucHJvdG90eXBlID0gT2JqZWN0LmNyZWF0ZShzdXBlckNsYXNzICYmIHN1cGVyQ2xhc3MucHJvdG90eXBlLCB7IGNvbnN0cnVjdG9yOiB7IHZhbHVlOiBzdWJDbGFzcywgZW51bWVyYWJsZTogZmFsc2UsIHdyaXRhYmxlOiB0cnVlLCBjb25maWd1cmFibGU6IHRydWUgfSB9KTsgaWYgKHN1cGVyQ2xhc3MpIE9iamVjdC5zZXRQcm90b3R5cGVPZiA/IE9iamVjdC5zZXRQcm90b3R5cGVPZihzdWJDbGFzcywgc3VwZXJDbGFzcykgOiBzdWJDbGFzcy5fX3Byb3RvX18gPSBzdXBlckNsYXNzOyB9CgoJdmFyIEV2ZW50RW1pdHRlciA9IF9fd2VicGFja19yZXF1aXJlX18oNikuRXZlbnRFbWl0dGVyOwoJdmFyIHByb21pc2UgPSBTeW1ib2woKTsKCgl2YXIgTWVzc2FnZSA9IGZ1bmN0aW9uIChfRXZlbnRFbWl0dGVyKSB7CgkgICAgX2luaGVyaXRzKE1lc3NhZ2UsIF9FdmVudEVtaXR0ZXIpOwoKCSAgICBmdW5jdGlvbiBNZXNzYWdlKGlkLCBkYXRhKSB7CgkgICAgICAgIF9jbGFzc0NhbGxDaGVjayh0aGlzLCBNZXNzYWdlKTsKCgkgICAgICAgIHZhciBfdGhpcyA9IF9wb3NzaWJsZUNvbnN0cnVjdG9yUmV0dXJuKHRoaXMsIE9iamVjdC5nZXRQcm90b3R5cGVPZihNZXNzYWdlKS5jYWxsKHRoaXMpKTsKCgkgICAgICAgIF90aGlzLmlkID0gaWQ7CgkgICAgICAgIF90aGlzLmRhdGEgPSBkYXRhOwoJICAgICAgICBfdGhpc1twcm9taXNlXSA9IG5ldyBQcm9taXNlKGZ1bmN0aW9uIChyZXNvbHZlLCByZWplY3QpIHsKCSAgICAgICAgICAgIF90aGlzLl9yZXNvbHZlID0gcmVzb2x2ZTsKCSAgICAgICAgICAgIF90aGlzLl9yZWplY3QgPSByZWplY3Q7CgkgICAgICAgIH0pOwoJICAgICAgICByZXR1cm4gX3RoaXM7CgkgICAgfQoKCSAgICBfY3JlYXRlQ2xhc3MoTWVzc2FnZSwgW3sKCSAgICAgICAga2V5OiAndGhlbicsCgkgICAgICAgIHZhbHVlOiBmdW5jdGlvbiB0aGVuKG9uUmVzb2x2ZSwgb25SZWplY3QpIHsKCSAgICAgICAgICAgIHJldHVybiB0aGlzW3Byb21pc2VdLnRoZW4ob25SZXNvbHZlLCBvblJlamVjdCk7CgkgICAgICAgIH0KCSAgICB9LCB7CgkgICAgICAgIGtleTogJ2NhdGNoJywKCSAgICAgICAgdmFsdWU6IGZ1bmN0aW9uIF9jYXRjaChvblJlamVjdCkgewoJICAgICAgICAgICAgcmV0dXJuIHRoaXNbcHJvbWlzZV0uY2F0Y2gob25SZWplY3QpOwoJICAgICAgICB9CgkgICAgfV0pOwoKCSAgICByZXR1cm4gTWVzc2FnZTsKCX0oRXZlbnRFbWl0dGVyKTsKCgltb2R1bGUuZXhwb3J0cyA9IE1lc3NhZ2U7CgovKioqLyB9LAovKiA2ICovCi8qKiovIGZ1bmN0aW9uKG1vZHVsZSwgZXhwb3J0cykgewoKCS8vIENvcHlyaWdodCBKb3llbnQsIEluYy4gYW5kIG90aGVyIE5vZGUgY29udHJpYnV0b3JzLgoJLy8KCS8vIFBlcm1pc3Npb24gaXMgaGVyZWJ5IGdyYW50ZWQsIGZyZWUgb2YgY2hhcmdlLCB0byBhbnkgcGVyc29uIG9idGFpbmluZyBhCgkvLyBjb3B5IG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlCgkvLyAiU29mdHdhcmUiKSwgdG8gZGVhbCBpbiB0aGUgU29mdHdhcmUgd2l0aG91dCByZXN0cmljdGlvbiwgaW5jbHVkaW5nCgkvLyB3aXRob3V0IGxpbWl0YXRpb24gdGhlIHJpZ2h0cyB0byB1c2UsIGNvcHksIG1vZGlmeSwgbWVyZ2UsIHB1Ymxpc2gsCgkvLyBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbCBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0CgkvLyBwZXJzb25zIHRvIHdob20gdGhlIFNvZnR3YXJlIGlzIGZ1cm5pc2hlZCB0byBkbyBzbywgc3ViamVjdCB0byB0aGUKCS8vIGZvbGxvd2luZyBjb25kaXRpb25zOgoJLy8KCS8vIFRoZSBhYm92ZSBjb3B5cmlnaHQgbm90aWNlIGFuZCB0aGlzIHBlcm1pc3Npb24gbm90aWNlIHNoYWxsIGJlIGluY2x1ZGVkCgkvLyBpbiBhbGwgY29waWVzIG9yIHN1YnN0YW50aWFsIHBvcnRpb25zIG9mIHRoZSBTb2Z0d2FyZS4KCS8vCgkvLyBUSEUgU09GVFdBUkUgSVMgUFJPVklERUQgIkFTIElTIiwgV0lUSE9VVCBXQVJSQU5UWSBPRiBBTlkgS0lORCwgRVhQUkVTUwoJLy8gT1IgSU1QTElFRCwgSU5DTFVESU5HIEJVVCBOT1QgTElNSVRFRCBUTyBUSEUgV0FSUkFOVElFUyBPRgoJLy8gTUVSQ0hBTlRBQklMSVRZLCBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiBJTgoJLy8gTk8gRVZFTlQgU0hBTEwgVEhFIEFVVEhPUlMgT1IgQ09QWVJJR0hUIEhPTERFUlMgQkUgTElBQkxFIEZPUiBBTlkgQ0xBSU0sCgkvLyBEQU1BR0VTIE9SIE9USEVSIExJQUJJTElUWSwgV0hFVEhFUiBJTiBBTiBBQ1RJT04gT0YgQ09OVFJBQ1QsIFRPUlQgT1IKCS8vIE9USEVSV0lTRSwgQVJJU0lORyBGUk9NLCBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUKCS8vIFVTRSBPUiBPVEhFUiBERUFMSU5HUyBJTiBUSEUgU09GVFdBUkUuCgoJZnVuY3Rpb24gRXZlbnRFbWl0dGVyKCkgewoJICB0aGlzLl9ldmVudHMgPSB0aGlzLl9ldmVudHMgfHwge307CgkgIHRoaXMuX21heExpc3RlbmVycyA9IHRoaXMuX21heExpc3RlbmVycyB8fCB1bmRlZmluZWQ7Cgl9Cgltb2R1bGUuZXhwb3J0cyA9IEV2ZW50RW1pdHRlcjsKCgkvLyBCYWNrd2FyZHMtY29tcGF0IHdpdGggbm9kZSAwLjEwLngKCUV2ZW50RW1pdHRlci5FdmVudEVtaXR0ZXIgPSBFdmVudEVtaXR0ZXI7CgoJRXZlbnRFbWl0dGVyLnByb3RvdHlwZS5fZXZlbnRzID0gdW5kZWZpbmVkOwoJRXZlbnRFbWl0dGVyLnByb3RvdHlwZS5fbWF4TGlzdGVuZXJzID0gdW5kZWZpbmVkOwoKCS8vIEJ5IGRlZmF1bHQgRXZlbnRFbWl0dGVycyB3aWxsIHByaW50IGEgd2FybmluZyBpZiBtb3JlIHRoYW4gMTAgbGlzdGVuZXJzIGFyZQoJLy8gYWRkZWQgdG8gaXQuIFRoaXMgaXMgYSB1c2VmdWwgZGVmYXVsdCB3aGljaCBoZWxwcyBmaW5kaW5nIG1lbW9yeSBsZWFrcy4KCUV2ZW50RW1pdHRlci5kZWZhdWx0TWF4TGlzdGVuZXJzID0gMTA7CgoJLy8gT2J2aW91c2x5IG5vdCBhbGwgRW1pdHRlcnMgc2hvdWxkIGJlIGxpbWl0ZWQgdG8gMTAuIFRoaXMgZnVuY3Rpb24gYWxsb3dzCgkvLyB0aGF0IHRvIGJlIGluY3JlYXNlZC4gU2V0IHRvIHplcm8gZm9yIHVubGltaXRlZC4KCUV2ZW50RW1pdHRlci5wcm90b3R5cGUuc2V0TWF4TGlzdGVuZXJzID0gZnVuY3Rpb24obikgewoJICBpZiAoIWlzTnVtYmVyKG4pIHx8IG4gPCAwIHx8IGlzTmFOKG4pKQoJICAgIHRocm93IFR5cGVFcnJvcignbiBtdXN0IGJlIGEgcG9zaXRpdmUgbnVtYmVyJyk7CgkgIHRoaXMuX21heExpc3RlbmVycyA9IG47CgkgIHJldHVybiB0aGlzOwoJfTsKCglFdmVudEVtaXR0ZXIucHJvdG90eXBlLmVtaXQgPSBmdW5jdGlvbih0eXBlKSB7CgkgIHZhciBlciwgaGFuZGxlciwgbGVuLCBhcmdzLCBpLCBsaXN0ZW5lcnM7CgoJICBpZiAoIXRoaXMuX2V2ZW50cykKCSAgICB0aGlzLl9ldmVudHMgPSB7fTsKCgkgIC8vIElmIHRoZXJlIGlzIG5vICdlcnJvcicgZXZlbnQgbGlzdGVuZXIgdGhlbiB0aHJvdy4KCSAgaWYgKHR5cGUgPT09ICdlcnJvcicpIHsKCSAgICBpZiAoIXRoaXMuX2V2ZW50cy5lcnJvciB8fAoJICAgICAgICAoaXNPYmplY3QodGhpcy5fZXZlbnRzLmVycm9yKSAmJiAhdGhpcy5fZXZlbnRzLmVycm9yLmxlbmd0aCkpIHsKCSAgICAgIGVyID0gYXJndW1lbnRzWzFdOwoJICAgICAgaWYgKGVyIGluc3RhbmNlb2YgRXJyb3IpIHsKCSAgICAgICAgdGhyb3cgZXI7IC8vIFVuaGFuZGxlZCAnZXJyb3InIGV2ZW50CgkgICAgICB9CgkgICAgICB0aHJvdyBUeXBlRXJyb3IoJ1VuY2F1Z2h0LCB1bnNwZWNpZmllZCAiZXJyb3IiIGV2ZW50LicpOwoJICAgIH0KCSAgfQoKCSAgaGFuZGxlciA9IHRoaXMuX2V2ZW50c1t0eXBlXTsKCgkgIGlmIChpc1VuZGVmaW5lZChoYW5kbGVyKSkKCSAgICByZXR1cm4gZmFsc2U7CgoJICBpZiAoaXNGdW5jdGlvbihoYW5kbGVyKSkgewoJICAgIHN3aXRjaCAoYXJndW1lbnRzLmxlbmd0aCkgewoJICAgICAgLy8gZmFzdCBjYXNlcwoJICAgICAgY2FzZSAxOgoJICAgICAgICBoYW5kbGVyLmNhbGwodGhpcyk7CgkgICAgICAgIGJyZWFrOwoJICAgICAgY2FzZSAyOgoJICAgICAgICBoYW5kbGVyLmNhbGwodGhpcywgYXJndW1lbnRzWzFdKTsKCSAgICAgICAgYnJlYWs7CgkgICAgICBjYXNlIDM6CgkgICAgICAgIGhhbmRsZXIuY2FsbCh0aGlzLCBhcmd1bWVudHNbMV0sIGFyZ3VtZW50c1syXSk7CgkgICAgICAgIGJyZWFrOwoJICAgICAgLy8gc2xvd2VyCgkgICAgICBkZWZhdWx0OgoJICAgICAgICBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKTsKCSAgICAgICAgaGFuZGxlci5hcHBseSh0aGlzLCBhcmdzKTsKCSAgICB9CgkgIH0gZWxzZSBpZiAoaXNPYmplY3QoaGFuZGxlcikpIHsKCSAgICBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKTsKCSAgICBsaXN0ZW5lcnMgPSBoYW5kbGVyLnNsaWNlKCk7CgkgICAgbGVuID0gbGlzdGVuZXJzLmxlbmd0aDsKCSAgICBmb3IgKGkgPSAwOyBpIDwgbGVuOyBpKyspCgkgICAgICBsaXN0ZW5lcnNbaV0uYXBwbHkodGhpcywgYXJncyk7CgkgIH0KCgkgIHJldHVybiB0cnVlOwoJfTsKCglFdmVudEVtaXR0ZXIucHJvdG90eXBlLmFkZExpc3RlbmVyID0gZnVuY3Rpb24odHlwZSwgbGlzdGVuZXIpIHsKCSAgdmFyIG07CgoJICBpZiAoIWlzRnVuY3Rpb24obGlzdGVuZXIpKQoJICAgIHRocm93IFR5cGVFcnJvcignbGlzdGVuZXIgbXVzdCBiZSBhIGZ1bmN0aW9uJyk7CgoJICBpZiAoIXRoaXMuX2V2ZW50cykKCSAgICB0aGlzLl9ldmVudHMgPSB7fTsKCgkgIC8vIFRvIGF2b2lkIHJlY3Vyc2lvbiBpbiB0aGUgY2FzZSB0aGF0IHR5cGUgPT09ICJuZXdMaXN0ZW5lciIhIEJlZm9yZQoJICAvLyBhZGRpbmcgaXQgdG8gdGhlIGxpc3RlbmVycywgZmlyc3QgZW1pdCAibmV3TGlzdGVuZXIiLgoJICBpZiAodGhpcy5fZXZlbnRzLm5ld0xpc3RlbmVyKQoJICAgIHRoaXMuZW1pdCgnbmV3TGlzdGVuZXInLCB0eXBlLAoJICAgICAgICAgICAgICBpc0Z1bmN0aW9uKGxpc3RlbmVyLmxpc3RlbmVyKSA/CgkgICAgICAgICAgICAgIGxpc3RlbmVyLmxpc3RlbmVyIDogbGlzdGVuZXIpOwoKCSAgaWYgKCF0aGlzLl9ldmVudHNbdHlwZV0pCgkgICAgLy8gT3B0aW1pemUgdGhlIGNhc2Ugb2Ygb25lIGxpc3RlbmVyLiBEb24ndCBuZWVkIHRoZSBleHRyYSBhcnJheSBvYmplY3QuCgkgICAgdGhpcy5fZXZlbnRzW3R5cGVdID0gbGlzdGVuZXI7CgkgIGVsc2UgaWYgKGlzT2JqZWN0KHRoaXMuX2V2ZW50c1t0eXBlXSkpCgkgICAgLy8gSWYgd2UndmUgYWxyZWFkeSBnb3QgYW4gYXJyYXksIGp1c3QgYXBwZW5kLgoJICAgIHRoaXMuX2V2ZW50c1t0eXBlXS5wdXNoKGxpc3RlbmVyKTsKCSAgZWxzZQoJICAgIC8vIEFkZGluZyB0aGUgc2Vjb25kIGVsZW1lbnQsIG5lZWQgdG8gY2hhbmdlIHRvIGFycmF5LgoJICAgIHRoaXMuX2V2ZW50c1t0eXBlXSA9IFt0aGlzLl9ldmVudHNbdHlwZV0sIGxpc3RlbmVyXTsKCgkgIC8vIENoZWNrIGZvciBsaXN0ZW5lciBsZWFrCgkgIGlmIChpc09iamVjdCh0aGlzLl9ldmVudHNbdHlwZV0pICYmICF0aGlzLl9ldmVudHNbdHlwZV0ud2FybmVkKSB7CgkgICAgaWYgKCFpc1VuZGVmaW5lZCh0aGlzLl9tYXhMaXN0ZW5lcnMpKSB7CgkgICAgICBtID0gdGhpcy5fbWF4TGlzdGVuZXJzOwoJICAgIH0gZWxzZSB7CgkgICAgICBtID0gRXZlbnRFbWl0dGVyLmRlZmF1bHRNYXhMaXN0ZW5lcnM7CgkgICAgfQoKCSAgICBpZiAobSAmJiBtID4gMCAmJiB0aGlzLl9ldmVudHNbdHlwZV0ubGVuZ3RoID4gbSkgewoJICAgICAgdGhpcy5fZXZlbnRzW3R5cGVdLndhcm5lZCA9IHRydWU7CgkgICAgICBjb25zb2xlLmVycm9yKCcobm9kZSkgd2FybmluZzogcG9zc2libGUgRXZlbnRFbWl0dGVyIG1lbW9yeSAnICsKCSAgICAgICAgICAgICAgICAgICAgJ2xlYWsgZGV0ZWN0ZWQuICVkIGxpc3RlbmVycyBhZGRlZC4gJyArCgkgICAgICAgICAgICAgICAgICAgICdVc2UgZW1pdHRlci5zZXRNYXhMaXN0ZW5lcnMoKSB0byBpbmNyZWFzZSBsaW1pdC4nLAoJICAgICAgICAgICAgICAgICAgICB0aGlzLl9ldmVudHNbdHlwZV0ubGVuZ3RoKTsKCSAgICAgIGlmICh0eXBlb2YgY29uc29sZS50cmFjZSA9PT0gJ2Z1bmN0aW9uJykgewoJICAgICAgICAvLyBub3Qgc3VwcG9ydGVkIGluIElFIDEwCgkgICAgICAgIGNvbnNvbGUudHJhY2UoKTsKCSAgICAgIH0KCSAgICB9CgkgIH0KCgkgIHJldHVybiB0aGlzOwoJfTsKCglFdmVudEVtaXR0ZXIucHJvdG90eXBlLm9uID0gRXZlbnRFbWl0dGVyLnByb3RvdHlwZS5hZGRMaXN0ZW5lcjsKCglFdmVudEVtaXR0ZXIucHJvdG90eXBlLm9uY2UgPSBmdW5jdGlvbih0eXBlLCBsaXN0ZW5lcikgewoJICBpZiAoIWlzRnVuY3Rpb24obGlzdGVuZXIpKQoJICAgIHRocm93IFR5cGVFcnJvcignbGlzdGVuZXIgbXVzdCBiZSBhIGZ1bmN0aW9uJyk7CgoJICB2YXIgZmlyZWQgPSBmYWxzZTsKCgkgIGZ1bmN0aW9uIGcoKSB7CgkgICAgdGhpcy5yZW1vdmVMaXN0ZW5lcih0eXBlLCBnKTsKCgkgICAgaWYgKCFmaXJlZCkgewoJICAgICAgZmlyZWQgPSB0cnVlOwoJICAgICAgbGlzdGVuZXIuYXBwbHkodGhpcywgYXJndW1lbnRzKTsKCSAgICB9CgkgIH0KCgkgIGcubGlzdGVuZXIgPSBsaXN0ZW5lcjsKCSAgdGhpcy5vbih0eXBlLCBnKTsKCgkgIHJldHVybiB0aGlzOwoJfTsKCgkvLyBlbWl0cyBhICdyZW1vdmVMaXN0ZW5lcicgZXZlbnQgaWZmIHRoZSBsaXN0ZW5lciB3YXMgcmVtb3ZlZAoJRXZlbnRFbWl0dGVyLnByb3RvdHlwZS5yZW1vdmVMaXN0ZW5lciA9IGZ1bmN0aW9uKHR5cGUsIGxpc3RlbmVyKSB7CgkgIHZhciBsaXN0LCBwb3NpdGlvbiwgbGVuZ3RoLCBpOwoKCSAgaWYgKCFpc0Z1bmN0aW9uKGxpc3RlbmVyKSkKCSAgICB0aHJvdyBUeXBlRXJyb3IoJ2xpc3RlbmVyIG11c3QgYmUgYSBmdW5jdGlvbicpOwoKCSAgaWYgKCF0aGlzLl9ldmVudHMgfHwgIXRoaXMuX2V2ZW50c1t0eXBlXSkKCSAgICByZXR1cm4gdGhpczsKCgkgIGxpc3QgPSB0aGlzLl9ldmVudHNbdHlwZV07CgkgIGxlbmd0aCA9IGxpc3QubGVuZ3RoOwoJICBwb3NpdGlvbiA9IC0xOwoKCSAgaWYgKGxpc3QgPT09IGxpc3RlbmVyIHx8CgkgICAgICAoaXNGdW5jdGlvbihsaXN0Lmxpc3RlbmVyKSAmJiBsaXN0Lmxpc3RlbmVyID09PSBsaXN0ZW5lcikpIHsKCSAgICBkZWxldGUgdGhpcy5fZXZlbnRzW3R5cGVdOwoJICAgIGlmICh0aGlzLl9ldmVudHMucmVtb3ZlTGlzdGVuZXIpCgkgICAgICB0aGlzLmVtaXQoJ3JlbW92ZUxpc3RlbmVyJywgdHlwZSwgbGlzdGVuZXIpOwoKCSAgfSBlbHNlIGlmIChpc09iamVjdChsaXN0KSkgewoJICAgIGZvciAoaSA9IGxlbmd0aDsgaS0tID4gMDspIHsKCSAgICAgIGlmIChsaXN0W2ldID09PSBsaXN0ZW5lciB8fAoJICAgICAgICAgIChsaXN0W2ldLmxpc3RlbmVyICYmIGxpc3RbaV0ubGlzdGVuZXIgPT09IGxpc3RlbmVyKSkgewoJICAgICAgICBwb3NpdGlvbiA9IGk7CgkgICAgICAgIGJyZWFrOwoJICAgICAgfQoJICAgIH0KCgkgICAgaWYgKHBvc2l0aW9uIDwgMCkKCSAgICAgIHJldHVybiB0aGlzOwoKCSAgICBpZiAobGlzdC5sZW5ndGggPT09IDEpIHsKCSAgICAgIGxpc3QubGVuZ3RoID0gMDsKCSAgICAgIGRlbGV0ZSB0aGlzLl9ldmVudHNbdHlwZV07CgkgICAgfSBlbHNlIHsKCSAgICAgIGxpc3Quc3BsaWNlKHBvc2l0aW9uLCAxKTsKCSAgICB9CgoJICAgIGlmICh0aGlzLl9ldmVudHMucmVtb3ZlTGlzdGVuZXIpCgkgICAgICB0aGlzLmVtaXQoJ3JlbW92ZUxpc3RlbmVyJywgdHlwZSwgbGlzdGVuZXIpOwoJICB9CgoJICByZXR1cm4gdGhpczsKCX07CgoJRXZlbnRFbWl0dGVyLnByb3RvdHlwZS5yZW1vdmVBbGxMaXN0ZW5lcnMgPSBmdW5jdGlvbih0eXBlKSB7CgkgIHZhciBrZXksIGxpc3RlbmVyczsKCgkgIGlmICghdGhpcy5fZXZlbnRzKQoJICAgIHJldHVybiB0aGlzOwoKCSAgLy8gbm90IGxpc3RlbmluZyBmb3IgcmVtb3ZlTGlzdGVuZXIsIG5vIG5lZWQgdG8gZW1pdAoJICBpZiAoIXRoaXMuX2V2ZW50cy5yZW1vdmVMaXN0ZW5lcikgewoJICAgIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAwKQoJICAgICAgdGhpcy5fZXZlbnRzID0ge307CgkgICAgZWxzZSBpZiAodGhpcy5fZXZlbnRzW3R5cGVdKQoJICAgICAgZGVsZXRlIHRoaXMuX2V2ZW50c1t0eXBlXTsKCSAgICByZXR1cm4gdGhpczsKCSAgfQoKCSAgLy8gZW1pdCByZW1vdmVMaXN0ZW5lciBmb3IgYWxsIGxpc3RlbmVycyBvbiBhbGwgZXZlbnRzCgkgIGlmIChhcmd1bWVudHMubGVuZ3RoID09PSAwKSB7CgkgICAgZm9yIChrZXkgaW4gdGhpcy5fZXZlbnRzKSB7CgkgICAgICBpZiAoa2V5ID09PSAncmVtb3ZlTGlzdGVuZXInKSBjb250aW51ZTsKCSAgICAgIHRoaXMucmVtb3ZlQWxsTGlzdGVuZXJzKGtleSk7CgkgICAgfQoJICAgIHRoaXMucmVtb3ZlQWxsTGlzdGVuZXJzKCdyZW1vdmVMaXN0ZW5lcicpOwoJICAgIHRoaXMuX2V2ZW50cyA9IHt9OwoJICAgIHJldHVybiB0aGlzOwoJICB9CgoJICBsaXN0ZW5lcnMgPSB0aGlzLl9ldmVudHNbdHlwZV07CgoJICBpZiAoaXNGdW5jdGlvbihsaXN0ZW5lcnMpKSB7CgkgICAgdGhpcy5yZW1vdmVMaXN0ZW5lcih0eXBlLCBsaXN0ZW5lcnMpOwoJICB9IGVsc2UgaWYgKGxpc3RlbmVycykgewoJICAgIC8vIExJRk8gb3JkZXIKCSAgICB3aGlsZSAobGlzdGVuZXJzLmxlbmd0aCkKCSAgICAgIHRoaXMucmVtb3ZlTGlzdGVuZXIodHlwZSwgbGlzdGVuZXJzW2xpc3RlbmVycy5sZW5ndGggLSAxXSk7CgkgIH0KCSAgZGVsZXRlIHRoaXMuX2V2ZW50c1t0eXBlXTsKCgkgIHJldHVybiB0aGlzOwoJfTsKCglFdmVudEVtaXR0ZXIucHJvdG90eXBlLmxpc3RlbmVycyA9IGZ1bmN0aW9uKHR5cGUpIHsKCSAgdmFyIHJldDsKCSAgaWYgKCF0aGlzLl9ldmVudHMgfHwgIXRoaXMuX2V2ZW50c1t0eXBlXSkKCSAgICByZXQgPSBbXTsKCSAgZWxzZSBpZiAoaXNGdW5jdGlvbih0aGlzLl9ldmVudHNbdHlwZV0pKQoJICAgIHJldCA9IFt0aGlzLl9ldmVudHNbdHlwZV1dOwoJICBlbHNlCgkgICAgcmV0ID0gdGhpcy5fZXZlbnRzW3R5cGVdLnNsaWNlKCk7CgkgIHJldHVybiByZXQ7Cgl9OwoKCUV2ZW50RW1pdHRlci5wcm90b3R5cGUubGlzdGVuZXJDb3VudCA9IGZ1bmN0aW9uKHR5cGUpIHsKCSAgaWYgKHRoaXMuX2V2ZW50cykgewoJICAgIHZhciBldmxpc3RlbmVyID0gdGhpcy5fZXZlbnRzW3R5cGVdOwoKCSAgICBpZiAoaXNGdW5jdGlvbihldmxpc3RlbmVyKSkKCSAgICAgIHJldHVybiAxOwoJICAgIGVsc2UgaWYgKGV2bGlzdGVuZXIpCgkgICAgICByZXR1cm4gZXZsaXN0ZW5lci5sZW5ndGg7CgkgIH0KCSAgcmV0dXJuIDA7Cgl9OwoKCUV2ZW50RW1pdHRlci5saXN0ZW5lckNvdW50ID0gZnVuY3Rpb24oZW1pdHRlciwgdHlwZSkgewoJICByZXR1cm4gZW1pdHRlci5saXN0ZW5lckNvdW50KHR5cGUpOwoJfTsKCglmdW5jdGlvbiBpc0Z1bmN0aW9uKGFyZykgewoJICByZXR1cm4gdHlwZW9mIGFyZyA9PT0gJ2Z1bmN0aW9uJzsKCX0KCglmdW5jdGlvbiBpc051bWJlcihhcmcpIHsKCSAgcmV0dXJuIHR5cGVvZiBhcmcgPT09ICdudW1iZXInOwoJfQoKCWZ1bmN0aW9uIGlzT2JqZWN0KGFyZykgewoJICByZXR1cm4gdHlwZW9mIGFyZyA9PT0gJ29iamVjdCcgJiYgYXJnICE9PSBudWxsOwoJfQoKCWZ1bmN0aW9uIGlzVW5kZWZpbmVkKGFyZykgewoJICByZXR1cm4gYXJnID09PSB2b2lkIDA7Cgl9CgoKLyoqKi8gfQovKioqKioqLyBdKQp9KTsKOwovLyMgc291cmNlVVJMPWlmcmFtZS1icmlkZ2UtYnJvd3Nlci5qcw==';
export default iframeBridge;
