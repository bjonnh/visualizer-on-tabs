'use strict';

// HEAD version taken from http://www.lactame.com/lib/iframe-bridge/HEAD/iframe-bridge.js on 2015-11-13
// Conversion to base64 with http://decodebase64.com/
const iframeBridge = 'data:application/javascript;base64,' + 'KGZ1bmN0aW9uIHdlYnBhY2tVbml2ZXJzYWxNb2R1bGVEZWZpbml0aW9uKHJvb3QsIGZhY3RvcnkpIHsNCglpZih0eXBlb2YgZXhwb3J0cyA9PT0gJ29iamVjdCcgJiYgdHlwZW9mIG1vZHVsZSA9PT0gJ29iamVjdCcpDQoJCW1vZHVsZS5leHBvcnRzID0gZmFjdG9yeSgpOw0KCWVsc2UgaWYodHlwZW9mIGRlZmluZSA9PT0gJ2Z1bmN0aW9uJyAmJiBkZWZpbmUuYW1kKQ0KCQlkZWZpbmUoW10sIGZhY3RvcnkpOw0KCWVsc2UgaWYodHlwZW9mIGV4cG9ydHMgPT09ICdvYmplY3QnKQ0KCQlleHBvcnRzWyJJZnJhbWVCcmlkZ2UiXSA9IGZhY3RvcnkoKTsNCgllbHNlDQoJCXJvb3RbIklmcmFtZUJyaWRnZSJdID0gZmFjdG9yeSgpOw0KfSkodGhpcywgZnVuY3Rpb24oKSB7DQpyZXR1cm4gLyoqKioqKi8gKGZ1bmN0aW9uKG1vZHVsZXMpIHsgLy8gd2VicGFja0Jvb3RzdHJhcA0KLyoqKioqKi8gCS8vIFRoZSBtb2R1bGUgY2FjaGUNCi8qKioqKiovIAl2YXIgaW5zdGFsbGVkTW9kdWxlcyA9IHt9Ow0KDQovKioqKioqLyAJLy8gVGhlIHJlcXVpcmUgZnVuY3Rpb24NCi8qKioqKiovIAlmdW5jdGlvbiBfX3dlYnBhY2tfcmVxdWlyZV9fKG1vZHVsZUlkKSB7DQoNCi8qKioqKiovIAkJLy8gQ2hlY2sgaWYgbW9kdWxlIGlzIGluIGNhY2hlDQovKioqKioqLyAJCWlmKGluc3RhbGxlZE1vZHVsZXNbbW9kdWxlSWRdKQ0KLyoqKioqKi8gCQkJcmV0dXJuIGluc3RhbGxlZE1vZHVsZXNbbW9kdWxlSWRdLmV4cG9ydHM7DQoNCi8qKioqKiovIAkJLy8gQ3JlYXRlIGEgbmV3IG1vZHVsZSAoYW5kIHB1dCBpdCBpbnRvIHRoZSBjYWNoZSkNCi8qKioqKiovIAkJdmFyIG1vZHVsZSA9IGluc3RhbGxlZE1vZHVsZXNbbW9kdWxlSWRdID0gew0KLyoqKioqKi8gCQkJZXhwb3J0czoge30sDQovKioqKioqLyAJCQlpZDogbW9kdWxlSWQsDQovKioqKioqLyAJCQlsb2FkZWQ6IGZhbHNlDQovKioqKioqLyAJCX07DQoNCi8qKioqKiovIAkJLy8gRXhlY3V0ZSB0aGUgbW9kdWxlIGZ1bmN0aW9uDQovKioqKioqLyAJCW1vZHVsZXNbbW9kdWxlSWRdLmNhbGwobW9kdWxlLmV4cG9ydHMsIG1vZHVsZSwgbW9kdWxlLmV4cG9ydHMsIF9fd2VicGFja19yZXF1aXJlX18pOw0KDQovKioqKioqLyAJCS8vIEZsYWcgdGhlIG1vZHVsZSBhcyBsb2FkZWQNCi8qKioqKiovIAkJbW9kdWxlLmxvYWRlZCA9IHRydWU7DQoNCi8qKioqKiovIAkJLy8gUmV0dXJuIHRoZSBleHBvcnRzIG9mIHRoZSBtb2R1bGUNCi8qKioqKiovIAkJcmV0dXJuIG1vZHVsZS5leHBvcnRzOw0KLyoqKioqKi8gCX0NCg0KDQovKioqKioqLyAJLy8gZXhwb3NlIHRoZSBtb2R1bGVzIG9iamVjdCAoX193ZWJwYWNrX21vZHVsZXNfXykNCi8qKioqKiovIAlfX3dlYnBhY2tfcmVxdWlyZV9fLm0gPSBtb2R1bGVzOw0KDQovKioqKioqLyAJLy8gZXhwb3NlIHRoZSBtb2R1bGUgY2FjaGUNCi8qKioqKiovIAlfX3dlYnBhY2tfcmVxdWlyZV9fLmMgPSBpbnN0YWxsZWRNb2R1bGVzOw0KDQovKioqKioqLyAJLy8gX193ZWJwYWNrX3B1YmxpY19wYXRoX18NCi8qKioqKiovIAlfX3dlYnBhY2tfcmVxdWlyZV9fLnAgPSAiIjsNCg0KLyoqKioqKi8gCS8vIExvYWQgZW50cnkgbW9kdWxlIGFuZCByZXR1cm4gZXhwb3J0cw0KLyoqKioqKi8gCXJldHVybiBfX3dlYnBhY2tfcmVxdWlyZV9fKDApOw0KLyoqKioqKi8gfSkNCi8qKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKiovDQovKioqKioqLyAoWw0KLyogMCAqLw0KLyoqKi8gZnVuY3Rpb24obW9kdWxlLCBleHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKSB7DQoNCgkndXNlIHN0cmljdCc7DQoNCgl2YXIgRGVidWcgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDEpOw0KCXdpbmRvdy5EZWJ1ZyA9IERlYnVnOw0KDQoJdmFyIGRlYnVnID0gRGVidWcoJ2lmcmFtZS1icmlkZ2U6aWZyYW1lJyk7DQoJdmFyIE1lc3NhZ2VIYW5kbGVyID0gX193ZWJwYWNrX3JlcXVpcmVfXyg0KTsNCg0KCXZhciBtZXNzYWdlSGFuZGxlciA9IG5ldyBNZXNzYWdlSGFuZGxlcigpOw0KDQoJbWVzc2FnZUhhbmRsZXIuaW5pdCh3aW5kb3cucGFyZW50KTsNCgl3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcignbWVzc2FnZScsIGZ1bmN0aW9uIChldmVudCkgew0KCSAgICB2YXIgZGF0YSA9IGV2ZW50LmRhdGE7DQoJICAgIGRlYnVnKCdtZXNzYWdlIHJlY2VpdmVkJywgZGF0YSk7DQoJICAgIG1lc3NhZ2VIYW5kbGVyLmhhbmRsZU1lc3NhZ2UoZGF0YSk7DQoJfSk7DQoNCglleHBvcnRzLnBvc3RNZXNzYWdlID0gZnVuY3Rpb24gKHR5cGUsIG1lc3NhZ2UpIHsNCgkgICAgcmV0dXJuIG1lc3NhZ2VIYW5kbGVyLnBvc3RNZXNzYWdlKHR5cGUsIG1lc3NhZ2UpOw0KCX07DQoNCglleHBvcnRzLm9uTWVzc2FnZSA9IGZ1bmN0aW9uIChjYikgew0KCSAgICBtZXNzYWdlSGFuZGxlci5vbignbWVzc2FnZScsIGNiKTsNCgl9Ow0KDQoJZXhwb3J0cy5yZWFkeSA9IGZ1bmN0aW9uICgpIHsNCgkgICAgbWVzc2FnZUhhbmRsZXIuaGFuZGxlUGVuZGluZ01lc3NhZ2VzKCk7DQoJfTsNCg0KLyoqKi8gfSwNCi8qIDEgKi8NCi8qKiovIGZ1bmN0aW9uKG1vZHVsZSwgZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXykgew0KDQoJDQoJLyoqDQoJICogVGhpcyBpcyB0aGUgd2ViIGJyb3dzZXIgaW1wbGVtZW50YXRpb24gb2YgYGRlYnVnKClgLg0KCSAqDQoJICogRXhwb3NlIGBkZWJ1ZygpYCBhcyB0aGUgbW9kdWxlLg0KCSAqLw0KDQoJZXhwb3J0cyA9IG1vZHVsZS5leHBvcnRzID0gX193ZWJwYWNrX3JlcXVpcmVfXygyKTsNCglleHBvcnRzLmxvZyA9IGxvZzsNCglleHBvcnRzLmZvcm1hdEFyZ3MgPSBmb3JtYXRBcmdzOw0KCWV4cG9ydHMuc2F2ZSA9IHNhdmU7DQoJZXhwb3J0cy5sb2FkID0gbG9hZDsNCglleHBvcnRzLnVzZUNvbG9ycyA9IHVzZUNvbG9yczsNCglleHBvcnRzLnN0b3JhZ2UgPSAndW5kZWZpbmVkJyAhPSB0eXBlb2YgY2hyb21lDQoJICAgICAgICAgICAgICAgJiYgJ3VuZGVmaW5lZCcgIT0gdHlwZW9mIGNocm9tZS5zdG9yYWdlDQoJICAgICAgICAgICAgICAgICAgPyBjaHJvbWUuc3RvcmFnZS5sb2NhbA0KCSAgICAgICAgICAgICAgICAgIDogbG9jYWxzdG9yYWdlKCk7DQoNCgkvKioNCgkgKiBDb2xvcnMuDQoJICovDQoNCglleHBvcnRzLmNvbG9ycyA9IFsNCgkgICdsaWdodHNlYWdyZWVuJywNCgkgICdmb3Jlc3RncmVlbicsDQoJICAnZ29sZGVucm9kJywNCgkgICdkb2RnZXJibHVlJywNCgkgICdkYXJrb3JjaGlkJywNCgkgICdjcmltc29uJw0KCV07DQoNCgkvKioNCgkgKiBDdXJyZW50bHkgb25seSBXZWJLaXQtYmFzZWQgV2ViIEluc3BlY3RvcnMsIEZpcmVmb3ggPj0gdjMxLA0KCSAqIGFuZCB0aGUgRmlyZWJ1ZyBleHRlbnNpb24gKGFueSBGaXJlZm94IHZlcnNpb24pIGFyZSBrbm93bg0KCSAqIHRvIHN1cHBvcnQgIiVjIiBDU1MgY3VzdG9taXphdGlvbnMuDQoJICoNCgkgKiBUT0RPOiBhZGQgYSBgbG9jYWxTdG9yYWdlYCB2YXJpYWJsZSB0byBleHBsaWNpdGx5IGVuYWJsZS9kaXNhYmxlIGNvbG9ycw0KCSAqLw0KDQoJZnVuY3Rpb24gdXNlQ29sb3JzKCkgew0KCSAgLy8gaXMgd2Via2l0PyBodHRwOi8vc3RhY2tvdmVyZmxvdy5jb20vYS8xNjQ1OTYwNi8zNzY3NzMNCgkgIHJldHVybiAoJ1dlYmtpdEFwcGVhcmFuY2UnIGluIGRvY3VtZW50LmRvY3VtZW50RWxlbWVudC5zdHlsZSkgfHwNCgkgICAgLy8gaXMgZmlyZWJ1Zz8gaHR0cDovL3N0YWNrb3ZlcmZsb3cuY29tL2EvMzk4MTIwLzM3Njc3Mw0KCSAgICAod2luZG93LmNvbnNvbGUgJiYgKGNvbnNvbGUuZmlyZWJ1ZyB8fCAoY29uc29sZS5leGNlcHRpb24gJiYgY29uc29sZS50YWJsZSkpKSB8fA0KCSAgICAvLyBpcyBmaXJlZm94ID49IHYzMT8NCgkgICAgLy8gaHR0cHM6Ly9kZXZlbG9wZXIubW96aWxsYS5vcmcvZW4tVVMvZG9jcy9Ub29scy9XZWJfQ29uc29sZSNTdHlsaW5nX21lc3NhZ2VzDQoJICAgIChuYXZpZ2F0b3IudXNlckFnZW50LnRvTG93ZXJDYXNlKCkubWF0Y2goL2ZpcmVmb3hcLyhcZCspLykgJiYgcGFyc2VJbnQoUmVnRXhwLiQxLCAxMCkgPj0gMzEpOw0KCX0NCg0KCS8qKg0KCSAqIE1hcCAlaiB0byBgSlNPTi5zdHJpbmdpZnkoKWAsIHNpbmNlIG5vIFdlYiBJbnNwZWN0b3JzIGRvIHRoYXQgYnkgZGVmYXVsdC4NCgkgKi8NCg0KCWV4cG9ydHMuZm9ybWF0dGVycy5qID0gZnVuY3Rpb24odikgew0KCSAgcmV0dXJuIEpTT04uc3RyaW5naWZ5KHYpOw0KCX07DQoNCg0KCS8qKg0KCSAqIENvbG9yaXplIGxvZyBhcmd1bWVudHMgaWYgZW5hYmxlZC4NCgkgKg0KCSAqIEBhcGkgcHVibGljDQoJICovDQoNCglmdW5jdGlvbiBmb3JtYXRBcmdzKCkgew0KCSAgdmFyIGFyZ3MgPSBhcmd1bWVudHM7DQoJICB2YXIgdXNlQ29sb3JzID0gdGhpcy51c2VDb2xvcnM7DQoNCgkgIGFyZ3NbMF0gPSAodXNlQ29sb3JzID8gJyVjJyA6ICcnKQ0KCSAgICArIHRoaXMubmFtZXNwYWNlDQoJICAgICsgKHVzZUNvbG9ycyA/ICcgJWMnIDogJyAnKQ0KCSAgICArIGFyZ3NbMF0NCgkgICAgKyAodXNlQ29sb3JzID8gJyVjICcgOiAnICcpDQoJICAgICsgJysnICsgZXhwb3J0cy5odW1hbml6ZSh0aGlzLmRpZmYpOw0KDQoJICBpZiAoIXVzZUNvbG9ycykgcmV0dXJuIGFyZ3M7DQoNCgkgIHZhciBjID0gJ2NvbG9yOiAnICsgdGhpcy5jb2xvcjsNCgkgIGFyZ3MgPSBbYXJnc1swXSwgYywgJ2NvbG9yOiBpbmhlcml0J10uY29uY2F0KEFycmF5LnByb3RvdHlwZS5zbGljZS5jYWxsKGFyZ3MsIDEpKTsNCg0KCSAgLy8gdGhlIGZpbmFsICIlYyIgaXMgc29tZXdoYXQgdHJpY2t5LCBiZWNhdXNlIHRoZXJlIGNvdWxkIGJlIG90aGVyDQoJICAvLyBhcmd1bWVudHMgcGFzc2VkIGVpdGhlciBiZWZvcmUgb3IgYWZ0ZXIgdGhlICVjLCBzbyB3ZSBuZWVkIHRvDQoJICAvLyBmaWd1cmUgb3V0IHRoZSBjb3JyZWN0IGluZGV4IHRvIGluc2VydCB0aGUgQ1NTIGludG8NCgkgIHZhciBpbmRleCA9IDA7DQoJICB2YXIgbGFzdEMgPSAwOw0KCSAgYXJnc1swXS5yZXBsYWNlKC8lW2EteiVdL2csIGZ1bmN0aW9uKG1hdGNoKSB7DQoJICAgIGlmICgnJSUnID09PSBtYXRjaCkgcmV0dXJuOw0KCSAgICBpbmRleCsrOw0KCSAgICBpZiAoJyVjJyA9PT0gbWF0Y2gpIHsNCgkgICAgICAvLyB3ZSBvbmx5IGFyZSBpbnRlcmVzdGVkIGluIHRoZSAqbGFzdCogJWMNCgkgICAgICAvLyAodGhlIHVzZXIgbWF5IGhhdmUgcHJvdmlkZWQgdGhlaXIgb3duKQ0KCSAgICAgIGxhc3RDID0gaW5kZXg7DQoJICAgIH0NCgkgIH0pOw0KDQoJICBhcmdzLnNwbGljZShsYXN0QywgMCwgYyk7DQoJICByZXR1cm4gYXJnczsNCgl9DQoNCgkvKioNCgkgKiBJbnZva2VzIGBjb25zb2xlLmxvZygpYCB3aGVuIGF2YWlsYWJsZS4NCgkgKiBOby1vcCB3aGVuIGBjb25zb2xlLmxvZ2AgaXMgbm90IGEgImZ1bmN0aW9uIi4NCgkgKg0KCSAqIEBhcGkgcHVibGljDQoJICovDQoNCglmdW5jdGlvbiBsb2coKSB7DQoJICAvLyB0aGlzIGhhY2tlcnkgaXMgcmVxdWlyZWQgZm9yIElFOC85LCB3aGVyZQ0KCSAgLy8gdGhlIGBjb25zb2xlLmxvZ2AgZnVuY3Rpb24gZG9lc24ndCBoYXZlICdhcHBseScNCgkgIHJldHVybiAnb2JqZWN0JyA9PT0gdHlwZW9mIGNvbnNvbGUNCgkgICAgJiYgY29uc29sZS5sb2cNCgkgICAgJiYgRnVuY3Rpb24ucHJvdG90eXBlLmFwcGx5LmNhbGwoY29uc29sZS5sb2csIGNvbnNvbGUsIGFyZ3VtZW50cyk7DQoJfQ0KDQoJLyoqDQoJICogU2F2ZSBgbmFtZXNwYWNlc2AuDQoJICoNCgkgKiBAcGFyYW0ge1N0cmluZ30gbmFtZXNwYWNlcw0KCSAqIEBhcGkgcHJpdmF0ZQ0KCSAqLw0KDQoJZnVuY3Rpb24gc2F2ZShuYW1lc3BhY2VzKSB7DQoJICB0cnkgew0KCSAgICBpZiAobnVsbCA9PSBuYW1lc3BhY2VzKSB7DQoJICAgICAgZXhwb3J0cy5zdG9yYWdlLnJlbW92ZUl0ZW0oJ2RlYnVnJyk7DQoJICAgIH0gZWxzZSB7DQoJICAgICAgZXhwb3J0cy5zdG9yYWdlLmRlYnVnID0gbmFtZXNwYWNlczsNCgkgICAgfQ0KCSAgfSBjYXRjaChlKSB7fQ0KCX0NCg0KCS8qKg0KCSAqIExvYWQgYG5hbWVzcGFjZXNgLg0KCSAqDQoJICogQHJldHVybiB7U3RyaW5nfSByZXR1cm5zIHRoZSBwcmV2aW91c2x5IHBlcnNpc3RlZCBkZWJ1ZyBtb2Rlcw0KCSAqIEBhcGkgcHJpdmF0ZQ0KCSAqLw0KDQoJZnVuY3Rpb24gbG9hZCgpIHsNCgkgIHZhciByOw0KCSAgdHJ5IHsNCgkgICAgciA9IGV4cG9ydHMuc3RvcmFnZS5kZWJ1ZzsNCgkgIH0gY2F0Y2goZSkge30NCgkgIHJldHVybiByOw0KCX0NCg0KCS8qKg0KCSAqIEVuYWJsZSBuYW1lc3BhY2VzIGxpc3RlZCBpbiBgbG9jYWxTdG9yYWdlLmRlYnVnYCBpbml0aWFsbHkuDQoJICovDQoNCglleHBvcnRzLmVuYWJsZShsb2FkKCkpOw0KDQoJLyoqDQoJICogTG9jYWxzdG9yYWdlIGF0dGVtcHRzIHRvIHJldHVybiB0aGUgbG9jYWxzdG9yYWdlLg0KCSAqDQoJICogVGhpcyBpcyBuZWNlc3NhcnkgYmVjYXVzZSBzYWZhcmkgdGhyb3dzDQoJICogd2hlbiBhIHVzZXIgZGlzYWJsZXMgY29va2llcy9sb2NhbHN0b3JhZ2UNCgkgKiBhbmQgeW91IGF0dGVtcHQgdG8gYWNjZXNzIGl0Lg0KCSAqDQoJICogQHJldHVybiB7TG9jYWxTdG9yYWdlfQ0KCSAqIEBhcGkgcHJpdmF0ZQ0KCSAqLw0KDQoJZnVuY3Rpb24gbG9jYWxzdG9yYWdlKCl7DQoJICB0cnkgew0KCSAgICByZXR1cm4gd2luZG93LmxvY2FsU3RvcmFnZTsNCgkgIH0gY2F0Y2ggKGUpIHt9DQoJfQ0KDQoNCi8qKiovIH0sDQovKiAyICovDQovKioqLyBmdW5jdGlvbihtb2R1bGUsIGV4cG9ydHMsIF9fd2VicGFja19yZXF1aXJlX18pIHsNCg0KCQ0KCS8qKg0KCSAqIFRoaXMgaXMgdGhlIGNvbW1vbiBsb2dpYyBmb3IgYm90aCB0aGUgTm9kZS5qcyBhbmQgd2ViIGJyb3dzZXINCgkgKiBpbXBsZW1lbnRhdGlvbnMgb2YgYGRlYnVnKClgLg0KCSAqDQoJICogRXhwb3NlIGBkZWJ1ZygpYCBhcyB0aGUgbW9kdWxlLg0KCSAqLw0KDQoJZXhwb3J0cyA9IG1vZHVsZS5leHBvcnRzID0gZGVidWc7DQoJZXhwb3J0cy5jb2VyY2UgPSBjb2VyY2U7DQoJZXhwb3J0cy5kaXNhYmxlID0gZGlzYWJsZTsNCglleHBvcnRzLmVuYWJsZSA9IGVuYWJsZTsNCglleHBvcnRzLmVuYWJsZWQgPSBlbmFibGVkOw0KCWV4cG9ydHMuaHVtYW5pemUgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDMpOw0KDQoJLyoqDQoJICogVGhlIGN1cnJlbnRseSBhY3RpdmUgZGVidWcgbW9kZSBuYW1lcywgYW5kIG5hbWVzIHRvIHNraXAuDQoJICovDQoNCglleHBvcnRzLm5hbWVzID0gW107DQoJZXhwb3J0cy5za2lwcyA9IFtdOw0KDQoJLyoqDQoJICogTWFwIG9mIHNwZWNpYWwgIiVuIiBoYW5kbGluZyBmdW5jdGlvbnMsIGZvciB0aGUgZGVidWcgImZvcm1hdCIgYXJndW1lbnQuDQoJICoNCgkgKiBWYWxpZCBrZXkgbmFtZXMgYXJlIGEgc2luZ2xlLCBsb3dlcmNhc2VkIGxldHRlciwgaS5lLiAibiIuDQoJICovDQoNCglleHBvcnRzLmZvcm1hdHRlcnMgPSB7fTsNCg0KCS8qKg0KCSAqIFByZXZpb3VzbHkgYXNzaWduZWQgY29sb3IuDQoJICovDQoNCgl2YXIgcHJldkNvbG9yID0gMDsNCg0KCS8qKg0KCSAqIFByZXZpb3VzIGxvZyB0aW1lc3RhbXAuDQoJICovDQoNCgl2YXIgcHJldlRpbWU7DQoNCgkvKioNCgkgKiBTZWxlY3QgYSBjb2xvci4NCgkgKg0KCSAqIEByZXR1cm4ge051bWJlcn0NCgkgKiBAYXBpIHByaXZhdGUNCgkgKi8NCg0KCWZ1bmN0aW9uIHNlbGVjdENvbG9yKCkgew0KCSAgcmV0dXJuIGV4cG9ydHMuY29sb3JzW3ByZXZDb2xvcisrICUgZXhwb3J0cy5jb2xvcnMubGVuZ3RoXTsNCgl9DQoNCgkvKioNCgkgKiBDcmVhdGUgYSBkZWJ1Z2dlciB3aXRoIHRoZSBnaXZlbiBgbmFtZXNwYWNlYC4NCgkgKg0KCSAqIEBwYXJhbSB7U3RyaW5nfSBuYW1lc3BhY2UNCgkgKiBAcmV0dXJuIHtGdW5jdGlvbn0NCgkgKiBAYXBpIHB1YmxpYw0KCSAqLw0KDQoJZnVuY3Rpb24gZGVidWcobmFtZXNwYWNlKSB7DQoNCgkgIC8vIGRlZmluZSB0aGUgYGRpc2FibGVkYCB2ZXJzaW9uDQoJICBmdW5jdGlvbiBkaXNhYmxlZCgpIHsNCgkgIH0NCgkgIGRpc2FibGVkLmVuYWJsZWQgPSBmYWxzZTsNCg0KCSAgLy8gZGVmaW5lIHRoZSBgZW5hYmxlZGAgdmVyc2lvbg0KCSAgZnVuY3Rpb24gZW5hYmxlZCgpIHsNCg0KCSAgICB2YXIgc2VsZiA9IGVuYWJsZWQ7DQoNCgkgICAgLy8gc2V0IGBkaWZmYCB0aW1lc3RhbXANCgkgICAgdmFyIGN1cnIgPSArbmV3IERhdGUoKTsNCgkgICAgdmFyIG1zID0gY3VyciAtIChwcmV2VGltZSB8fCBjdXJyKTsNCgkgICAgc2VsZi5kaWZmID0gbXM7DQoJICAgIHNlbGYucHJldiA9IHByZXZUaW1lOw0KCSAgICBzZWxmLmN1cnIgPSBjdXJyOw0KCSAgICBwcmV2VGltZSA9IGN1cnI7DQoNCgkgICAgLy8gYWRkIHRoZSBgY29sb3JgIGlmIG5vdCBzZXQNCgkgICAgaWYgKG51bGwgPT0gc2VsZi51c2VDb2xvcnMpIHNlbGYudXNlQ29sb3JzID0gZXhwb3J0cy51c2VDb2xvcnMoKTsNCgkgICAgaWYgKG51bGwgPT0gc2VsZi5jb2xvciAmJiBzZWxmLnVzZUNvbG9ycykgc2VsZi5jb2xvciA9IHNlbGVjdENvbG9yKCk7DQoNCgkgICAgdmFyIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMpOw0KDQoJICAgIGFyZ3NbMF0gPSBleHBvcnRzLmNvZXJjZShhcmdzWzBdKTsNCg0KCSAgICBpZiAoJ3N0cmluZycgIT09IHR5cGVvZiBhcmdzWzBdKSB7DQoJICAgICAgLy8gYW55dGhpbmcgZWxzZSBsZXQncyBpbnNwZWN0IHdpdGggJW8NCgkgICAgICBhcmdzID0gWyclbyddLmNvbmNhdChhcmdzKTsNCgkgICAgfQ0KDQoJICAgIC8vIGFwcGx5IGFueSBgZm9ybWF0dGVyc2AgdHJhbnNmb3JtYXRpb25zDQoJICAgIHZhciBpbmRleCA9IDA7DQoJICAgIGFyZ3NbMF0gPSBhcmdzWzBdLnJlcGxhY2UoLyUoW2EteiVdKS9nLCBmdW5jdGlvbihtYXRjaCwgZm9ybWF0KSB7DQoJICAgICAgLy8gaWYgd2UgZW5jb3VudGVyIGFuIGVzY2FwZWQgJSB0aGVuIGRvbid0IGluY3JlYXNlIHRoZSBhcnJheSBpbmRleA0KCSAgICAgIGlmIChtYXRjaCA9PT0gJyUlJykgcmV0dXJuIG1hdGNoOw0KCSAgICAgIGluZGV4Kys7DQoJICAgICAgdmFyIGZvcm1hdHRlciA9IGV4cG9ydHMuZm9ybWF0dGVyc1tmb3JtYXRdOw0KCSAgICAgIGlmICgnZnVuY3Rpb24nID09PSB0eXBlb2YgZm9ybWF0dGVyKSB7DQoJICAgICAgICB2YXIgdmFsID0gYXJnc1tpbmRleF07DQoJICAgICAgICBtYXRjaCA9IGZvcm1hdHRlci5jYWxsKHNlbGYsIHZhbCk7DQoNCgkgICAgICAgIC8vIG5vdyB3ZSBuZWVkIHRvIHJlbW92ZSBgYXJnc1tpbmRleF1gIHNpbmNlIGl0J3MgaW5saW5lZCBpbiB0aGUgYGZvcm1hdGANCgkgICAgICAgIGFyZ3Muc3BsaWNlKGluZGV4LCAxKTsNCgkgICAgICAgIGluZGV4LS07DQoJICAgICAgfQ0KCSAgICAgIHJldHVybiBtYXRjaDsNCgkgICAgfSk7DQoNCgkgICAgaWYgKCdmdW5jdGlvbicgPT09IHR5cGVvZiBleHBvcnRzLmZvcm1hdEFyZ3MpIHsNCgkgICAgICBhcmdzID0gZXhwb3J0cy5mb3JtYXRBcmdzLmFwcGx5KHNlbGYsIGFyZ3MpOw0KCSAgICB9DQoJICAgIHZhciBsb2dGbiA9IGVuYWJsZWQubG9nIHx8IGV4cG9ydHMubG9nIHx8IGNvbnNvbGUubG9nLmJpbmQoY29uc29sZSk7DQoJICAgIGxvZ0ZuLmFwcGx5KHNlbGYsIGFyZ3MpOw0KCSAgfQ0KCSAgZW5hYmxlZC5lbmFibGVkID0gdHJ1ZTsNCg0KCSAgdmFyIGZuID0gZXhwb3J0cy5lbmFibGVkKG5hbWVzcGFjZSkgPyBlbmFibGVkIDogZGlzYWJsZWQ7DQoNCgkgIGZuLm5hbWVzcGFjZSA9IG5hbWVzcGFjZTsNCg0KCSAgcmV0dXJuIGZuOw0KCX0NCg0KCS8qKg0KCSAqIEVuYWJsZXMgYSBkZWJ1ZyBtb2RlIGJ5IG5hbWVzcGFjZXMuIFRoaXMgY2FuIGluY2x1ZGUgbW9kZXMNCgkgKiBzZXBhcmF0ZWQgYnkgYSBjb2xvbiBhbmQgd2lsZGNhcmRzLg0KCSAqDQoJICogQHBhcmFtIHtTdHJpbmd9IG5hbWVzcGFjZXMNCgkgKiBAYXBpIHB1YmxpYw0KCSAqLw0KDQoJZnVuY3Rpb24gZW5hYmxlKG5hbWVzcGFjZXMpIHsNCgkgIGV4cG9ydHMuc2F2ZShuYW1lc3BhY2VzKTsNCg0KCSAgdmFyIHNwbGl0ID0gKG5hbWVzcGFjZXMgfHwgJycpLnNwbGl0KC9bXHMsXSsvKTsNCgkgIHZhciBsZW4gPSBzcGxpdC5sZW5ndGg7DQoNCgkgIGZvciAodmFyIGkgPSAwOyBpIDwgbGVuOyBpKyspIHsNCgkgICAgaWYgKCFzcGxpdFtpXSkgY29udGludWU7IC8vIGlnbm9yZSBlbXB0eSBzdHJpbmdzDQoJICAgIG5hbWVzcGFjZXMgPSBzcGxpdFtpXS5yZXBsYWNlKC9cKi9nLCAnLio/Jyk7DQoJICAgIGlmIChuYW1lc3BhY2VzWzBdID09PSAnLScpIHsNCgkgICAgICBleHBvcnRzLnNraXBzLnB1c2gobmV3IFJlZ0V4cCgnXicgKyBuYW1lc3BhY2VzLnN1YnN0cigxKSArICckJykpOw0KCSAgICB9IGVsc2Ugew0KCSAgICAgIGV4cG9ydHMubmFtZXMucHVzaChuZXcgUmVnRXhwKCdeJyArIG5hbWVzcGFjZXMgKyAnJCcpKTsNCgkgICAgfQ0KCSAgfQ0KCX0NCg0KCS8qKg0KCSAqIERpc2FibGUgZGVidWcgb3V0cHV0Lg0KCSAqDQoJICogQGFwaSBwdWJsaWMNCgkgKi8NCg0KCWZ1bmN0aW9uIGRpc2FibGUoKSB7DQoJICBleHBvcnRzLmVuYWJsZSgnJyk7DQoJfQ0KDQoJLyoqDQoJICogUmV0dXJucyB0cnVlIGlmIHRoZSBnaXZlbiBtb2RlIG5hbWUgaXMgZW5hYmxlZCwgZmFsc2Ugb3RoZXJ3aXNlLg0KCSAqDQoJICogQHBhcmFtIHtTdHJpbmd9IG5hbWUNCgkgKiBAcmV0dXJuIHtCb29sZWFufQ0KCSAqIEBhcGkgcHVibGljDQoJICovDQoNCglmdW5jdGlvbiBlbmFibGVkKG5hbWUpIHsNCgkgIHZhciBpLCBsZW47DQoJICBmb3IgKGkgPSAwLCBsZW4gPSBleHBvcnRzLnNraXBzLmxlbmd0aDsgaSA8IGxlbjsgaSsrKSB7DQoJICAgIGlmIChleHBvcnRzLnNraXBzW2ldLnRlc3QobmFtZSkpIHsNCgkgICAgICByZXR1cm4gZmFsc2U7DQoJICAgIH0NCgkgIH0NCgkgIGZvciAoaSA9IDAsIGxlbiA9IGV4cG9ydHMubmFtZXMubGVuZ3RoOyBpIDwgbGVuOyBpKyspIHsNCgkgICAgaWYgKGV4cG9ydHMubmFtZXNbaV0udGVzdChuYW1lKSkgew0KCSAgICAgIHJldHVybiB0cnVlOw0KCSAgICB9DQoJICB9DQoJICByZXR1cm4gZmFsc2U7DQoJfQ0KDQoJLyoqDQoJICogQ29lcmNlIGB2YWxgLg0KCSAqDQoJICogQHBhcmFtIHtNaXhlZH0gdmFsDQoJICogQHJldHVybiB7TWl4ZWR9DQoJICogQGFwaSBwcml2YXRlDQoJICovDQoNCglmdW5jdGlvbiBjb2VyY2UodmFsKSB7DQoJICBpZiAodmFsIGluc3RhbmNlb2YgRXJyb3IpIHJldHVybiB2YWwuc3RhY2sgfHwgdmFsLm1lc3NhZ2U7DQoJICByZXR1cm4gdmFsOw0KCX0NCg0KDQovKioqLyB9LA0KLyogMyAqLw0KLyoqKi8gZnVuY3Rpb24obW9kdWxlLCBleHBvcnRzKSB7DQoNCgkvKioNCgkgKiBIZWxwZXJzLg0KCSAqLw0KDQoJdmFyIHMgPSAxMDAwOw0KCXZhciBtID0gcyAqIDYwOw0KCXZhciBoID0gbSAqIDYwOw0KCXZhciBkID0gaCAqIDI0Ow0KCXZhciB5ID0gZCAqIDM2NS4yNTsNCg0KCS8qKg0KCSAqIFBhcnNlIG9yIGZvcm1hdCB0aGUgZ2l2ZW4gYHZhbGAuDQoJICoNCgkgKiBPcHRpb25zOg0KCSAqDQoJICogIC0gYGxvbmdgIHZlcmJvc2UgZm9ybWF0dGluZyBbZmFsc2VdDQoJICoNCgkgKiBAcGFyYW0ge1N0cmluZ3xOdW1iZXJ9IHZhbA0KCSAqIEBwYXJhbSB7T2JqZWN0fSBvcHRpb25zDQoJICogQHJldHVybiB7U3RyaW5nfE51bWJlcn0NCgkgKiBAYXBpIHB1YmxpYw0KCSAqLw0KDQoJbW9kdWxlLmV4cG9ydHMgPSBmdW5jdGlvbih2YWwsIG9wdGlvbnMpew0KCSAgb3B0aW9ucyA9IG9wdGlvbnMgfHwge307DQoJICBpZiAoJ3N0cmluZycgPT0gdHlwZW9mIHZhbCkgcmV0dXJuIHBhcnNlKHZhbCk7DQoJICByZXR1cm4gb3B0aW9ucy5sb25nDQoJICAgID8gbG9uZyh2YWwpDQoJICAgIDogc2hvcnQodmFsKTsNCgl9Ow0KDQoJLyoqDQoJICogUGFyc2UgdGhlIGdpdmVuIGBzdHJgIGFuZCByZXR1cm4gbWlsbGlzZWNvbmRzLg0KCSAqDQoJICogQHBhcmFtIHtTdHJpbmd9IHN0cg0KCSAqIEByZXR1cm4ge051bWJlcn0NCgkgKiBAYXBpIHByaXZhdGUNCgkgKi8NCg0KCWZ1bmN0aW9uIHBhcnNlKHN0cikgew0KCSAgc3RyID0gJycgKyBzdHI7DQoJICBpZiAoc3RyLmxlbmd0aCA+IDEwMDAwKSByZXR1cm47DQoJICB2YXIgbWF0Y2ggPSAvXigoPzpcZCspP1wuP1xkKykgKihtaWxsaXNlY29uZHM/fG1zZWNzP3xtc3xzZWNvbmRzP3xzZWNzP3xzfG1pbnV0ZXM/fG1pbnM/fG18aG91cnM/fGhycz98aHxkYXlzP3xkfHllYXJzP3x5cnM/fHkpPyQvaS5leGVjKHN0cik7DQoJICBpZiAoIW1hdGNoKSByZXR1cm47DQoJICB2YXIgbiA9IHBhcnNlRmxvYXQobWF0Y2hbMV0pOw0KCSAgdmFyIHR5cGUgPSAobWF0Y2hbMl0gfHwgJ21zJykudG9Mb3dlckNhc2UoKTsNCgkgIHN3aXRjaCAodHlwZSkgew0KCSAgICBjYXNlICd5ZWFycyc6DQoJICAgIGNhc2UgJ3llYXInOg0KCSAgICBjYXNlICd5cnMnOg0KCSAgICBjYXNlICd5cic6DQoJICAgIGNhc2UgJ3knOg0KCSAgICAgIHJldHVybiBuICogeTsNCgkgICAgY2FzZSAnZGF5cyc6DQoJICAgIGNhc2UgJ2RheSc6DQoJICAgIGNhc2UgJ2QnOg0KCSAgICAgIHJldHVybiBuICogZDsNCgkgICAgY2FzZSAnaG91cnMnOg0KCSAgICBjYXNlICdob3VyJzoNCgkgICAgY2FzZSAnaHJzJzoNCgkgICAgY2FzZSAnaHInOg0KCSAgICBjYXNlICdoJzoNCgkgICAgICByZXR1cm4gbiAqIGg7DQoJICAgIGNhc2UgJ21pbnV0ZXMnOg0KCSAgICBjYXNlICdtaW51dGUnOg0KCSAgICBjYXNlICdtaW5zJzoNCgkgICAgY2FzZSAnbWluJzoNCgkgICAgY2FzZSAnbSc6DQoJICAgICAgcmV0dXJuIG4gKiBtOw0KCSAgICBjYXNlICdzZWNvbmRzJzoNCgkgICAgY2FzZSAnc2Vjb25kJzoNCgkgICAgY2FzZSAnc2Vjcyc6DQoJICAgIGNhc2UgJ3NlYyc6DQoJICAgIGNhc2UgJ3MnOg0KCSAgICAgIHJldHVybiBuICogczsNCgkgICAgY2FzZSAnbWlsbGlzZWNvbmRzJzoNCgkgICAgY2FzZSAnbWlsbGlzZWNvbmQnOg0KCSAgICBjYXNlICdtc2Vjcyc6DQoJICAgIGNhc2UgJ21zZWMnOg0KCSAgICBjYXNlICdtcyc6DQoJICAgICAgcmV0dXJuIG47DQoJICB9DQoJfQ0KDQoJLyoqDQoJICogU2hvcnQgZm9ybWF0IGZvciBgbXNgLg0KCSAqDQoJICogQHBhcmFtIHtOdW1iZXJ9IG1zDQoJICogQHJldHVybiB7U3RyaW5nfQ0KCSAqIEBhcGkgcHJpdmF0ZQ0KCSAqLw0KDQoJZnVuY3Rpb24gc2hvcnQobXMpIHsNCgkgIGlmIChtcyA+PSBkKSByZXR1cm4gTWF0aC5yb3VuZChtcyAvIGQpICsgJ2QnOw0KCSAgaWYgKG1zID49IGgpIHJldHVybiBNYXRoLnJvdW5kKG1zIC8gaCkgKyAnaCc7DQoJICBpZiAobXMgPj0gbSkgcmV0dXJuIE1hdGgucm91bmQobXMgLyBtKSArICdtJzsNCgkgIGlmIChtcyA+PSBzKSByZXR1cm4gTWF0aC5yb3VuZChtcyAvIHMpICsgJ3MnOw0KCSAgcmV0dXJuIG1zICsgJ21zJzsNCgl9DQoNCgkvKioNCgkgKiBMb25nIGZvcm1hdCBmb3IgYG1zYC4NCgkgKg0KCSAqIEBwYXJhbSB7TnVtYmVyfSBtcw0KCSAqIEByZXR1cm4ge1N0cmluZ30NCgkgKiBAYXBpIHByaXZhdGUNCgkgKi8NCg0KCWZ1bmN0aW9uIGxvbmcobXMpIHsNCgkgIHJldHVybiBwbHVyYWwobXMsIGQsICdkYXknKQ0KCSAgICB8fCBwbHVyYWwobXMsIGgsICdob3VyJykNCgkgICAgfHwgcGx1cmFsKG1zLCBtLCAnbWludXRlJykNCgkgICAgfHwgcGx1cmFsKG1zLCBzLCAnc2Vjb25kJykNCgkgICAgfHwgbXMgKyAnIG1zJzsNCgl9DQoNCgkvKioNCgkgKiBQbHVyYWxpemF0aW9uIGhlbHBlci4NCgkgKi8NCg0KCWZ1bmN0aW9uIHBsdXJhbChtcywgbiwgbmFtZSkgew0KCSAgaWYgKG1zIDwgbikgcmV0dXJuOw0KCSAgaWYgKG1zIDwgbiAqIDEuNSkgcmV0dXJuIE1hdGguZmxvb3IobXMgLyBuKSArICcgJyArIG5hbWU7DQoJICByZXR1cm4gTWF0aC5jZWlsKG1zIC8gbikgKyAnICcgKyBuYW1lICsgJ3MnOw0KCX0NCg0KDQovKioqLyB9LA0KLyogNCAqLw0KLyoqKi8gZnVuY3Rpb24obW9kdWxlLCBleHBvcnRzLCBfX3dlYnBhY2tfcmVxdWlyZV9fKSB7DQoNCgkndXNlIHN0cmljdCc7DQoNCgl2YXIgX2NyZWF0ZUNsYXNzID0gZnVuY3Rpb24gKCkgeyBmdW5jdGlvbiBkZWZpbmVQcm9wZXJ0aWVzKHRhcmdldCwgcHJvcHMpIHsgZm9yICh2YXIgaSA9IDA7IGkgPCBwcm9wcy5sZW5ndGg7IGkrKykgeyB2YXIgZGVzY3JpcHRvciA9IHByb3BzW2ldOyBkZXNjcmlwdG9yLmVudW1lcmFibGUgPSBkZXNjcmlwdG9yLmVudW1lcmFibGUgfHwgZmFsc2U7IGRlc2NyaXB0b3IuY29uZmlndXJhYmxlID0gdHJ1ZTsgaWYgKCJ2YWx1ZSIgaW4gZGVzY3JpcHRvcikgZGVzY3JpcHRvci53cml0YWJsZSA9IHRydWU7IE9iamVjdC5kZWZpbmVQcm9wZXJ0eSh0YXJnZXQsIGRlc2NyaXB0b3Iua2V5LCBkZXNjcmlwdG9yKTsgfSB9IHJldHVybiBmdW5jdGlvbiAoQ29uc3RydWN0b3IsIHByb3RvUHJvcHMsIHN0YXRpY1Byb3BzKSB7IGlmIChwcm90b1Byb3BzKSBkZWZpbmVQcm9wZXJ0aWVzKENvbnN0cnVjdG9yLnByb3RvdHlwZSwgcHJvdG9Qcm9wcyk7IGlmIChzdGF0aWNQcm9wcykgZGVmaW5lUHJvcGVydGllcyhDb25zdHJ1Y3Rvciwgc3RhdGljUHJvcHMpOyByZXR1cm4gQ29uc3RydWN0b3I7IH07IH0oKTsNCg0KCWZ1bmN0aW9uIF9jbGFzc0NhbGxDaGVjayhpbnN0YW5jZSwgQ29uc3RydWN0b3IpIHsgaWYgKCEoaW5zdGFuY2UgaW5zdGFuY2VvZiBDb25zdHJ1Y3RvcikpIHsgdGhyb3cgbmV3IFR5cGVFcnJvcigiQ2Fubm90IGNhbGwgYSBjbGFzcyBhcyBhIGZ1bmN0aW9uIik7IH0gfQ0KDQoJZnVuY3Rpb24gX3Bvc3NpYmxlQ29uc3RydWN0b3JSZXR1cm4oc2VsZiwgY2FsbCkgeyBpZiAoIXNlbGYpIHsgdGhyb3cgbmV3IFJlZmVyZW5jZUVycm9yKCJ0aGlzIGhhc24ndCBiZWVuIGluaXRpYWxpc2VkIC0gc3VwZXIoKSBoYXNuJ3QgYmVlbiBjYWxsZWQiKTsgfSByZXR1cm4gY2FsbCAmJiAodHlwZW9mIGNhbGwgPT09ICJvYmplY3QiIHx8IHR5cGVvZiBjYWxsID09PSAiZnVuY3Rpb24iKSA/IGNhbGwgOiBzZWxmOyB9DQoNCglmdW5jdGlvbiBfaW5oZXJpdHMoc3ViQ2xhc3MsIHN1cGVyQ2xhc3MpIHsgaWYgKHR5cGVvZiBzdXBlckNsYXNzICE9PSAiZnVuY3Rpb24iICYmIHN1cGVyQ2xhc3MgIT09IG51bGwpIHsgdGhyb3cgbmV3IFR5cGVFcnJvcigiU3VwZXIgZXhwcmVzc2lvbiBtdXN0IGVpdGhlciBiZSBudWxsIG9yIGEgZnVuY3Rpb24sIG5vdCAiICsgdHlwZW9mIHN1cGVyQ2xhc3MpOyB9IHN1YkNsYXNzLnByb3RvdHlwZSA9IE9iamVjdC5jcmVhdGUoc3VwZXJDbGFzcyAmJiBzdXBlckNsYXNzLnByb3RvdHlwZSwgeyBjb25zdHJ1Y3RvcjogeyB2YWx1ZTogc3ViQ2xhc3MsIGVudW1lcmFibGU6IGZhbHNlLCB3cml0YWJsZTogdHJ1ZSwgY29uZmlndXJhYmxlOiB0cnVlIH0gfSk7IGlmIChzdXBlckNsYXNzKSBPYmplY3Quc2V0UHJvdG90eXBlT2YgPyBPYmplY3Quc2V0UHJvdG90eXBlT2Yoc3ViQ2xhc3MsIHN1cGVyQ2xhc3MpIDogc3ViQ2xhc3MuX19wcm90b19fID0gc3VwZXJDbGFzczsgfQ0KDQoJdmFyIE1lc3NhZ2UgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDUpOw0KDQoJdmFyIEV2ZW50RW1pdHRlciA9IF9fd2VicGFja19yZXF1aXJlX18oNik7DQoNCgl2YXIgaWRDb3VudGVyID0gMDsNCgl2YXIgcG9zdGVkTWVzc2FnZXMgPSBuZXcgTWFwKCk7DQoNCgl2YXIgTWVzc2FnZUhhbmRsZXIgPSBmdW5jdGlvbiAoX0V2ZW50RW1pdHRlcikgew0KCSAgICBfaW5oZXJpdHMoTWVzc2FnZUhhbmRsZXIsIF9FdmVudEVtaXR0ZXIpOw0KDQoJICAgIGZ1bmN0aW9uIE1lc3NhZ2VIYW5kbGVyKCkgew0KCSAgICAgICAgX2NsYXNzQ2FsbENoZWNrKHRoaXMsIE1lc3NhZ2VIYW5kbGVyKTsNCg0KCSAgICAgICAgdmFyIF90aGlzID0gX3Bvc3NpYmxlQ29uc3RydWN0b3JSZXR1cm4odGhpcywgT2JqZWN0LmdldFByb3RvdHlwZU9mKE1lc3NhZ2VIYW5kbGVyKS5jYWxsKHRoaXMpKTsNCg0KCSAgICAgICAgX3RoaXMucmVhZHlUb1Bvc3QgPSBmYWxzZTsNCgkgICAgICAgIF90aGlzLnJlYWR5VG9IYW5kbGUgPSBmYWxzZTsNCgkgICAgICAgIF90aGlzLndpbmRvd0lEID0gbnVsbDsNCgkgICAgICAgIF90aGlzLm1lc3NhZ2VTb3VyY2UgPSBudWxsOw0KCSAgICAgICAgX3RoaXMucGVuZGluZ01lc3NhZ2VzID0gW107DQoJICAgICAgICBfdGhpcy51bmhhbmRsZWRNZXNzYWdlcyA9IFtdOw0KCSAgICAgICAgcmV0dXJuIF90aGlzOw0KCSAgICB9DQoNCgkgICAgX2NyZWF0ZUNsYXNzKE1lc3NhZ2VIYW5kbGVyLCBbew0KCSAgICAgICAga2V5OiAnaW5pdCcsDQoJICAgICAgICB2YWx1ZTogZnVuY3Rpb24gaW5pdChtZXNzYWdlU291cmNlKSB7DQoJICAgICAgICAgICAgdGhpcy5yZWFkeVRvUG9zdCA9IHRydWU7DQoJICAgICAgICAgICAgdGhpcy53aW5kb3dJRCA9IE1hdGguZmxvb3Iod2luZG93LnBlcmZvcm1hbmNlLm5vdygpKTsNCgkgICAgICAgICAgICB0aGlzLm1lc3NhZ2VTb3VyY2UgPSBtZXNzYWdlU291cmNlOw0KCSAgICAgICAgICAgIHRoaXMubWVzc2FnZVNvdXJjZS5wb3N0TWVzc2FnZSh7DQoJICAgICAgICAgICAgICAgIHR5cGU6ICdhZG1pbi5jb25uZWN0JywNCgkgICAgICAgICAgICAgICAgd2luZG93SUQ6IHRoaXMud2luZG93SUQNCgkgICAgICAgICAgICB9LCAnKicpOw0KCSAgICAgICAgICAgIHRoaXMucG9zdFBlbmRpbmdNZXNzYWdlcygpOw0KCSAgICAgICAgfQ0KCSAgICB9LCB7DQoJICAgICAgICBrZXk6ICdwb3N0TWVzc2FnZScsDQoJICAgICAgICB2YWx1ZTogZnVuY3Rpb24gcG9zdE1lc3NhZ2UodHlwZSwgbWVzc2FnZSkgew0KCSAgICAgICAgICAgIHZhciBpZCA9ICsraWRDb3VudGVyOw0KCSAgICAgICAgICAgIHZhciB0b1Bvc3QgPSB7DQoJICAgICAgICAgICAgICAgIHR5cGU6IHR5cGUsDQoJICAgICAgICAgICAgICAgIG1lc3NhZ2U6IG1lc3NhZ2UsDQoJICAgICAgICAgICAgICAgIG1lc3NhZ2VJRDogaWQsDQoJICAgICAgICAgICAgICAgIHdpbmRvd0lEOiB0aGlzLndpbmRvd0lEDQoJICAgICAgICAgICAgfTsNCgkgICAgICAgICAgICB2YXIgdGhlTWVzc2FnZSA9IG5ldyBNZXNzYWdlKGlkLCB0b1Bvc3QpOw0KCSAgICAgICAgICAgIGlmICh0aGlzLnJlYWR5VG9Qb3N0KSB7DQoJICAgICAgICAgICAgICAgIHRoaXMubWVzc2FnZVNvdXJjZS5wb3N0TWVzc2FnZSh0b1Bvc3QsICcqJyk7DQoJICAgICAgICAgICAgICAgIHBvc3RlZE1lc3NhZ2VzLnNldChpZCwgdGhlTWVzc2FnZSk7DQoJICAgICAgICAgICAgfSBlbHNlIHsNCgkgICAgICAgICAgICAgICAgdGhpcy5wZW5kaW5nTWVzc2FnZXMucHVzaCh0aGVNZXNzYWdlKTsNCgkgICAgICAgICAgICB9DQoJICAgICAgICAgICAgcmV0dXJuIHRoZU1lc3NhZ2U7DQoJICAgICAgICB9DQoJICAgIH0sIHsNCgkgICAgICAgIGtleTogJ3Bvc3RQZW5kaW5nTWVzc2FnZXMnLA0KCSAgICAgICAgdmFsdWU6IGZ1bmN0aW9uIHBvc3RQZW5kaW5nTWVzc2FnZXMoKSB7DQoJICAgICAgICAgICAgdmFyIF9pdGVyYXRvck5vcm1hbENvbXBsZXRpb24gPSB0cnVlOw0KCSAgICAgICAgICAgIHZhciBfZGlkSXRlcmF0b3JFcnJvciA9IGZhbHNlOw0KCSAgICAgICAgICAgIHZhciBfaXRlcmF0b3JFcnJvciA9IHVuZGVmaW5lZDsNCg0KCSAgICAgICAgICAgIHRyeSB7DQoJICAgICAgICAgICAgICAgIGZvciAodmFyIF9pdGVyYXRvciA9IHRoaXMucGVuZGluZ01lc3NhZ2VzW1N5bWJvbC5pdGVyYXRvcl0oKSwgX3N0ZXA7ICEoX2l0ZXJhdG9yTm9ybWFsQ29tcGxldGlvbiA9IChfc3RlcCA9IF9pdGVyYXRvci5uZXh0KCkpLmRvbmUpOyBfaXRlcmF0b3JOb3JtYWxDb21wbGV0aW9uID0gdHJ1ZSkgew0KCSAgICAgICAgICAgICAgICAgICAgdmFyIG1lc3NhZ2UgPSBfc3RlcC52YWx1ZTsNCg0KCSAgICAgICAgICAgICAgICAgICAgbWVzc2FnZS5kYXRhLndpbmRvd0lEID0gdGhpcy53aW5kb3dJRDsNCgkgICAgICAgICAgICAgICAgICAgIHRoaXMubWVzc2FnZVNvdXJjZS5wb3N0TWVzc2FnZShtZXNzYWdlLmRhdGEsICcqJyk7DQoJICAgICAgICAgICAgICAgICAgICBwb3N0ZWRNZXNzYWdlcy5zZXQobWVzc2FnZS5pZCwgbWVzc2FnZSk7DQoJICAgICAgICAgICAgICAgIH0NCgkgICAgICAgICAgICB9IGNhdGNoIChlcnIpIHsNCgkgICAgICAgICAgICAgICAgX2RpZEl0ZXJhdG9yRXJyb3IgPSB0cnVlOw0KCSAgICAgICAgICAgICAgICBfaXRlcmF0b3JFcnJvciA9IGVycjsNCgkgICAgICAgICAgICB9IGZpbmFsbHkgew0KCSAgICAgICAgICAgICAgICB0cnkgew0KCSAgICAgICAgICAgICAgICAgICAgaWYgKCFfaXRlcmF0b3JOb3JtYWxDb21wbGV0aW9uICYmIF9pdGVyYXRvci5yZXR1cm4pIHsNCgkgICAgICAgICAgICAgICAgICAgICAgICBfaXRlcmF0b3IucmV0dXJuKCk7DQoJICAgICAgICAgICAgICAgICAgICB9DQoJICAgICAgICAgICAgICAgIH0gZmluYWxseSB7DQoJICAgICAgICAgICAgICAgICAgICBpZiAoX2RpZEl0ZXJhdG9yRXJyb3IpIHsNCgkgICAgICAgICAgICAgICAgICAgICAgICB0aHJvdyBfaXRlcmF0b3JFcnJvcjsNCgkgICAgICAgICAgICAgICAgICAgIH0NCgkgICAgICAgICAgICAgICAgfQ0KCSAgICAgICAgICAgIH0NCgkgICAgICAgIH0NCgkgICAgfSwgew0KCSAgICAgICAga2V5OiAnaGFuZGxlUGVuZGluZ01lc3NhZ2VzJywNCgkgICAgICAgIHZhbHVlOiBmdW5jdGlvbiBoYW5kbGVQZW5kaW5nTWVzc2FnZXMoKSB7DQoJICAgICAgICAgICAgdGhpcy5yZWFkeVRvSGFuZGxlID0gdHJ1ZTsNCgkgICAgICAgICAgICBmb3IgKHZhciBpID0gMDsgaSA8IHRoaXMudW5oYW5kbGVkTWVzc2FnZXMubGVuZ3RoOyBpKyspIHsNCgkgICAgICAgICAgICAgICAgdGhpcy5oYW5kbGVNZXNzYWdlKHRoaXMudW5oYW5kbGVkTWVzc2FnZXNbaV0pOw0KCSAgICAgICAgICAgIH0NCgkgICAgICAgICAgICB0aGlzLnVuaGFuZGxlZE1lc3NhZ2VzID0gW107DQoJICAgICAgICB9DQoJICAgIH0sIHsNCgkgICAgICAgIGtleTogJ2hhbmRsZU1lc3NhZ2UnLA0KCSAgICAgICAgdmFsdWU6IGZ1bmN0aW9uIGhhbmRsZU1lc3NhZ2UoZGF0YSkgew0KCSAgICAgICAgICAgIGlmICghdGhpcy5yZWFkeVRvSGFuZGxlKSB7DQoJICAgICAgICAgICAgICAgIHRoaXMudW5oYW5kbGVkTWVzc2FnZXMucHVzaChkYXRhKTsNCgkgICAgICAgICAgICAgICAgcmV0dXJuOw0KCSAgICAgICAgICAgIH0NCgkgICAgICAgICAgICBpZiAoIXBvc3RlZE1lc3NhZ2VzLmhhcyhkYXRhLm1lc3NhZ2VJRCkpIHsNCgkgICAgICAgICAgICAgICAgcmV0dXJuIHRoaXMuZW1pdCgnbWVzc2FnZScsIGRhdGEpOw0KCSAgICAgICAgICAgIH0NCgkgICAgICAgICAgICB2YXIgbWVzc2FnZSA9IHBvc3RlZE1lc3NhZ2VzLmdldChkYXRhLm1lc3NhZ2VJRCk7DQoJICAgICAgICAgICAgaWYgKGRhdGEuc3RhdHVzKSB7DQoJICAgICAgICAgICAgICAgIGlmIChkYXRhLnN0YXR1cyA9PT0gJ2Vycm9yJykgew0KCSAgICAgICAgICAgICAgICAgICAgbWVzc2FnZS5fcmVqZWN0KGRhdGEpOw0KCSAgICAgICAgICAgICAgICAgICAgcG9zdGVkTWVzc2FnZXMuZGVsZXRlKGRhdGEubWVzc2FnZUlEKTsNCgkgICAgICAgICAgICAgICAgfSBlbHNlIGlmIChkYXRhLnN0YXR1cyA9PT0gJ3N1Y2Nlc3MnKSB7DQoJICAgICAgICAgICAgICAgICAgICBtZXNzYWdlLl9yZXNvbHZlKGRhdGEpOw0KCSAgICAgICAgICAgICAgICAgICAgcG9zdGVkTWVzc2FnZXMuZGVsZXRlKGRhdGEubWVzc2FnZUlEKTsNCgkgICAgICAgICAgICAgICAgfSBlbHNlIHsNCgkgICAgICAgICAgICAgICAgICAgIG1lc3NhZ2UuZW1pdChkYXRhLnN0YXR1cywgZGF0YSk7DQoJICAgICAgICAgICAgICAgIH0NCgkgICAgICAgICAgICB9IGVsc2Ugew0KCSAgICAgICAgICAgICAgICAvLyBubyBzdGF0dXMgaXMgY29uc2lkZXJlZCBhIHN1Y2Nlc3MNCgkgICAgICAgICAgICAgICAgbWVzc2FnZS5fcmVzb2x2ZShkYXRhKTsNCgkgICAgICAgICAgICAgICAgcG9zdGVkTWVzc2FnZXMuZGVsZXRlKGRhdGEubWVzc2FnZUlEKTsNCgkgICAgICAgICAgICB9DQoJICAgICAgICB9DQoJICAgIH1dKTsNCg0KCSAgICByZXR1cm4gTWVzc2FnZUhhbmRsZXI7DQoJfShFdmVudEVtaXR0ZXIpOw0KDQoJbW9kdWxlLmV4cG9ydHMgPSBNZXNzYWdlSGFuZGxlcjsNCg0KLyoqKi8gfSwNCi8qIDUgKi8NCi8qKiovIGZ1bmN0aW9uKG1vZHVsZSwgZXhwb3J0cywgX193ZWJwYWNrX3JlcXVpcmVfXykgew0KDQoJJ3VzZSBzdHJpY3QnOw0KDQoJdmFyIF9jcmVhdGVDbGFzcyA9IGZ1bmN0aW9uICgpIHsgZnVuY3Rpb24gZGVmaW5lUHJvcGVydGllcyh0YXJnZXQsIHByb3BzKSB7IGZvciAodmFyIGkgPSAwOyBpIDwgcHJvcHMubGVuZ3RoOyBpKyspIHsgdmFyIGRlc2NyaXB0b3IgPSBwcm9wc1tpXTsgZGVzY3JpcHRvci5lbnVtZXJhYmxlID0gZGVzY3JpcHRvci5lbnVtZXJhYmxlIHx8IGZhbHNlOyBkZXNjcmlwdG9yLmNvbmZpZ3VyYWJsZSA9IHRydWU7IGlmICgidmFsdWUiIGluIGRlc2NyaXB0b3IpIGRlc2NyaXB0b3Iud3JpdGFibGUgPSB0cnVlOyBPYmplY3QuZGVmaW5lUHJvcGVydHkodGFyZ2V0LCBkZXNjcmlwdG9yLmtleSwgZGVzY3JpcHRvcik7IH0gfSByZXR1cm4gZnVuY3Rpb24gKENvbnN0cnVjdG9yLCBwcm90b1Byb3BzLCBzdGF0aWNQcm9wcykgeyBpZiAocHJvdG9Qcm9wcykgZGVmaW5lUHJvcGVydGllcyhDb25zdHJ1Y3Rvci5wcm90b3R5cGUsIHByb3RvUHJvcHMpOyBpZiAoc3RhdGljUHJvcHMpIGRlZmluZVByb3BlcnRpZXMoQ29uc3RydWN0b3IsIHN0YXRpY1Byb3BzKTsgcmV0dXJuIENvbnN0cnVjdG9yOyB9OyB9KCk7DQoNCglmdW5jdGlvbiBfY2xhc3NDYWxsQ2hlY2soaW5zdGFuY2UsIENvbnN0cnVjdG9yKSB7IGlmICghKGluc3RhbmNlIGluc3RhbmNlb2YgQ29uc3RydWN0b3IpKSB7IHRocm93IG5ldyBUeXBlRXJyb3IoIkNhbm5vdCBjYWxsIGEgY2xhc3MgYXMgYSBmdW5jdGlvbiIpOyB9IH0NCg0KCWZ1bmN0aW9uIF9wb3NzaWJsZUNvbnN0cnVjdG9yUmV0dXJuKHNlbGYsIGNhbGwpIHsgaWYgKCFzZWxmKSB7IHRocm93IG5ldyBSZWZlcmVuY2VFcnJvcigidGhpcyBoYXNuJ3QgYmVlbiBpbml0aWFsaXNlZCAtIHN1cGVyKCkgaGFzbid0IGJlZW4gY2FsbGVkIik7IH0gcmV0dXJuIGNhbGwgJiYgKHR5cGVvZiBjYWxsID09PSAib2JqZWN0IiB8fCB0eXBlb2YgY2FsbCA9PT0gImZ1bmN0aW9uIikgPyBjYWxsIDogc2VsZjsgfQ0KDQoJZnVuY3Rpb24gX2luaGVyaXRzKHN1YkNsYXNzLCBzdXBlckNsYXNzKSB7IGlmICh0eXBlb2Ygc3VwZXJDbGFzcyAhPT0gImZ1bmN0aW9uIiAmJiBzdXBlckNsYXNzICE9PSBudWxsKSB7IHRocm93IG5ldyBUeXBlRXJyb3IoIlN1cGVyIGV4cHJlc3Npb24gbXVzdCBlaXRoZXIgYmUgbnVsbCBvciBhIGZ1bmN0aW9uLCBub3QgIiArIHR5cGVvZiBzdXBlckNsYXNzKTsgfSBzdWJDbGFzcy5wcm90b3R5cGUgPSBPYmplY3QuY3JlYXRlKHN1cGVyQ2xhc3MgJiYgc3VwZXJDbGFzcy5wcm90b3R5cGUsIHsgY29uc3RydWN0b3I6IHsgdmFsdWU6IHN1YkNsYXNzLCBlbnVtZXJhYmxlOiBmYWxzZSwgd3JpdGFibGU6IHRydWUsIGNvbmZpZ3VyYWJsZTogdHJ1ZSB9IH0pOyBpZiAoc3VwZXJDbGFzcykgT2JqZWN0LnNldFByb3RvdHlwZU9mID8gT2JqZWN0LnNldFByb3RvdHlwZU9mKHN1YkNsYXNzLCBzdXBlckNsYXNzKSA6IHN1YkNsYXNzLl9fcHJvdG9fXyA9IHN1cGVyQ2xhc3M7IH0NCg0KCXZhciBFdmVudEVtaXR0ZXIgPSBfX3dlYnBhY2tfcmVxdWlyZV9fKDYpLkV2ZW50RW1pdHRlcjsNCgl2YXIgcHJvbWlzZSA9IFN5bWJvbCgpOw0KDQoJdmFyIE1lc3NhZ2UgPSBmdW5jdGlvbiAoX0V2ZW50RW1pdHRlcikgew0KCSAgICBfaW5oZXJpdHMoTWVzc2FnZSwgX0V2ZW50RW1pdHRlcik7DQoNCgkgICAgZnVuY3Rpb24gTWVzc2FnZShpZCwgZGF0YSkgew0KCSAgICAgICAgX2NsYXNzQ2FsbENoZWNrKHRoaXMsIE1lc3NhZ2UpOw0KDQoJICAgICAgICB2YXIgX3RoaXMgPSBfcG9zc2libGVDb25zdHJ1Y3RvclJldHVybih0aGlzLCBPYmplY3QuZ2V0UHJvdG90eXBlT2YoTWVzc2FnZSkuY2FsbCh0aGlzKSk7DQoNCgkgICAgICAgIF90aGlzLmlkID0gaWQ7DQoJICAgICAgICBfdGhpcy5kYXRhID0gZGF0YTsNCgkgICAgICAgIF90aGlzW3Byb21pc2VdID0gbmV3IFByb21pc2UoZnVuY3Rpb24gKHJlc29sdmUsIHJlamVjdCkgew0KCSAgICAgICAgICAgIF90aGlzLl9yZXNvbHZlID0gcmVzb2x2ZTsNCgkgICAgICAgICAgICBfdGhpcy5fcmVqZWN0ID0gcmVqZWN0Ow0KCSAgICAgICAgfSk7DQoJICAgICAgICByZXR1cm4gX3RoaXM7DQoJICAgIH0NCg0KCSAgICBfY3JlYXRlQ2xhc3MoTWVzc2FnZSwgW3sNCgkgICAgICAgIGtleTogJ3RoZW4nLA0KCSAgICAgICAgdmFsdWU6IGZ1bmN0aW9uIHRoZW4ob25SZXNvbHZlLCBvblJlamVjdCkgew0KCSAgICAgICAgICAgIHJldHVybiB0aGlzW3Byb21pc2VdLnRoZW4ob25SZXNvbHZlLCBvblJlamVjdCk7DQoJICAgICAgICB9DQoJICAgIH0sIHsNCgkgICAgICAgIGtleTogJ2NhdGNoJywNCgkgICAgICAgIHZhbHVlOiBmdW5jdGlvbiBfY2F0Y2gob25SZWplY3QpIHsNCgkgICAgICAgICAgICByZXR1cm4gdGhpc1twcm9taXNlXS5jYXRjaChvblJlamVjdCk7DQoJICAgICAgICB9DQoJICAgIH1dKTsNCg0KCSAgICByZXR1cm4gTWVzc2FnZTsNCgl9KEV2ZW50RW1pdHRlcik7DQoNCgltb2R1bGUuZXhwb3J0cyA9IE1lc3NhZ2U7DQoNCi8qKiovIH0sDQovKiA2ICovDQovKioqLyBmdW5jdGlvbihtb2R1bGUsIGV4cG9ydHMpIHsNCg0KCS8vIENvcHlyaWdodCBKb3llbnQsIEluYy4gYW5kIG90aGVyIE5vZGUgY29udHJpYnV0b3JzLg0KCS8vDQoJLy8gUGVybWlzc2lvbiBpcyBoZXJlYnkgZ3JhbnRlZCwgZnJlZSBvZiBjaGFyZ2UsIHRvIGFueSBwZXJzb24gb2J0YWluaW5nIGENCgkvLyBjb3B5IG9mIHRoaXMgc29mdHdhcmUgYW5kIGFzc29jaWF0ZWQgZG9jdW1lbnRhdGlvbiBmaWxlcyAodGhlDQoJLy8gIlNvZnR3YXJlIiksIHRvIGRlYWwgaW4gdGhlIFNvZnR3YXJlIHdpdGhvdXQgcmVzdHJpY3Rpb24sIGluY2x1ZGluZw0KCS8vIHdpdGhvdXQgbGltaXRhdGlvbiB0aGUgcmlnaHRzIHRvIHVzZSwgY29weSwgbW9kaWZ5LCBtZXJnZSwgcHVibGlzaCwNCgkvLyBkaXN0cmlidXRlLCBzdWJsaWNlbnNlLCBhbmQvb3Igc2VsbCBjb3BpZXMgb2YgdGhlIFNvZnR3YXJlLCBhbmQgdG8gcGVybWl0DQoJLy8gcGVyc29ucyB0byB3aG9tIHRoZSBTb2Z0d2FyZSBpcyBmdXJuaXNoZWQgdG8gZG8gc28sIHN1YmplY3QgdG8gdGhlDQoJLy8gZm9sbG93aW5nIGNvbmRpdGlvbnM6DQoJLy8NCgkvLyBUaGUgYWJvdmUgY29weXJpZ2h0IG5vdGljZSBhbmQgdGhpcyBwZXJtaXNzaW9uIG5vdGljZSBzaGFsbCBiZSBpbmNsdWRlZA0KCS8vIGluIGFsbCBjb3BpZXMgb3Igc3Vic3RhbnRpYWwgcG9ydGlvbnMgb2YgdGhlIFNvZnR3YXJlLg0KCS8vDQoJLy8gVEhFIFNPRlRXQVJFIElTIFBST1ZJREVEICJBUyBJUyIsIFdJVEhPVVQgV0FSUkFOVFkgT0YgQU5ZIEtJTkQsIEVYUFJFU1MNCgkvLyBPUiBJTVBMSUVELCBJTkNMVURJTkcgQlVUIE5PVCBMSU1JVEVEIFRPIFRIRSBXQVJSQU5USUVTIE9GDQoJLy8gTUVSQ0hBTlRBQklMSVRZLCBGSVRORVNTIEZPUiBBIFBBUlRJQ1VMQVIgUFVSUE9TRSBBTkQgTk9OSU5GUklOR0VNRU5ULiBJTg0KCS8vIE5PIEVWRU5UIFNIQUxMIFRIRSBBVVRIT1JTIE9SIENPUFlSSUdIVCBIT0xERVJTIEJFIExJQUJMRSBGT1IgQU5ZIENMQUlNLA0KCS8vIERBTUFHRVMgT1IgT1RIRVIgTElBQklMSVRZLCBXSEVUSEVSIElOIEFOIEFDVElPTiBPRiBDT05UUkFDVCwgVE9SVCBPUg0KCS8vIE9USEVSV0lTRSwgQVJJU0lORyBGUk9NLCBPVVQgT0YgT1IgSU4gQ09OTkVDVElPTiBXSVRIIFRIRSBTT0ZUV0FSRSBPUiBUSEUNCgkvLyBVU0UgT1IgT1RIRVIgREVBTElOR1MgSU4gVEhFIFNPRlRXQVJFLg0KDQoJZnVuY3Rpb24gRXZlbnRFbWl0dGVyKCkgew0KCSAgdGhpcy5fZXZlbnRzID0gdGhpcy5fZXZlbnRzIHx8IHt9Ow0KCSAgdGhpcy5fbWF4TGlzdGVuZXJzID0gdGhpcy5fbWF4TGlzdGVuZXJzIHx8IHVuZGVmaW5lZDsNCgl9DQoJbW9kdWxlLmV4cG9ydHMgPSBFdmVudEVtaXR0ZXI7DQoNCgkvLyBCYWNrd2FyZHMtY29tcGF0IHdpdGggbm9kZSAwLjEwLngNCglFdmVudEVtaXR0ZXIuRXZlbnRFbWl0dGVyID0gRXZlbnRFbWl0dGVyOw0KDQoJRXZlbnRFbWl0dGVyLnByb3RvdHlwZS5fZXZlbnRzID0gdW5kZWZpbmVkOw0KCUV2ZW50RW1pdHRlci5wcm90b3R5cGUuX21heExpc3RlbmVycyA9IHVuZGVmaW5lZDsNCg0KCS8vIEJ5IGRlZmF1bHQgRXZlbnRFbWl0dGVycyB3aWxsIHByaW50IGEgd2FybmluZyBpZiBtb3JlIHRoYW4gMTAgbGlzdGVuZXJzIGFyZQ0KCS8vIGFkZGVkIHRvIGl0LiBUaGlzIGlzIGEgdXNlZnVsIGRlZmF1bHQgd2hpY2ggaGVscHMgZmluZGluZyBtZW1vcnkgbGVha3MuDQoJRXZlbnRFbWl0dGVyLmRlZmF1bHRNYXhMaXN0ZW5lcnMgPSAxMDsNCg0KCS8vIE9idmlvdXNseSBub3QgYWxsIEVtaXR0ZXJzIHNob3VsZCBiZSBsaW1pdGVkIHRvIDEwLiBUaGlzIGZ1bmN0aW9uIGFsbG93cw0KCS8vIHRoYXQgdG8gYmUgaW5jcmVhc2VkLiBTZXQgdG8gemVybyBmb3IgdW5saW1pdGVkLg0KCUV2ZW50RW1pdHRlci5wcm90b3R5cGUuc2V0TWF4TGlzdGVuZXJzID0gZnVuY3Rpb24obikgew0KCSAgaWYgKCFpc051bWJlcihuKSB8fCBuIDwgMCB8fCBpc05hTihuKSkNCgkgICAgdGhyb3cgVHlwZUVycm9yKCduIG11c3QgYmUgYSBwb3NpdGl2ZSBudW1iZXInKTsNCgkgIHRoaXMuX21heExpc3RlbmVycyA9IG47DQoJICByZXR1cm4gdGhpczsNCgl9Ow0KDQoJRXZlbnRFbWl0dGVyLnByb3RvdHlwZS5lbWl0ID0gZnVuY3Rpb24odHlwZSkgew0KCSAgdmFyIGVyLCBoYW5kbGVyLCBsZW4sIGFyZ3MsIGksIGxpc3RlbmVyczsNCg0KCSAgaWYgKCF0aGlzLl9ldmVudHMpDQoJICAgIHRoaXMuX2V2ZW50cyA9IHt9Ow0KDQoJICAvLyBJZiB0aGVyZSBpcyBubyAnZXJyb3InIGV2ZW50IGxpc3RlbmVyIHRoZW4gdGhyb3cuDQoJICBpZiAodHlwZSA9PT0gJ2Vycm9yJykgew0KCSAgICBpZiAoIXRoaXMuX2V2ZW50cy5lcnJvciB8fA0KCSAgICAgICAgKGlzT2JqZWN0KHRoaXMuX2V2ZW50cy5lcnJvcikgJiYgIXRoaXMuX2V2ZW50cy5lcnJvci5sZW5ndGgpKSB7DQoJICAgICAgZXIgPSBhcmd1bWVudHNbMV07DQoJICAgICAgaWYgKGVyIGluc3RhbmNlb2YgRXJyb3IpIHsNCgkgICAgICAgIHRocm93IGVyOyAvLyBVbmhhbmRsZWQgJ2Vycm9yJyBldmVudA0KCSAgICAgIH0NCgkgICAgICB0aHJvdyBUeXBlRXJyb3IoJ1VuY2F1Z2h0LCB1bnNwZWNpZmllZCAiZXJyb3IiIGV2ZW50LicpOw0KCSAgICB9DQoJICB9DQoNCgkgIGhhbmRsZXIgPSB0aGlzLl9ldmVudHNbdHlwZV07DQoNCgkgIGlmIChpc1VuZGVmaW5lZChoYW5kbGVyKSkNCgkgICAgcmV0dXJuIGZhbHNlOw0KDQoJICBpZiAoaXNGdW5jdGlvbihoYW5kbGVyKSkgew0KCSAgICBzd2l0Y2ggKGFyZ3VtZW50cy5sZW5ndGgpIHsNCgkgICAgICAvLyBmYXN0IGNhc2VzDQoJICAgICAgY2FzZSAxOg0KCSAgICAgICAgaGFuZGxlci5jYWxsKHRoaXMpOw0KCSAgICAgICAgYnJlYWs7DQoJICAgICAgY2FzZSAyOg0KCSAgICAgICAgaGFuZGxlci5jYWxsKHRoaXMsIGFyZ3VtZW50c1sxXSk7DQoJICAgICAgICBicmVhazsNCgkgICAgICBjYXNlIDM6DQoJICAgICAgICBoYW5kbGVyLmNhbGwodGhpcywgYXJndW1lbnRzWzFdLCBhcmd1bWVudHNbMl0pOw0KCSAgICAgICAgYnJlYWs7DQoJICAgICAgLy8gc2xvd2VyDQoJICAgICAgZGVmYXVsdDoNCgkgICAgICAgIGFyZ3MgPSBBcnJheS5wcm90b3R5cGUuc2xpY2UuY2FsbChhcmd1bWVudHMsIDEpOw0KCSAgICAgICAgaGFuZGxlci5hcHBseSh0aGlzLCBhcmdzKTsNCgkgICAgfQ0KCSAgfSBlbHNlIGlmIChpc09iamVjdChoYW5kbGVyKSkgew0KCSAgICBhcmdzID0gQXJyYXkucHJvdG90eXBlLnNsaWNlLmNhbGwoYXJndW1lbnRzLCAxKTsNCgkgICAgbGlzdGVuZXJzID0gaGFuZGxlci5zbGljZSgpOw0KCSAgICBsZW4gPSBsaXN0ZW5lcnMubGVuZ3RoOw0KCSAgICBmb3IgKGkgPSAwOyBpIDwgbGVuOyBpKyspDQoJICAgICAgbGlzdGVuZXJzW2ldLmFwcGx5KHRoaXMsIGFyZ3MpOw0KCSAgfQ0KDQoJICByZXR1cm4gdHJ1ZTsNCgl9Ow0KDQoJRXZlbnRFbWl0dGVyLnByb3RvdHlwZS5hZGRMaXN0ZW5lciA9IGZ1bmN0aW9uKHR5cGUsIGxpc3RlbmVyKSB7DQoJICB2YXIgbTsNCg0KCSAgaWYgKCFpc0Z1bmN0aW9uKGxpc3RlbmVyKSkNCgkgICAgdGhyb3cgVHlwZUVycm9yKCdsaXN0ZW5lciBtdXN0IGJlIGEgZnVuY3Rpb24nKTsNCg0KCSAgaWYgKCF0aGlzLl9ldmVudHMpDQoJICAgIHRoaXMuX2V2ZW50cyA9IHt9Ow0KDQoJICAvLyBUbyBhdm9pZCByZWN1cnNpb24gaW4gdGhlIGNhc2UgdGhhdCB0eXBlID09PSAibmV3TGlzdGVuZXIiISBCZWZvcmUNCgkgIC8vIGFkZGluZyBpdCB0byB0aGUgbGlzdGVuZXJzLCBmaXJzdCBlbWl0ICJuZXdMaXN0ZW5lciIuDQoJICBpZiAodGhpcy5fZXZlbnRzLm5ld0xpc3RlbmVyKQ0KCSAgICB0aGlzLmVtaXQoJ25ld0xpc3RlbmVyJywgdHlwZSwNCgkgICAgICAgICAgICAgIGlzRnVuY3Rpb24obGlzdGVuZXIubGlzdGVuZXIpID8NCgkgICAgICAgICAgICAgIGxpc3RlbmVyLmxpc3RlbmVyIDogbGlzdGVuZXIpOw0KDQoJICBpZiAoIXRoaXMuX2V2ZW50c1t0eXBlXSkNCgkgICAgLy8gT3B0aW1pemUgdGhlIGNhc2Ugb2Ygb25lIGxpc3RlbmVyLiBEb24ndCBuZWVkIHRoZSBleHRyYSBhcnJheSBvYmplY3QuDQoJICAgIHRoaXMuX2V2ZW50c1t0eXBlXSA9IGxpc3RlbmVyOw0KCSAgZWxzZSBpZiAoaXNPYmplY3QodGhpcy5fZXZlbnRzW3R5cGVdKSkNCgkgICAgLy8gSWYgd2UndmUgYWxyZWFkeSBnb3QgYW4gYXJyYXksIGp1c3QgYXBwZW5kLg0KCSAgICB0aGlzLl9ldmVudHNbdHlwZV0ucHVzaChsaXN0ZW5lcik7DQoJICBlbHNlDQoJICAgIC8vIEFkZGluZyB0aGUgc2Vjb25kIGVsZW1lbnQsIG5lZWQgdG8gY2hhbmdlIHRvIGFycmF5Lg0KCSAgICB0aGlzLl9ldmVudHNbdHlwZV0gPSBbdGhpcy5fZXZlbnRzW3R5cGVdLCBsaXN0ZW5lcl07DQoNCgkgIC8vIENoZWNrIGZvciBsaXN0ZW5lciBsZWFrDQoJICBpZiAoaXNPYmplY3QodGhpcy5fZXZlbnRzW3R5cGVdKSAmJiAhdGhpcy5fZXZlbnRzW3R5cGVdLndhcm5lZCkgew0KCSAgICBpZiAoIWlzVW5kZWZpbmVkKHRoaXMuX21heExpc3RlbmVycykpIHsNCgkgICAgICBtID0gdGhpcy5fbWF4TGlzdGVuZXJzOw0KCSAgICB9IGVsc2Ugew0KCSAgICAgIG0gPSBFdmVudEVtaXR0ZXIuZGVmYXVsdE1heExpc3RlbmVyczsNCgkgICAgfQ0KDQoJICAgIGlmIChtICYmIG0gPiAwICYmIHRoaXMuX2V2ZW50c1t0eXBlXS5sZW5ndGggPiBtKSB7DQoJICAgICAgdGhpcy5fZXZlbnRzW3R5cGVdLndhcm5lZCA9IHRydWU7DQoJICAgICAgY29uc29sZS5lcnJvcignKG5vZGUpIHdhcm5pbmc6IHBvc3NpYmxlIEV2ZW50RW1pdHRlciBtZW1vcnkgJyArDQoJICAgICAgICAgICAgICAgICAgICAnbGVhayBkZXRlY3RlZC4gJWQgbGlzdGVuZXJzIGFkZGVkLiAnICsNCgkgICAgICAgICAgICAgICAgICAgICdVc2UgZW1pdHRlci5zZXRNYXhMaXN0ZW5lcnMoKSB0byBpbmNyZWFzZSBsaW1pdC4nLA0KCSAgICAgICAgICAgICAgICAgICAgdGhpcy5fZXZlbnRzW3R5cGVdLmxlbmd0aCk7DQoJICAgICAgaWYgKHR5cGVvZiBjb25zb2xlLnRyYWNlID09PSAnZnVuY3Rpb24nKSB7DQoJICAgICAgICAvLyBub3Qgc3VwcG9ydGVkIGluIElFIDEwDQoJICAgICAgICBjb25zb2xlLnRyYWNlKCk7DQoJICAgICAgfQ0KCSAgICB9DQoJICB9DQoNCgkgIHJldHVybiB0aGlzOw0KCX07DQoNCglFdmVudEVtaXR0ZXIucHJvdG90eXBlLm9uID0gRXZlbnRFbWl0dGVyLnByb3RvdHlwZS5hZGRMaXN0ZW5lcjsNCg0KCUV2ZW50RW1pdHRlci5wcm90b3R5cGUub25jZSA9IGZ1bmN0aW9uKHR5cGUsIGxpc3RlbmVyKSB7DQoJICBpZiAoIWlzRnVuY3Rpb24obGlzdGVuZXIpKQ0KCSAgICB0aHJvdyBUeXBlRXJyb3IoJ2xpc3RlbmVyIG11c3QgYmUgYSBmdW5jdGlvbicpOw0KDQoJICB2YXIgZmlyZWQgPSBmYWxzZTsNCg0KCSAgZnVuY3Rpb24gZygpIHsNCgkgICAgdGhpcy5yZW1vdmVMaXN0ZW5lcih0eXBlLCBnKTsNCg0KCSAgICBpZiAoIWZpcmVkKSB7DQoJICAgICAgZmlyZWQgPSB0cnVlOw0KCSAgICAgIGxpc3RlbmVyLmFwcGx5KHRoaXMsIGFyZ3VtZW50cyk7DQoJICAgIH0NCgkgIH0NCg0KCSAgZy5saXN0ZW5lciA9IGxpc3RlbmVyOw0KCSAgdGhpcy5vbih0eXBlLCBnKTsNCg0KCSAgcmV0dXJuIHRoaXM7DQoJfTsNCg0KCS8vIGVtaXRzIGEgJ3JlbW92ZUxpc3RlbmVyJyBldmVudCBpZmYgdGhlIGxpc3RlbmVyIHdhcyByZW1vdmVkDQoJRXZlbnRFbWl0dGVyLnByb3RvdHlwZS5yZW1vdmVMaXN0ZW5lciA9IGZ1bmN0aW9uKHR5cGUsIGxpc3RlbmVyKSB7DQoJICB2YXIgbGlzdCwgcG9zaXRpb24sIGxlbmd0aCwgaTsNCg0KCSAgaWYgKCFpc0Z1bmN0aW9uKGxpc3RlbmVyKSkNCgkgICAgdGhyb3cgVHlwZUVycm9yKCdsaXN0ZW5lciBtdXN0IGJlIGEgZnVuY3Rpb24nKTsNCg0KCSAgaWYgKCF0aGlzLl9ldmVudHMgfHwgIXRoaXMuX2V2ZW50c1t0eXBlXSkNCgkgICAgcmV0dXJuIHRoaXM7DQoNCgkgIGxpc3QgPSB0aGlzLl9ldmVudHNbdHlwZV07DQoJICBsZW5ndGggPSBsaXN0Lmxlbmd0aDsNCgkgIHBvc2l0aW9uID0gLTE7DQoNCgkgIGlmIChsaXN0ID09PSBsaXN0ZW5lciB8fA0KCSAgICAgIChpc0Z1bmN0aW9uKGxpc3QubGlzdGVuZXIpICYmIGxpc3QubGlzdGVuZXIgPT09IGxpc3RlbmVyKSkgew0KCSAgICBkZWxldGUgdGhpcy5fZXZlbnRzW3R5cGVdOw0KCSAgICBpZiAodGhpcy5fZXZlbnRzLnJlbW92ZUxpc3RlbmVyKQ0KCSAgICAgIHRoaXMuZW1pdCgncmVtb3ZlTGlzdGVuZXInLCB0eXBlLCBsaXN0ZW5lcik7DQoNCgkgIH0gZWxzZSBpZiAoaXNPYmplY3QobGlzdCkpIHsNCgkgICAgZm9yIChpID0gbGVuZ3RoOyBpLS0gPiAwOykgew0KCSAgICAgIGlmIChsaXN0W2ldID09PSBsaXN0ZW5lciB8fA0KCSAgICAgICAgICAobGlzdFtpXS5saXN0ZW5lciAmJiBsaXN0W2ldLmxpc3RlbmVyID09PSBsaXN0ZW5lcikpIHsNCgkgICAgICAgIHBvc2l0aW9uID0gaTsNCgkgICAgICAgIGJyZWFrOw0KCSAgICAgIH0NCgkgICAgfQ0KDQoJICAgIGlmIChwb3NpdGlvbiA8IDApDQoJICAgICAgcmV0dXJuIHRoaXM7DQoNCgkgICAgaWYgKGxpc3QubGVuZ3RoID09PSAxKSB7DQoJICAgICAgbGlzdC5sZW5ndGggPSAwOw0KCSAgICAgIGRlbGV0ZSB0aGlzLl9ldmVudHNbdHlwZV07DQoJICAgIH0gZWxzZSB7DQoJICAgICAgbGlzdC5zcGxpY2UocG9zaXRpb24sIDEpOw0KCSAgICB9DQoNCgkgICAgaWYgKHRoaXMuX2V2ZW50cy5yZW1vdmVMaXN0ZW5lcikNCgkgICAgICB0aGlzLmVtaXQoJ3JlbW92ZUxpc3RlbmVyJywgdHlwZSwgbGlzdGVuZXIpOw0KCSAgfQ0KDQoJICByZXR1cm4gdGhpczsNCgl9Ow0KDQoJRXZlbnRFbWl0dGVyLnByb3RvdHlwZS5yZW1vdmVBbGxMaXN0ZW5lcnMgPSBmdW5jdGlvbih0eXBlKSB7DQoJICB2YXIga2V5LCBsaXN0ZW5lcnM7DQoNCgkgIGlmICghdGhpcy5fZXZlbnRzKQ0KCSAgICByZXR1cm4gdGhpczsNCg0KCSAgLy8gbm90IGxpc3RlbmluZyBmb3IgcmVtb3ZlTGlzdGVuZXIsIG5vIG5lZWQgdG8gZW1pdA0KCSAgaWYgKCF0aGlzLl9ldmVudHMucmVtb3ZlTGlzdGVuZXIpIHsNCgkgICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDApDQoJICAgICAgdGhpcy5fZXZlbnRzID0ge307DQoJICAgIGVsc2UgaWYgKHRoaXMuX2V2ZW50c1t0eXBlXSkNCgkgICAgICBkZWxldGUgdGhpcy5fZXZlbnRzW3R5cGVdOw0KCSAgICByZXR1cm4gdGhpczsNCgkgIH0NCg0KCSAgLy8gZW1pdCByZW1vdmVMaXN0ZW5lciBmb3IgYWxsIGxpc3RlbmVycyBvbiBhbGwgZXZlbnRzDQoJICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMCkgew0KCSAgICBmb3IgKGtleSBpbiB0aGlzLl9ldmVudHMpIHsNCgkgICAgICBpZiAoa2V5ID09PSAncmVtb3ZlTGlzdGVuZXInKSBjb250aW51ZTsNCgkgICAgICB0aGlzLnJlbW92ZUFsbExpc3RlbmVycyhrZXkpOw0KCSAgICB9DQoJICAgIHRoaXMucmVtb3ZlQWxsTGlzdGVuZXJzKCdyZW1vdmVMaXN0ZW5lcicpOw0KCSAgICB0aGlzLl9ldmVudHMgPSB7fTsNCgkgICAgcmV0dXJuIHRoaXM7DQoJICB9DQoNCgkgIGxpc3RlbmVycyA9IHRoaXMuX2V2ZW50c1t0eXBlXTsNCg0KCSAgaWYgKGlzRnVuY3Rpb24obGlzdGVuZXJzKSkgew0KCSAgICB0aGlzLnJlbW92ZUxpc3RlbmVyKHR5cGUsIGxpc3RlbmVycyk7DQoJICB9IGVsc2UgaWYgKGxpc3RlbmVycykgew0KCSAgICAvLyBMSUZPIG9yZGVyDQoJICAgIHdoaWxlIChsaXN0ZW5lcnMubGVuZ3RoKQ0KCSAgICAgIHRoaXMucmVtb3ZlTGlzdGVuZXIodHlwZSwgbGlzdGVuZXJzW2xpc3RlbmVycy5sZW5ndGggLSAxXSk7DQoJICB9DQoJICBkZWxldGUgdGhpcy5fZXZlbnRzW3R5cGVdOw0KDQoJICByZXR1cm4gdGhpczsNCgl9Ow0KDQoJRXZlbnRFbWl0dGVyLnByb3RvdHlwZS5saXN0ZW5lcnMgPSBmdW5jdGlvbih0eXBlKSB7DQoJICB2YXIgcmV0Ow0KCSAgaWYgKCF0aGlzLl9ldmVudHMgfHwgIXRoaXMuX2V2ZW50c1t0eXBlXSkNCgkgICAgcmV0ID0gW107DQoJICBlbHNlIGlmIChpc0Z1bmN0aW9uKHRoaXMuX2V2ZW50c1t0eXBlXSkpDQoJICAgIHJldCA9IFt0aGlzLl9ldmVudHNbdHlwZV1dOw0KCSAgZWxzZQ0KCSAgICByZXQgPSB0aGlzLl9ldmVudHNbdHlwZV0uc2xpY2UoKTsNCgkgIHJldHVybiByZXQ7DQoJfTsNCg0KCUV2ZW50RW1pdHRlci5wcm90b3R5cGUubGlzdGVuZXJDb3VudCA9IGZ1bmN0aW9uKHR5cGUpIHsNCgkgIGlmICh0aGlzLl9ldmVudHMpIHsNCgkgICAgdmFyIGV2bGlzdGVuZXIgPSB0aGlzLl9ldmVudHNbdHlwZV07DQoNCgkgICAgaWYgKGlzRnVuY3Rpb24oZXZsaXN0ZW5lcikpDQoJICAgICAgcmV0dXJuIDE7DQoJICAgIGVsc2UgaWYgKGV2bGlzdGVuZXIpDQoJICAgICAgcmV0dXJuIGV2bGlzdGVuZXIubGVuZ3RoOw0KCSAgfQ0KCSAgcmV0dXJuIDA7DQoJfTsNCg0KCUV2ZW50RW1pdHRlci5saXN0ZW5lckNvdW50ID0gZnVuY3Rpb24oZW1pdHRlciwgdHlwZSkgew0KCSAgcmV0dXJuIGVtaXR0ZXIubGlzdGVuZXJDb3VudCh0eXBlKTsNCgl9Ow0KDQoJZnVuY3Rpb24gaXNGdW5jdGlvbihhcmcpIHsNCgkgIHJldHVybiB0eXBlb2YgYXJnID09PSAnZnVuY3Rpb24nOw0KCX0NCg0KCWZ1bmN0aW9uIGlzTnVtYmVyKGFyZykgew0KCSAgcmV0dXJuIHR5cGVvZiBhcmcgPT09ICdudW1iZXInOw0KCX0NCg0KCWZ1bmN0aW9uIGlzT2JqZWN0KGFyZykgew0KCSAgcmV0dXJuIHR5cGVvZiBhcmcgPT09ICdvYmplY3QnICYmIGFyZyAhPT0gbnVsbDsNCgl9DQoNCglmdW5jdGlvbiBpc1VuZGVmaW5lZChhcmcpIHsNCgkgIHJldHVybiBhcmcgPT09IHZvaWQgMDsNCgl9DQoNCg0KLyoqKi8gfQ0KLyoqKioqKi8gXSkNCn0pOw0KOw==';
export default iframeBridge;
